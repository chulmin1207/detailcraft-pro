<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DetailCraft Pro ‚Äî ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Í∏∞Ìöç + AI Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Cormorant+Garamond:wght@500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ===== THEME VARIABLES ===== */
        :root {
            /* Dark Mode (Default) */
            --bg-primary: #09090b;
            --bg-secondary: #0c0c0f;
            --bg-tertiary: #111114;
            --bg-elevated: #18181b;
            --bg-hover: #1f1f23;
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-default: rgba(255, 255, 255, 0.1);
            --border-strong: rgba(255, 255, 255, 0.15);
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-tertiary: #71717a;
            --text-quaternary: #52525b;
            --accent-primary: #6366f1;
            --accent-primary-hover: #818cf8;
            --accent-secondary: #ec4899;
            --accent-tertiary: #14b8a6;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --accent-gemini: #8b5cf6;
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
            --gradient-gemini: linear-gradient(135deg, #8b5cf6 0%, #ec4899 50%, #f59e0b 100%);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 60px rgba(99, 102, 241, 0.3);
            --shadow-gemini: 0 0 60px rgba(139, 92, 246, 0.3);
            --font-display: 'Cormorant Garamond', serif;
            --font-sans: 'Outfit', -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --header-bg: rgba(9, 9, 11, 0.9);
            --bg-effect-1: rgba(99, 102, 241, 0.08);
            --bg-effect-2: rgba(236, 72, 153, 0.06);
        }
        
        /* Light Mode */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-elevated: #ffffff;
            --bg-hover: #e2e8f0;
            --border-subtle: rgba(0, 0, 0, 0.06);
            --border-default: rgba(0, 0, 0, 0.1);
            --border-strong: rgba(0, 0, 0, 0.15);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --text-quaternary: #94a3b8;
            --accent-primary: #4f46e5;
            --accent-primary-hover: #6366f1;
            --accent-secondary: #db2777;
            --accent-tertiary: #0d9488;
            --accent-success: #059669;
            --accent-danger: #dc2626;
            --accent-warning: #d97706;
            --accent-gemini: #7c3aed;
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.1);
            --shadow-glow: 0 0 60px rgba(79, 70, 229, 0.15);
            --shadow-gemini: 0 0 60px rgba(124, 58, 237, 0.15);
            --header-bg: rgba(255, 255, 255, 0.9);
            --bg-effect-1: rgba(79, 70, 229, 0.05);
            --bg-effect-2: rgba(219, 39, 119, 0.03);
        }
        
        /* ===== UPLOAD ZONE FOCUS ANIMATION ===== */
        @keyframes borderRotate {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        
        @keyframes borderPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .upload-zone.focused {
            position: relative;
            border: 3px dashed transparent;
            background: 
                linear-gradient(var(--bg-tertiary), var(--bg-tertiary)) padding-box,
                linear-gradient(90deg, var(--accent-primary), var(--accent-gemini), var(--accent-secondary), var(--accent-primary)) border-box;
            background-size: 100% 100%, 200% 100%;
            animation: borderRotate 2s linear infinite;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
        }
        
        .upload-zone.focused::after {
            content: 'üìã Ctrl+V Î∂ôÏó¨ÎÑ£Í∏∞ | ÌÅ¥Î¶≠ÌïòÎ©¥ ÌååÏùº ÏÑ†ÌÉù';
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 14px;
            background: var(--accent-primary);
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: var(--radius-full);
            white-space: nowrap;
            animation: borderPulse 1.5s ease-in-out infinite;
        }
        
        /* ===== THEME TOGGLE BUTTON ===== */
        .theme-toggle {
            padding: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        .theme-toggle:hover {
            background: var(--bg-hover);
            border-color: var(--border-strong);
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; scroll-behavior: smooth; -webkit-font-smoothing: antialiased; }
        body { font-family: var(--font-sans); background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; min-height: 100vh; }
        ::selection { background: var(--accent-primary); color: white; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: var(--radius-full); }

        .bg-effects { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
        .bg-effects::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(ellipse 800px 600px at 20% 20%, var(--bg-effect-1) 0%, transparent 50%), radial-gradient(ellipse 600px 400px at 80% 30%, var(--bg-effect-2) 0%, transparent 50%); }

        /* Header */
        .header { padding: 20px 32px; border-bottom: 1px solid var(--border-subtle); background: var(--header-bg); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-mark { width: 40px; height: 40px; background: var(--gradient-primary); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.25rem; box-shadow: var(--shadow-glow); }
        .logo-title { font-family: var(--font-display); font-size: 1.5rem; font-weight: 600; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-version { font-size: 0.7rem; background: var(--gradient-gemini); padding: 2px 8px; border-radius: var(--radius-full); color: white; margin-left: 8px; }

        /* API Section */
        .api-section { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .api-status { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-full); font-size: 0.8rem; }
        .api-status.connected { border-color: var(--accent-success); }
        .api-status.disconnected { border-color: var(--accent-danger); }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; }
        .connected .status-dot { background: var(--accent-success); box-shadow: 0 0 8px var(--accent-success); }
        .disconnected .status-dot { background: var(--accent-danger); }
        .api-btn { padding: 6px 12px; background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: var(--radius-md); color: var(--text-primary); font-family: inherit; font-size: 0.8rem; cursor: pointer; transition: all var(--transition-fast); }
        .api-btn:hover { background: var(--bg-hover); border-color: var(--border-strong); }

        /* Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-xl); width: 100%; max-width: 560px; margin: 20px; overflow: hidden; animation: modalIn 0.3s ease; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.125rem; font-weight: 600; }
        .modal-close { width: 32px; height: 32px; background: var(--bg-tertiary); border: none; border-radius: var(--radius-md); color: var(--text-secondary); font-size: 1.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: var(--bg-hover); color: var(--text-primary); }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 20px 24px; border-top: 1px solid var(--border-subtle); display: flex; gap: 12px; justify-content: flex-end; }

        .api-input-group { margin-bottom: 20px; }
        .api-input-label { display: flex; align-items: center; gap: 8px; font-size: 0.875rem; font-weight: 500; margin-bottom: 8px; }
        .api-badge { padding: 2px 8px; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 600; }
        .api-badge.claude { background: rgba(99, 102, 241, 0.2); color: var(--accent-primary-hover); }
        .api-badge.gemini { background: rgba(139, 92, 246, 0.2); color: var(--accent-gemini); }
        .api-input-wrapper { position: relative; }
        .api-input { width: 100%; padding: 12px 44px 12px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); font-family: var(--font-mono); font-size: 0.8rem; }
        .api-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15); }
        .api-input-toggle { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-tertiary); cursor: pointer; font-size: 1rem; }
        .api-helper { font-size: 0.75rem; color: var(--text-tertiary); margin-top: 6px; line-height: 1.5; }
        .api-helper a { color: var(--accent-primary-hover); text-decoration: none; }

        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; font-family: inherit; font-size: 0.875rem; font-weight: 500; border-radius: var(--radius-md); border: none; cursor: pointer; transition: all var(--transition-fast); }
        .btn-secondary { background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border-default); }
        .btn-secondary:hover { background: var(--bg-hover); border-color: var(--border-strong); }
        .btn-primary { background: var(--accent-primary); color: white; }
        .btn-primary:hover { background: var(--accent-primary-hover); }
        .btn-gemini { background: var(--gradient-gemini); color: white; }
        .btn-danger { background: var(--accent-danger); color: white; }

        /* Container */
        .container { position: relative; z-index: 2; max-width: 1100px; margin: 0 auto; padding: 40px 24px; }

        /* Steps Navigation */
        .steps-nav { display: flex; justify-content: center; gap: 8px; margin-bottom: 40px; }
        .step-indicator { display: flex; align-items: center; gap: 12px; padding: 12px 24px; background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-full); cursor: pointer; transition: all var(--transition-base); }
        .step-indicator:hover { border-color: var(--border-default); }
        .step-indicator.active { border-color: var(--accent-primary); background: rgba(99, 102, 241, 0.1); }
        .step-indicator.completed { border-color: var(--accent-success); }
        .step-number { width: 28px; height: 28px; border-radius: 50%; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; }
        .step-indicator.active .step-number { background: var(--accent-primary); }
        .step-indicator.completed .step-number { background: var(--accent-success); }
        .step-label { font-size: 0.875rem; font-weight: 500; }
        .step-connector { width: 40px; height: 2px; background: var(--border-subtle); align-self: center; }
        .step-connector.completed { background: var(--accent-success); }

        /* Step Sections */
        .step-section { display: none; animation: fadeIn 0.4s ease; }
        .step-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Form Card */
        .form-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-xl); overflow: hidden; margin-bottom: 24px; }
        .form-card-header { padding: 18px 24px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; }
        .form-card-title { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .form-card-badge { padding: 4px 10px; background: rgba(99, 102, 241, 0.1); color: var(--accent-primary-hover); border-radius: var(--radius-full); font-size: 0.7rem; }
        .form-card-body { padding: 24px; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 18px; }
        .form-grid .full-width { grid-column: 1 / -1; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-label { font-size: 0.8rem; font-weight: 500; display: flex; align-items: center; gap: 6px; }
        .form-required { color: var(--accent-secondary); font-size: 0.7rem; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 10px 14px; background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); font-family: inherit; font-size: 0.875rem; transition: all var(--transition-fast); }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15); }
        .form-input::placeholder, .form-textarea::placeholder { color: var(--text-quaternary); }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 40px; }

        /* Image Upload */
        .upload-zone { border: 2px dashed var(--border-default); border-radius: var(--radius-lg); padding: 32px; text-align: center; cursor: pointer; transition: all var(--transition-base); background: var(--bg-tertiary); }
        .upload-zone:hover { border-color: var(--accent-primary); background: rgba(99, 102, 241, 0.05); }
        .upload-zone.dragover { border-color: var(--accent-primary); background: rgba(99, 102, 241, 0.1); }
        .upload-zone.has-image { border-style: solid; border-color: var(--accent-success); }
        .upload-icon { font-size: 2.5rem; margin-bottom: 12px; }
        .upload-text { color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 8px; }
        .upload-hint { color: var(--text-tertiary); font-size: 0.75rem; }
        .upload-preview { max-width: 100%; max-height: 200px; border-radius: var(--radius-md); margin-top: 12px; }
        .upload-actions { margin-top: 12px; display: flex; gap: 8px; justify-content: center; }
        .preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
        .preview-item { position: relative; display: inline-block; }
        .preview-item img { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid var(--accent-success); }
        .preview-item .remove-btn { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; border-radius: 50%; background: var(--accent-danger); border: none; color: white; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        .preview-item .remove-btn:hover { background: #dc2626; }
        .multi-upload { min-height: 120px; }

        /* Generate Button */
        .generate-wrapper { text-align: center; margin-top: 24px; }
        .generate-hint { font-size: 0.8rem; color: var(--text-tertiary); margin-top: 12px; }
        
        /* Î™®Îç∏ ÏÑ†ÌÉù UI */
        .model-selector { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px; text-align: left; }
        .model-selector-label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 12px; color: var(--text-primary); }
        .model-options { display: flex; gap: 12px; flex-wrap: wrap; }
        .model-option { flex: 1; min-width: 200px; cursor: pointer; }
        .model-option input { display: none; }
        .model-option-content { padding: 16px; background: var(--bg-primary); border: 2px solid var(--border-subtle); border-radius: var(--radius-md); transition: all var(--transition-fast); }
        .model-option input:checked + .model-option-content { border-color: var(--accent-gemini); background: rgba(139, 92, 246, 0.1); }
        .model-option:hover .model-option-content { border-color: var(--border-strong); }
        .model-option-name { display: block; font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; }
        .model-option-desc { display: block; font-size: 0.75rem; color: var(--text-tertiary); }
        .model-warning { font-size: 0.75rem; color: var(--accent-warning); margin-top: 12px; padding: 8px 12px; background: rgba(245, 158, 11, 0.1); border-radius: var(--radius-sm); }
        
        /* ÎπÑÏú® ÏÑ†ÌÉù */
        .aspect-ratio-selector { margin: 16px 0; }
        .aspect-ratio-selector .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; }
        .aspect-ratio-options { display: flex; gap: 6px; }
        .aspect-option { cursor: pointer; flex: 1; }
        .aspect-option input { display: none; }
        .aspect-option-content { padding: 8px 4px; background: var(--bg-primary); border: 2px solid var(--border-subtle); border-radius: var(--radius-md); text-align: center; transition: all var(--transition-fast); }
        .aspect-option input:checked + .aspect-option-content { border-color: var(--accent-gemini); background: rgba(139, 92, 246, 0.1); }
        .aspect-option:hover .aspect-option-content { border-color: var(--border-strong); }
        .aspect-label { display: block; font-weight: 700; font-size: 0.8rem; }
        .aspect-desc { display: block; font-size: 0.6rem; color: var(--text-tertiary); }
        
        /* ÏÑπÏÖòÎ≥Ñ ÏÉùÏÑ± Ìå®ÎÑê */
        .section-generate-panel { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle); }
        .section-model-select { display: flex; gap: 8px; margin-bottom: 12px; }
        .section-model-option { flex: 1; cursor: pointer; }
        .section-model-option input { display: none; }
        .section-model-btn { display: block; padding: 10px 12px; background: var(--bg-primary); border: 2px solid var(--border-subtle); border-radius: var(--radius-md); font-size: 0.8rem; text-align: center; transition: all var(--transition-fast); }
        .section-model-option input:checked + .section-model-btn { border-color: var(--accent-gemini); background: rgba(139, 92, 246, 0.15); color: var(--accent-gemini); font-weight: 600; }
        .section-model-option:hover .section-model-btn { border-color: var(--border-strong); }
        .section-generate-btn { width: 100%; padding: 12px; font-size: 0.9rem; }
        .section-card.has-image { border-color: var(--accent-success); }
        .section-done-badge { background: var(--accent-success); color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: var(--radius-full); margin-left: 8px; }
        .section-image-preview { margin-bottom: 16px; border-radius: var(--radius-md); overflow: hidden; border: 2px solid var(--accent-success); }
        .section-image-preview img { width: 100%; max-height: 300px; object-fit: contain; display: block; background: var(--bg-primary); }
        .spinner-small { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 6px; vertical-align: middle; }
        
        /* ÏÉùÏÑ± ÌòÑÌô© Î∞ïÏä§ */
        .generation-progress-box { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px; text-align: center; }
        .generation-progress-info { display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 8px; }
        .generation-progress-label { font-size: 0.9rem; color: var(--text-secondary); }
        .generation-progress-text { font-size: 1.25rem; font-weight: 700; color: var(--accent-gemini); }
        .generation-progress-hint { font-size: 0.8rem; color: var(--text-tertiary); }
        
        /* Ï†ÑÏ≤¥ ÏÉùÏÑ± Ï†ëÍ∏∞ */
        .batch-generate-section { margin-bottom: 20px; }
        .batch-generate-details { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); }
        .batch-generate-summary { padding: 16px 20px; cursor: pointer; font-size: 0.9rem; color: var(--text-secondary); list-style: none; }
        .batch-generate-summary::-webkit-details-marker { display: none; }
        .batch-generate-summary:hover { color: var(--text-primary); }
        .batch-generate-content { padding: 0 20px 20px; }
        .batch-warning { font-size: 0.8rem; color: var(--accent-warning); margin-bottom: 16px; padding: 10px; background: rgba(245, 158, 11, 0.1); border-radius: var(--radius-sm); }
        .model-selector.compact { margin-bottom: 16px; }
        .model-selector.compact .model-options { justify-content: center; }
        .btn-lg { padding: 16px 32px; font-size: 1rem; }
        
        /* STEP 3 ÏßÑÌñâ ÏÉÅÌô© UI */
        .step3-progress-section { background: var(--bg-tertiary); border: 1px solid var(--accent-gemini); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 24px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .step3-progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .step3-progress-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
        .step3-progress-percent { font-size: 1.1rem; font-weight: 700; color: var(--accent-gemini); }
        .step3-progress-bar { height: 8px; background: var(--bg-primary); border-radius: var(--radius-full); overflow: hidden; margin-bottom: 16px; }
        .step3-progress-fill { height: 100%; background: var(--gradient-gemini); border-radius: var(--radius-full); transition: width 0.3s ease; }
        .step3-progress-sections { display: flex; flex-wrap: wrap; gap: 8px; }
        .step3-section-status { display: flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: var(--radius-md); font-size: 0.8rem; font-weight: 500; border: 1px solid var(--border-subtle); background: var(--bg-primary); color: var(--text-tertiary); transition: all 0.3s ease; }
        .step3-section-num { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; background: var(--bg-tertiary); border-radius: 50%; font-size: 0.7rem; font-weight: 600; }
        .step3-section-name { color: var(--text-secondary); max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .step3-section-state { font-size: 0.7rem; padding: 2px 8px; border-radius: var(--radius-full); background: var(--bg-tertiary); }
        .step3-section-state.pending { color: var(--text-tertiary); }
        .step3-section-state.generating { background: rgba(139, 92, 246, 0.3); color: var(--accent-gemini); animation: pulse 1.5s infinite; }
        .step3-section-state.done { background: rgba(16, 185, 129, 0.3); color: var(--accent-success); }
        .step3-section-state.error { background: rgba(239, 68, 68, 0.3); color: var(--accent-danger); }
        .generate-btn { display: inline-flex; align-items: center; gap: 12px; padding: 16px 48px; background: var(--gradient-primary); border: none; border-radius: var(--radius-lg); color: white; font-family: inherit; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all var(--transition-base); box-shadow: 0 0 40px rgba(99, 102, 241, 0.4); }
        .generate-btn.gemini { background: var(--gradient-gemini); box-shadow: var(--shadow-gemini); }
        .generate-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 0 60px rgba(99, 102, 241, 0.5); }
        .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .generate-btn .spinner { display: none; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        .generate-btn.loading .spinner { display: block; }
        .generate-btn.loading .btn-text { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Progress */
        .progress-section { display: none; margin-top: 24px; padding: 24px; background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-xl); }
        .progress-section.active { display: block; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .progress-title { font-weight: 500; font-size: 0.9rem; }
        .progress-percent { color: var(--accent-primary-hover); font-weight: 600; }
        .progress-bar { height: 6px; background: var(--bg-tertiary); border-radius: var(--radius-full); overflow: hidden; }
        .progress-fill { height: 100%; background: var(--gradient-primary); width: 0%; transition: width 0.5s ease; }
        .progress-fill.gemini { background: var(--gradient-gemini); }
        .progress-log { margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-md); max-height: 150px; overflow-y: auto; font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-secondary); }
        .log-item { padding: 4px 0; border-bottom: 1px solid var(--border-subtle); }
        .log-item:last-child { border-bottom: none; }
        .log-success { color: var(--accent-success); }
        .log-error { color: var(--accent-danger); }
        .log-info { color: var(--accent-primary-hover); }

        /* Sections Editor */
        .sections-container { display: flex; flex-direction: column; gap: 16px; }
        .section-card { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); overflow: hidden; }
        .section-header { padding: 14px 18px; background: var(--bg-elevated); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .section-header:hover { background: var(--bg-hover); }
        .section-title { font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; }
        .section-number { width: 24px; height: 24px; background: var(--accent-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; }
        .section-toggle { font-size: 1.25rem; color: var(--text-tertiary); transition: transform var(--transition-fast); }
        .section-card.expanded .section-toggle { transform: rotate(180deg); }
        .section-body { display: none; padding: 18px; border-top: 1px solid var(--border-subtle); }
        .section-card.expanded .section-body { display: block; }
        .section-content { margin-bottom: 16px; }
        .section-content h4 { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px; }
        .section-content p { font-size: 0.875rem; line-height: 1.7; }
        .section-upload { margin-top: 16px; }
        .section-upload-zone { border: 2px dashed var(--border-default); border-radius: var(--radius-md); padding: 20px; text-align: center; cursor: pointer; transition: all var(--transition-base); min-height: 80px; }
        .section-upload-zone:hover { border-color: var(--accent-gemini); background: rgba(139, 92, 246, 0.05); }
        .section-upload-zone.dragover { border-color: var(--accent-gemini); background: rgba(139, 92, 246, 0.1); }
        .section-upload-zone.has-images { border-style: solid; border-color: var(--accent-success); padding: 10px; }
        .section-preview { max-width: 100%; max-height: 150px; border-radius: var(--radius-sm); }
        .section-preview-container { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
        .section-preview-item { position: relative; }
        .section-preview-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 2px solid var(--accent-success); }
        .section-preview-item .remove-btn { position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; border-radius: 50%; background: var(--accent-danger); border: none; color: white; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; }
        .section-headline-input, .section-subcopy-input { margin-bottom: 8px; }
        .section-visual-input { min-height: 80px; font-size: 0.85rem; }

        /* Generated Images */
        .images-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .image-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); overflow: hidden; }
        .image-card-header { padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; }
        .image-card-title { font-size: 0.85rem; font-weight: 600; }
        .image-card-status { font-size: 0.7rem; padding: 4px 8px; border-radius: var(--radius-full); }
        .image-card-status.pending { background: rgba(245, 158, 11, 0.2); color: var(--accent-warning); }
        .image-card-status.generating { background: rgba(139, 92, 246, 0.2); color: var(--accent-gemini); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .image-card-status.complete { background: rgba(16, 185, 129, 0.2); color: var(--accent-success); }
        .image-card-status.error { background: rgba(239, 68, 68, 0.2); color: var(--accent-danger); }
        
        /* Ïû¨ÏÉùÏÑ± ÏòµÏÖò Ìå®ÎÑê */
        .image-card-regen-panel { border-top: 1px solid var(--border-subtle); }
        .regen-toggle { padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 0.8rem; color: var(--text-secondary); transition: all var(--transition-fast); }
        .regen-toggle:hover { background: var(--bg-hover); color: var(--text-primary); }
        .regen-toggle-icon { transition: transform var(--transition-fast); }
        .regen-panel-content { padding: 16px; background: var(--bg-tertiary); border-top: 1px solid var(--border-subtle); }
        .regen-ref-section, .regen-prompt-section { margin-bottom: 12px; }
        .regen-label { display: block; font-size: 0.75rem; font-weight: 500; margin-bottom: 6px; color: var(--text-secondary); }
        .regen-upload-zone { border: 2px dashed var(--border-default); border-radius: var(--radius-md); padding: 12px; text-align: center; cursor: pointer; font-size: 0.75rem; color: var(--text-tertiary); transition: all var(--transition-fast); position: relative; }
        .regen-upload-zone:hover { border-color: var(--accent-gemini); color: var(--text-secondary); }
        .regen-upload-zone.focused { border: 3px dashed transparent; background: linear-gradient(var(--bg-tertiary), var(--bg-tertiary)) padding-box, linear-gradient(90deg, var(--accent-primary), var(--accent-gemini), var(--accent-secondary), var(--accent-primary)) border-box; background-size: 100% 100%, 200% 100%; animation: borderRotate 2s linear infinite; box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
        .regen-upload-zone.focused::after { content: 'üìã Ctrl+V Î∂ôÏó¨ÎÑ£Í∏∞ | ÌÅ¥Î¶≠ÌïòÎ©¥ ÌååÏùº ÏÑ†ÌÉù'; position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%); padding: 4px 10px; background: var(--accent-gemini); color: white; font-size: 0.65rem; font-weight: 500; border-radius: var(--radius-full); white-space: nowrap; animation: borderPulse 1.5s ease-in-out infinite; }
        .regen-preview-container { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
        .regen-preview-item { position: relative; }
        .regen-preview-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid var(--accent-success); }
        .regen-preview-item .remove-btn { position: absolute; top: -4px; right: -4px; width: 16px; height: 16px; border-radius: 50%; background: var(--accent-danger); border: none; color: white; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; line-height: 1; }
        .regen-prompt-input { width: 100%; padding: 8px 10px; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); font-family: inherit; font-size: 0.8rem; min-height: 60px; resize: vertical; }
        .regen-prompt-input:focus { outline: none; border-color: var(--accent-gemini); }
        .regen-generate-btn { width: 100%; margin-top: 8px; padding: 10px; font-size: 0.85rem; }
        
        /* STEP 3 Î™®Îç∏ ÏÑ†ÌÉù */
        .regen-model-section { margin-bottom: 12px; }
        .regen-model-options { display: flex; gap: 8px; }
        .regen-model-option { flex: 1; cursor: pointer; }
        .regen-model-option input { display: none; }
        .regen-model-btn { display: block; padding: 8px 10px; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); font-size: 0.7rem; text-align: center; transition: all var(--transition-fast); }
        .regen-model-option input:checked + .regen-model-btn { border-color: var(--accent-gemini); background: rgba(139, 92, 246, 0.15); color: var(--accent-gemini); font-weight: 600; }
        .regen-model-option:hover .regen-model-btn { border-color: var(--border-strong); }
        
        /* STEP 3 Ìè¨Ìï® ÏöîÏÜå Ï≤¥ÌÅ¨Î∞ïÏä§ */
        .regen-include-section { margin-bottom: 12px; }
        .regen-include-options { display: flex; flex-direction: column; gap: 6px; }
        .regen-include-option { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); cursor: pointer; transition: all var(--transition-fast); }
        .regen-include-option:hover { border-color: var(--border-strong); }
        .regen-include-option input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--accent-gemini); cursor: pointer; }
        .regen-include-option input[type="checkbox"]:disabled { opacity: 0.5; cursor: not-allowed; }
        .regen-include-text { font-size: 0.8rem; color: var(--text-secondary); }
        .regen-include-option:has(input:checked) { border-color: var(--accent-gemini); background: rgba(139, 92, 246, 0.1); }
        .regen-include-option:has(input:checked) .regen-include-text { color: var(--text-primary); font-weight: 500; }
        .regen-include-option:has(input:disabled) { opacity: 0.5; cursor: not-allowed; }
        .regen-include-option.disabled-option { opacity: 0.5; cursor: not-allowed; }
        .regen-include-option.disabled-option:hover { border-color: var(--border-subtle); }
        
        /* Î†àÌçºÎü∞Ïä§ Î∞òÏòÅ Í∞ïÎèÑ ÏÑ†ÌÉù */
        .ref-strength-section { margin-top: 12px; }
        .ref-strength-options { display: flex; gap: 12px; margin-top: 8px; }
        .ref-strength-option { flex: 1; display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast); }
        .ref-strength-option:hover { border-color: var(--border-strong); }
        .ref-strength-option input[type="radio"] { width: 18px; height: 18px; accent-color: var(--accent-gemini); cursor: pointer; }
        .ref-strength-label { display: flex; flex-direction: column; gap: 2px; }
        .ref-strength-label strong { font-size: 0.9rem; color: var(--text-primary); }
        .ref-strength-label small { font-size: 0.75rem; color: var(--text-tertiary); }
        .ref-strength-option:has(input:checked) { border-color: var(--accent-gemini); background: rgba(139, 92, 246, 0.1); }
        .ref-strength-option:has(input:checked) .ref-strength-label strong { color: var(--accent-gemini); }
        
        .image-card-body { padding: 16px; min-height: 200px; display: flex; align-items: center; justify-content: center; background: var(--bg-tertiary); }
        .image-card-body img { max-width: 100%; max-height: 250px; border-radius: var(--radius-sm); }
        .image-placeholder { text-align: center; color: var(--text-tertiary); }
        .image-placeholder-icon { font-size: 2rem; margin-bottom: 8px; }
        .image-card-footer { padding: 12px 16px; border-top: 1px solid var(--border-subtle); display: flex; gap: 8px; }
        .image-card-footer .btn { flex: 1; padding: 8px; font-size: 0.8rem; }

        /* Output Section */
        .output-section { display: none; margin-top: 32px; }
        .output-section.active { display: block; }
        .output-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px; }
        .output-title { font-family: var(--font-display); font-size: 1.5rem; font-weight: 600; display: flex; align-items: center; gap: 12px; }
        .output-badge { padding: 4px 12px; background: rgba(16, 185, 129, 0.1); color: var(--accent-success); border-radius: var(--radius-full); font-size: 0.75rem; }
        .output-actions { display: flex; gap: 8px; flex-wrap: wrap; }

        /* Download All */
        .download-all-section { margin-top: 32px; padding: 24px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: var(--radius-xl); text-align: center; }
        .download-all-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 8px; }
        .download-all-desc { color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 16px; }
        .platform-info { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .platform-badge { padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-full); font-size: 0.75rem; color: var(--text-secondary); }
        .download-hint { margin-top: 12px; font-size: 0.75rem; color: var(--text-tertiary); }
        
        /* ===== AI COPY SUGGESTION ===== */
        .copy-input-wrapper { display: flex; gap: 8px; align-items: center; }
        .copy-input-wrapper .form-input { flex: 1; }
        .copy-suggest-btn { padding: 10px 14px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-gemini)); border: none; border-radius: var(--radius-md); color: white; font-size: 1rem; cursor: pointer; transition: all var(--transition-fast); flex-shrink: 0; }
        .copy-suggest-btn:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .copy-suggest-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        /* Copy Suggestions Dropdown */
        .copy-suggestions-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 1001; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s ease; }
        .copy-suggestions-box { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-xl); width: 100%; max-width: 500px; margin: 20px; overflow: hidden; animation: modalIn 0.3s ease; }
        .copy-suggestions-header { padding: 16px 20px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; }
        .copy-suggestions-title { font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .copy-suggestions-close { background: none; border: none; color: var(--text-tertiary); font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1; }
        .copy-suggestions-close:hover { color: var(--text-primary); }
        .copy-suggestions-list { padding: 12px; max-height: 400px; overflow-y: auto; }
        .copy-suggestion-item { padding: 14px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); margin-bottom: 8px; cursor: pointer; transition: all var(--transition-fast); }
        .copy-suggestion-item:hover { border-color: var(--accent-primary); background: rgba(99, 102, 241, 0.1); }
        .copy-suggestion-item:last-child { margin-bottom: 0; }
        .copy-suggestion-text { font-size: 0.95rem; line-height: 1.5; }
        .copy-suggestions-loading { padding: 40px; text-align: center; color: var(--text-tertiary); }
        .copy-suggestions-empty { padding: 30px; text-align: center; color: var(--text-secondary); }
        .copy-suggestions-footer { padding: 16px 20px; border-top: 1px solid var(--border-subtle); background: var(--bg-tertiary); text-align: center; }
        .copy-suggestions-hint { font-size: 0.8rem; color: var(--text-tertiary); margin-bottom: 10px; }
        .copy-regenerate-btn { padding: 10px 20px; background: linear-gradient(135deg, var(--accent-warning), var(--accent-secondary)); border: none; border-radius: var(--radius-md); color: white; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all var(--transition-fast); }
        .copy-regenerate-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
        
        /* ===== CHECKLIST SECTION ===== */
        .checklist-section { margin-top: 32px; background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-xl); overflow: hidden; }
        .checklist-header { padding: 24px; border-bottom: 1px solid var(--border-subtle); text-align: center; background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05)); }
        .checklist-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 6px; }
        .checklist-desc { font-size: 0.875rem; color: var(--text-secondary); }
        .checklist-body { padding: 24px; }
        
        /* Competitor Section */
        .competitor-section { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px; }
        .competitor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .competitor-label { font-weight: 600; font-size: 0.95rem; }
        .competitor-optional { font-size: 0.75rem; color: var(--text-tertiary); padding: 4px 10px; background: var(--bg-primary); border-radius: var(--radius-full); }
        
        /* Tabs */
        .competitor-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .competitor-tab { flex: 1; padding: 10px 16px; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-secondary); font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all var(--transition-fast); }
        .competitor-tab:hover { border-color: var(--border-strong); color: var(--text-primary); }
        .competitor-tab.active { background: var(--accent-primary); border-color: var(--accent-primary); color: white; }
        
        /* Tab Content */
        .competitor-tab-content { display: none; }
        .competitor-tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        
        /* URL Input */
        .competitor-url-input { width: 100%; padding: 12px 16px; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); font-size: 0.875rem; transition: all var(--transition-fast); }
        .competitor-url-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15); }
        .competitor-url-input::placeholder { color: var(--text-quaternary); }
        .competitor-hint { font-size: 0.75rem; color: var(--text-tertiary); margin-top: 8px; }
        
        /* URL Fallback */
        .competitor-url-fallback { margin-top: 16px; padding: 16px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: var(--radius-md); animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .fallback-message { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; color: var(--accent-warning); font-size: 0.875rem; }
        .fallback-icon { font-size: 1.1rem; }
        .fallback-btn { width: 100%; padding: 10px 16px; background: var(--accent-warning); border: none; border-radius: var(--radius-md); color: white; font-weight: 500; cursor: pointer; transition: all var(--transition-fast); }
        .fallback-btn:hover { filter: brightness(1.1); }
        
        /* Image Zone */
        .competitor-image-zone { border: 2px dashed var(--border-default); border-radius: var(--radius-lg); min-height: 160px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all var(--transition-base); position: relative; overflow: hidden; }
        .competitor-image-zone:hover { border-color: var(--accent-primary); background: rgba(99, 102, 241, 0.05); }
        .competitor-image-zone.focused { border: 3px dashed transparent; background: linear-gradient(var(--bg-tertiary), var(--bg-tertiary)) padding-box, linear-gradient(90deg, var(--accent-primary), var(--accent-gemini), var(--accent-secondary), var(--accent-primary)) border-box; background-size: 100% 100%, 200% 100%; animation: borderRotate 2s linear infinite; }
        .competitor-image-placeholder { text-align: center; padding: 20px; }
        .competitor-image-icon { font-size: 2.5rem; margin-bottom: 8px; display: block; }
        .competitor-image-text { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 4px; }
        .competitor-image-hint { font-size: 0.8rem; color: var(--text-tertiary); }
        .competitor-image-shortcut { font-size: 0.75rem; color: var(--text-quaternary); margin-top: 8px; }
        .competitor-image-preview { width: 100%; }
        .competitor-image-preview img { width: 100%; max-height: 300px; object-fit: contain; }
        .competitor-image-remove { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; background: var(--accent-danger); border: none; border-radius: 50%; color: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
        .competitor-image-remove:hover { filter: brightness(1.2); }
        
        /* Action */
        .checklist-action { text-align: center; padding-top: 8px; }
        .checklist-action-hint { font-size: 0.8rem; color: var(--text-tertiary); margin-top: 12px; }
        
        /* Result */
        .checklist-result { padding: 24px; border-top: 1px solid var(--border-subtle); animation: fadeIn 0.3s ease; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .result-title { font-size: 1.1rem; font-weight: 600; }
        .result-score { display: flex; align-items: center; gap: 12px; }
        .result-score-bar { width: 120px; height: 8px; background: var(--bg-primary); border-radius: var(--radius-full); overflow: hidden; }
        .result-score-fill { height: 100%; border-radius: var(--radius-full); transition: width 0.5s ease; }
        .result-score-fill.good { background: var(--accent-success); }
        .result-score-fill.medium { background: var(--accent-warning); }
        .result-score-fill.bad { background: var(--accent-danger); }
        .result-score-text { font-weight: 700; font-size: 1rem; }
        
        .result-category { margin-bottom: 20px; }
        .result-category-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle); }
        .result-category-icon { font-size: 1.1rem; }
        .result-category-title { font-weight: 600; font-size: 0.95rem; }
        .result-category-score { margin-left: auto; font-size: 0.8rem; color: var(--text-tertiary); }
        
        .result-item { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; }
        .result-item-status { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; flex-shrink: 0; }
        .result-item-content { flex: 1; }
        .result-item-label { font-size: 0.875rem; color: var(--text-primary); }
        .result-item-detail { font-size: 0.75rem; color: var(--text-tertiary); margin-top: 2px; }
        
        .result-suggestions { background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: var(--radius-lg); padding: 16px; margin-top: 20px; }
        .result-suggestions-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .result-suggestion-item { display: flex; align-items: flex-start; gap: 8px; padding: 8px 0; font-size: 0.85rem; color: var(--text-secondary); }
        .result-suggestion-item::before { content: 'üí°'; flex-shrink: 0; }

        /* Toast */
        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 1001; }
        .toast { display: flex; align-items: center; gap: 10px; padding: 14px 20px; background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); transform: translateX(150%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); margin-top: 8px; }
        .toast.show { transform: translateX(0); }
        .toast-success { border-color: var(--accent-success); }
        .toast-error { border-color: var(--accent-danger); }
        .toast-icon { font-size: 1.25rem; }
        .toast-message { font-size: 0.875rem; font-weight: 500; }

        /* No API Warning */
        .no-api-warning { text-align: center; padding: 20px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: var(--radius-lg); margin-bottom: 24px; }
        .no-api-warning p { color: var(--accent-warning); margin-bottom: 12px; font-size: 0.9rem; }

        /* Responsive */
        @media (max-width: 768px) {
            .header { padding: 16px 20px; flex-direction: column; gap: 16px; }
            .steps-nav { flex-direction: column; align-items: stretch; }
            .step-connector { display: none; }
            .container { padding: 24px 16px; }
            .form-grid { grid-template-columns: 1fr; }
            .images-grid { grid-template-columns: 1fr; }
        }

        /* ===== LOGIN SCREEN ===== */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-container {
            text-align: center;
            padding: 48px;
            max-width: 420px;
            width: 100%;
        }

        .login-logo {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .login-title {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .login-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 40px;
        }

        .login-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 16px 32px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .login-btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-strong);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-btn svg {
            width: 20px;
            height: 20px;
        }

        .login-notice {
            margin-top: 24px;
            padding: 12px 16px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: var(--radius-md);
            font-size: 13px;
            color: var(--text-secondary);
        }

        .login-error {
            margin-top: 20px;
            padding: 12px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-md);
            font-size: 14px;
            color: #f87171;
        }

        .login-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .login-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-default);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* User Info in Header */
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--border-default);
        }

        .user-name {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .logout-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .logout-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-logo">‚ö°</div>
            <h1 class="login-title">DetailCraft Pro</h1>
            <p class="login-subtitle">ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Í∏∞Ìöç + AI Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±</p>
            
            <div id="loginContent">
                <button class="login-btn" id="googleLoginBtn" onclick="startGoogleLogin()">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                    </svg>
                    GoogleÎ°ú Î°úÍ∑∏Ïù∏
                </button>
                
                <div class="login-notice">
                    üîí @snack24h.com Í≥ÑÏ†ïÎßå Î°úÍ∑∏Ïù∏ Í∞ÄÎä•Ìï©ÎãàÎã§
                </div>
            </div>
            
            <div id="loginLoading" class="login-loading" style="display: none;">
                <div class="login-spinner"></div>
                <span style="color: var(--text-secondary);">Î°úÍ∑∏Ïù∏ ÌôïÏù∏ Ï§ë...</span>
            </div>
            
            <div id="loginError" class="login-error" style="display: none;"></div>
        </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="mainApp" style="display: none;">
    
    <div class="bg-effects"></div>

    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-mark">‚ö°</div>
            <span class="logo-title">DetailCraft Pro</span>
            <span class="logo-version">+ AI Image</span>
        </div>
        <div class="api-section">
            <!-- User Info -->
            <div class="user-info" id="userInfo" style="display: none;">
                <img class="user-avatar" id="userAvatar" src="" alt="">
                <span class="user-name" id="userName"></span>
                <button class="logout-btn" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
            </div>
            <button class="theme-toggle" id="themeToggle" title="ÎùºÏù¥Ìä∏/Îã§ÌÅ¨ Î™®Îìú Ï†ÑÌôò">üåô</button>
            <div class="api-status disconnected" id="claudeStatus">
                <div class="status-dot"></div>
                <span id="claudeStatusText">Í∏∞Ìöç AI ÎØ∏Ïó∞Í≤∞</span>
            </div>
            <div class="api-status disconnected" id="geminiStatus">
                <div class="status-dot"></div>
                <span id="geminiStatusText">Ïù¥ÎØ∏ÏßÄ AI ÎØ∏Ïó∞Í≤∞</span>
            </div>
            <button class="api-btn" id="apiSettingsBtn">‚öôÔ∏è API ÏÑ§Ï†ï</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Steps Navigation -->
        <nav class="steps-nav">
            <div class="step-indicator active" id="step1Nav" data-step="1">
                <div class="step-number">1</div>
                <span class="step-label">Ï†úÌíà Ï†ïÎ≥¥ ÏûÖÎ†•</span>
            </div>
            <div class="step-connector" id="connector1"></div>
            <div class="step-indicator" id="step2Nav" data-step="2">
                <div class="step-number">2</div>
                <span class="step-label">AI Í∏∞ÌöçÏÑú ÏÉùÏÑ±</span>
            </div>
            <div class="step-connector" id="connector2"></div>
            <div class="step-indicator" id="step3Nav" data-step="3">
                <div class="step-number">3</div>
                <span class="step-label">Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±</span>
            </div>
        </nav>

        <!-- No API Warning -->
        <div class="no-api-warning" id="noApiWarning">
            <p>‚ö†Ô∏è API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Í∏∞ÌöçÏÑú ÏÉùÏÑ±Í≥º Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±ÏùÑ ÏúÑÌï¥ API ÌÇ§Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.</p>
            <button class="btn btn-primary" id="setupApiBtn">üîë API ÌÇ§ ÏÑ§Ï†ïÌïòÍ∏∞</button>
        </div>

        <!-- STEP 1: Product Info -->
        <section class="step-section active" id="step1">
            <div class="form-card">
                <div class="form-card-header">
                    <h2 class="form-card-title">üì¶ Ï†úÌíà Ï†ïÎ≥¥ ÏûÖÎ†•</h2>
                    <span class="form-card-badge">STEP 1</span>
                </div>
                <div class="form-card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Ï†úÌíàÎ™Ö <span class="form-required">*</span></label>
                            <input type="text" class="form-input" id="productName" placeholder="Ïòà: ÌóàÎãàÎ≤ÑÌÑ∞ ÏïÑÎ™¨Îìú Ïä§ÎÇµ">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                            <select class="form-select" id="category">
                                <option value="snack">Ïä§ÎÇµ / Í≥ºÏûê / Ï†úÍ≥º</option>
                                <option value="beverage">ÏùåÎ£å / Ï£ºÎ•ò</option>
                                <option value="instant">Ï¶âÏÑùÏãùÌíà / Í∞ÑÌé∏Ïãù</option>
                                <option value="health">Í±¥Í∞ïÏãùÌíà / Î≥¥Ï∂©Ï†ú</option>
                                <option value="beauty">Î∑∞Ìã∞ / ÌôîÏû•Ìíà</option>
                                <option value="living">ÏÉùÌôúÏö©Ìíà</option>
                                <option value="other">Í∏∞ÌÉÄ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Í∞ÄÍ≤©ÎåÄ</label>
                            <input type="text" class="form-input" id="priceRange" placeholder="Ïòà: 12,900Ïõê">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÌÉÄÍ≤ü Í≥†Í∞ù</label>
                            <input type="text" class="form-input" id="targetAudience" placeholder="Ïòà: 20-30ÎåÄ ÏßÅÏû•Ïù∏">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Ï†úÌíà ÌäπÏßï / USP <span class="form-required">*</span></label>
                            <textarea class="form-textarea" id="productFeatures" placeholder="Ï†úÌíàÏùò ÌïµÏã¨ ÌäπÏßï, Ï∞®Î≥ÑÏ†ê, Ïû•Ï†ê Îì±ÏùÑ ÏÉÅÏÑ∏Ìûà ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî."></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Ï∂îÍ∞Ä ÏöîÏ≤≠ÏÇ¨Ìï≠</label>
                            <textarea class="form-textarea" id="additionalNotes" placeholder="Í≤ΩÏüÅÏÇ¨ Ï†ïÎ≥¥, ÌäπÎ≥ÑÌûà Í∞ïÏ°∞ÌïòÍ≥† Ïã∂ÏùÄ Ï†ê, Í∏∞ÌÉÄ ÏöîÏ≤≠ÏÇ¨Ìï≠ Îì±"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Image Upload -->
            <div class="form-card">
                <div class="form-card-header">
                    <h2 class="form-card-title">üñºÔ∏è Ï†úÌíà Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú</h2>
                    <span class="form-card-badge">ÏÑ†ÌÉù</span>
                </div>
                <div class="form-card-body">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label">üì∑ Ï†úÌíà Ï¥¨ÏòÅ Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 5Ïû•)</label>
                            <div class="upload-zone multi-upload" id="productImageZone">
                                <div class="upload-icon">üì∑</div>
                                <p class="upload-text">ÌÅ¥Î¶≠ÌïòÍ±∞ÎÇò Ïù¥ÎØ∏ÏßÄÎ•º ÎìúÎûòÍ∑∏ÌïòÏÑ∏Ïöî</p>
                                <p class="upload-hint">PNG, JPG, WEBP (ÏµúÎåÄ 10MB, 5Ïû•ÍπåÏßÄ)</p>
                            </div>
                            <input type="file" hidden id="productImageInput" accept="image/*" multiple>
                            <div id="productPreviewContainer" class="preview-container"></div>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">üì¶ Ìå®ÌÇ§ÏßÄ ÎîîÏûêÏù∏ Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 5Ïû•)</label>
                            <div class="upload-zone multi-upload" id="packageImageZone">
                                <div class="upload-icon">üì¶</div>
                                <p class="upload-text">ÌÅ¥Î¶≠ÌïòÍ±∞ÎÇò Ïù¥ÎØ∏ÏßÄÎ•º ÎìúÎûòÍ∑∏ÌïòÏÑ∏Ïöî</p>
                                <p class="upload-hint">PNG, JPG, WEBP (ÏµúÎåÄ 10MB, 5Ïû•ÍπåÏßÄ)</p>
                            </div>
                            <input type="file" hidden id="packageImageInput" accept="image/*" multiple>
                            <div id="packagePreviewContainer" class="preview-container"></div>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">üé® Ï†ÑÏ≤¥ ÌÜ§Ïï§Îß§ÎÑà Î†àÌçºÎü∞Ïä§ (ÏµúÎåÄ 5Ïû•)</label>
                            <div class="upload-zone multi-upload" id="referenceImageZone">
                                <div class="upload-icon">üéØ</div>
                                <p class="upload-text">ÏõêÌïòÎäî Ïä§ÌÉÄÏùºÏùò Î†àÌçºÎü∞Ïä§ Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</p>
                                <p class="upload-hint">Ï†ÑÏ≤¥ ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÏóê Ï†ÅÏö©Îê† Î¨¥Îìú/Ïä§ÌÉÄÏùº Ï∞∏Í≥†Ïö© (5Ïû•ÍπåÏßÄ)</p>
                            </div>
                            <input type="file" hidden id="referenceImageInput" accept="image/*" multiple>
                            <div id="referencePreviewContainer" class="preview-container"></div>
                            
                            <!-- Î†àÌçºÎü∞Ïä§ Î∞òÏòÅ Í∞ïÎèÑ ÏÑ†ÌÉù -->
                            <div class="ref-strength-section" id="refStrengthSection" style="display: none;">
                                <label class="form-label" style="margin-top: 16px;">üìä Î†àÌçºÎü∞Ïä§ Î∞òÏòÅ Í∞ïÎèÑ</label>
                                <div class="ref-strength-options">
                                    <label class="ref-strength-option">
                                        <input type="radio" name="refStrength" value="weak">
                                        <span class="ref-strength-label">
                                            <strong>ÏïΩÌïòÍ≤å</strong>
                                            <small>Î†àÏù¥ÏïÑÏõÉÎßå Ï∞∏Í≥†</small>
                                        </span>
                                    </label>
                                    <label class="ref-strength-option">
                                        <input type="radio" name="refStrength" value="strong" checked>
                                        <span class="ref-strength-label">
                                            <strong>Í∞ïÌïòÍ≤å</strong>
                                            <small>Î¨¥Îìú/ÌÉÄÏù¥Ìè¨/Î∞∞Í≤Ω Î∞òÏòÅ (ÏÉâÏÉÅÏùÄ Ï†úÌíàÏóêÏÑú)</small>
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="generate-wrapper">
                <button class="generate-btn" id="generatePlanBtn">
                    <span class="btn-text">‚ö° Í∏∞ÌöçÏÑú ÏÉùÏÑ±ÌïòÍ∏∞</span>
                    <div class="spinner"></div>
                </button>
            </div>

            <div class="progress-section" id="step1Progress">
                <div class="progress-header">
                    <span class="progress-title">AIÍ∞Ä Í∏∞ÌöçÏÑúÎ•º ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...</span>
                    <span class="progress-percent" id="step1ProgressPercent">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="step1ProgressFill"></div></div>
            </div>
        </section>

        <!-- STEP 2: Generated Plan -->
        <section class="step-section" id="step2">
            <div class="form-card">
                <div class="form-card-header">
                    <h2 class="form-card-title">üìã AI ÏÉùÏÑ± Í∏∞ÌöçÏÑú</h2>
                    <span class="form-card-badge">STEP 2</span>
                </div>
                <div class="form-card-body">
                    <div class="output-actions" style="margin-bottom: 20px;">
                        <button class="btn btn-secondary" id="copyPlanBtn">üìã Î≥µÏÇ¨</button>
                        <button class="btn btn-secondary" id="downloadPlanBtn">üìÑ Îã§Ïö¥Î°úÎìú</button>
                        <button class="btn btn-secondary" id="editPlanBtn">‚úèÔ∏è ÏàòÏ†ï</button>
                    </div>
                    <div id="planOutput" class="formatted-output" style="max-height: 400px; overflow-y: auto; padding: 20px; background: var(--bg-tertiary); border-radius: var(--radius-lg);"></div>
                </div>
            </div>

            <div class="form-card">
                <div class="form-card-header">
                    <h2 class="form-card-title">üñºÔ∏è ÏÑπÏÖòÎ≥Ñ Î†àÌçºÎü∞Ïä§ Ïù¥ÎØ∏ÏßÄ</h2>
                    <span class="form-card-badge">ÏÑ†ÌÉù</span>
                </div>
                <div class="form-card-body">
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 20px;">
                        Í∞Å ÏÑπÏÖòÏóê Í∞úÎ≥Ñ Î†àÌçºÎü∞Ïä§Î•º Ï∂îÍ∞ÄÌïòÎ©¥ Îçî Ï†ïÍµêÌïú Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÉùÏÑ±Îê©ÎãàÎã§. (ÎØ∏ÏÑ§Ï†ï Ïãú Ï†ÑÏ≤¥ Î†àÌçºÎü∞Ïä§ Ï†ÅÏö©)
                    </p>
                    <div class="sections-container" id="sectionsContainer">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>

            <div class="generate-wrapper">
                <!-- ÏÉùÏÑ± ÌòÑÌô© -->
                <div class="generation-progress-box">
                    <div class="generation-progress-info">
                        <span class="generation-progress-label">üìä ÏÉùÏÑ± ÌòÑÌô©</span>
                        <span class="generation-progress-text" id="generationProgressText">0/0 ÏÑπÏÖò ÏôÑÎ£å</span>
                    </div>
                    <p class="generation-progress-hint">Í∞Å ÏÑπÏÖòÏùò "üçå Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±" Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÏõêÌïòÎäî ÏÑπÏÖòÎßå ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.</p>
                </div>
                
                <!-- Ï†ÑÏ≤¥ ÏÉùÏÑ± (ÏÑ†ÌÉù) -->
                <div class="batch-generate-section">
                    <details class="batch-generate-details">
                        <summary class="batch-generate-summary">‚ö° Ï†ÑÏ≤¥ Ìïú Î≤àÏóê ÏÉùÏÑ±ÌïòÍ∏∞ (ÏÑ†ÌÉù)</summary>
                        <div class="batch-generate-content">
                            <p class="batch-warning">‚ö†Ô∏è 8Í∞ú ÏÑπÏÖòÏùÑ Ïó∞ÏÜç ÏÉùÏÑ±Ìï©ÎãàÎã§. Í≥†ÌíàÏßà Î™®Îç∏ÏùÄ ÏãúÍ∞ÑÏù¥ Ïò§Îûò Í±∏Î¶¥ Ïàò ÏûàÏäµÎãàÎã§.</p>
                            
                            <!-- Î™®Îç∏ ÏÑ†ÌÉù -->
                            <div class="model-selector compact">
                                <div class="model-options">
                                    <label class="model-option">
                                        <input type="radio" name="imageModel" value="fast" checked onchange="setSelectedModel('fast')">
                                        <div class="model-option-content">
                                            <span class="model-option-name">‚ö° Îπ†Î•∏ ÏÉùÏÑ±</span>
                                            <span class="model-option-desc">10~30Ï¥à/ÏÑπÏÖò</span>
                                        </div>
                                    </label>
                                    <label class="model-option">
                                        <input type="radio" name="imageModel" value="quality" onchange="setSelectedModel('quality')">
                                        <div class="model-option-content">
                                            <span class="model-option-name">üé® Í≥†ÌíàÏßà</span>
                                            <span class="model-option-desc">1~5Î∂Ñ/ÏÑπÏÖò</span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- ÎπÑÏú® ÏÑ†ÌÉù -->
                            <div class="aspect-ratio-selector">
                                <label class="form-label">üìê Ïù¥ÎØ∏ÏßÄ ÎπÑÏú®</label>
                                <div class="aspect-ratio-options">
                                    <label class="aspect-option">
                                        <input type="radio" name="aspectRatio" value="1:1" onchange="setAspectRatio('1:1')">
                                        <div class="aspect-option-content"><span class="aspect-label">1:1</span><span class="aspect-desc">Ï†ïÏÇ¨Í∞Å</span></div>
                                    </label>
                                    <label class="aspect-option">
                                        <input type="radio" name="aspectRatio" value="3:4" checked onchange="setAspectRatio('3:4')">
                                        <div class="aspect-option-content"><span class="aspect-label">3:4</span><span class="aspect-desc">ÏÑ∏Î°ú</span></div>
                                    </label>
                                    <label class="aspect-option">
                                        <input type="radio" name="aspectRatio" value="4:3" onchange="setAspectRatio('4:3')">
                                        <div class="aspect-option-content"><span class="aspect-label">4:3</span><span class="aspect-desc">Í∞ÄÎ°ú</span></div>
                                    </label>
                                    <label class="aspect-option">
                                        <input type="radio" name="aspectRatio" value="9:16" onchange="setAspectRatio('9:16')">
                                        <div class="aspect-option-content"><span class="aspect-label">9:16</span><span class="aspect-desc">ÏÑ∏Î°úÍ∏∏Í≤å</span></div>
                                    </label>
                                    <label class="aspect-option">
                                        <input type="radio" name="aspectRatio" value="16:9" onchange="setAspectRatio('16:9')">
                                        <div class="aspect-option-content"><span class="aspect-label">16:9</span><span class="aspect-desc">Î∞∞ÎÑà</span></div>
                                    </label>
                                </div>
                            </div>
                            
                            <button class="generate-btn gemini" id="generateImagesBtn">
                                <span class="btn-text">üçå Ï†ÑÏ≤¥ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±</span>
                                <div class="spinner"></div>
                            </button>
                        </div>
                    </details>
                </div>
                
                <!-- STEP 3Î°ú Ïù¥Îèô -->
                <button class="btn btn-primary btn-lg" id="goToStep3Btn">
                    üì• Îã§Ïö¥Î°úÎìú ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô ‚Üí
                </button>
            </div>

            <div class="progress-section" id="step2Progress">
                <div class="progress-header">
                    <span class="progress-title">Ïù¥ÎØ∏ÏßÄÎ•º ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...</span>
                    <span class="progress-percent" id="step2ProgressPercent">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill gemini" id="step2ProgressFill"></div></div>
                <div class="progress-log" id="imageGenLog"></div>
            </div>
        </section>

        <!-- STEP 3: Generated Images -->
        <section class="step-section" id="step3">
            <div class="output-header">
                <h2 class="output-title">üé® ÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄ <span class="output-badge" id="imageCount">0/0</span></h2>
                <div class="output-actions">
                    <button class="btn btn-secondary" id="regenerateAllBtn">üîÑ Ï†ÑÏ≤¥ Ïû¨ÏÉùÏÑ±</button>
                </div>
            </div>
            
            <!-- Ï†ÑÏ≤¥ Ïû¨ÏÉùÏÑ± ÏßÑÌñâ ÏÉÅÌô© -->
            <div class="step3-progress-section" id="step3Progress" style="display: none;">
                <div class="step3-progress-header">
                    <span class="step3-progress-title" id="step3ProgressTitle">üçå Ïù¥ÎØ∏ÏßÄ Ïû¨ÏÉùÏÑ± Ï§ë...</span>
                    <span class="step3-progress-percent" id="step3ProgressPercent">0/8</span>
                </div>
                <div class="step3-progress-bar">
                    <div class="step3-progress-fill" id="step3ProgressFill" style="width: 0%"></div>
                </div>
                <div class="step3-progress-sections" id="step3ProgressSections">
                    <!-- ÏÑπÏÖòÎ≥Ñ ÏÉÅÌÉú ÌëúÏãú -->
                </div>
            </div>

            <div class="images-grid" id="imagesGrid">
                <!-- Dynamically populated -->
            </div>

            <div class="download-all-section">
                <h3 class="download-all-title">üì• ÌîåÎû´ÌèºÎ≥Ñ Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú</h3>
                <p class="download-all-desc">Î™®Îì† ÌîåÎû´Ìèº Í∑úÍ≤©Ïóê ÎßûÍ≤å Î¶¨ÏÇ¨Ïù¥Ï¶àÎêú Ïù¥ÎØ∏ÏßÄÎ•º Ìè¥ÎçîÎ≥ÑÎ°ú Îã§Ïö¥Î°úÎìúÌï©ÎãàÎã§.</p>
                <div class="platform-info">
                    <div class="platform-badge">Ïä§ÎßàÌä∏Ïä§ÌÜ†Ïñ¥ 860px</div>
                    <div class="platform-badge">Ïø†Ìå° 780px</div>
                    <div class="platform-badge">11Î≤àÍ∞Ä 800px</div>
                    <div class="platform-badge">GÎßàÏºì/Ïò•ÏÖò 860px</div>
                </div>
                <button class="btn btn-gemini btn-lg" id="downloadAllBtn">
                    <span>‚¨áÔ∏è Ï†ÑÏ≤¥ Îã§Ïö¥Î°úÎìú (ZIP)</span>
                </button>
                <p class="download-hint">ÌîåÎû´ÌèºÎ≥Ñ Ìè¥ÎçîÎ°ú ÏûêÎèô Ï†ïÎ¶¨Îê©ÎãàÎã§</p>
            </div>
            
            <!-- Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÏÑπÏÖò -->
            <div class="checklist-section">
                <div class="checklist-header">
                    <h3 class="checklist-title">üìã ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÌíàÏßà Ï≤¥ÌÅ¨</h3>
                    <p class="checklist-desc">AIÍ∞Ä ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÎ•º Î∂ÑÏÑùÌïòÍ≥† Í∞úÏÑ†Ï†êÏùÑ ÏïåÎ†§ÎìúÎ¶ΩÎãàÎã§</p>
                </div>
                
                <div class="checklist-body">
                    <!-- Î∂ÑÏÑù Î≤ÑÌäº -->
                    <div class="checklist-action">
                        <button class="btn btn-primary btn-lg" id="runChecklistBtn">
                            <span>üîç ÌíàÏßà Ï≤¥ÌÅ¨ ÏãúÏûë</span>
                        </button>
                        <p class="checklist-action-hint">ÏÉùÏÑ±Îêú Í∏∞ÌöçÏÑúÏôÄ Ïù¥ÎØ∏ÏßÄÎ•º AIÍ∞Ä Î∂ÑÏÑùÌï©ÎãàÎã§</p>
                    </div>
                </div>
                
                <!-- Î∂ÑÏÑù Í≤∞Í≥º -->
                <div class="checklist-result" id="checklistResult" style="display: none;">
                    <!-- JSÎ°ú ÎèôÏ†Å ÏÉùÏÑ± -->
                </div>
            </div>
        </section>
    </div>

    <!-- API Modal -->
    <div class="modal-overlay" id="apiModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üîë API ÌÇ§ ÏÑ§Ï†ï</h3>
                <button class="modal-close" id="modalClose">√ó</button>
            </div>
            <div class="modal-body">
                <div class="api-input-group">
                    <label class="api-input-label">
                        <span class="api-badge claude">Claude</span>
                        Anthropic API Key (Í∏∞ÌöçÏÑú ÏÉùÏÑ±Ïö©)
                    </label>
                    <div class="api-input-wrapper">
                        <input type="password" class="api-input" id="claudeApiInput" placeholder="sk-ant-...">
                        <button class="api-input-toggle" id="toggleClaude">üëÅÔ∏è</button>
                    </div>
                    <p class="api-helper">
                        <a href="https://console.anthropic.com/settings/keys" target="_blank">Anthropic Console</a>ÏóêÏÑú API ÌÇ§Î•º Î∞úÍ∏âÎ∞õÏúºÏÑ∏Ïöî.
                    </p>
                </div>
                <div class="api-input-group">
                    <label class="api-input-label">
                        <span class="api-badge gemini">Gemini</span>
                        Google AI API Key (Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±Ïö©)
                    </label>
                    <div class="api-input-wrapper">
                        <input type="password" class="api-input" id="geminiApiInput" placeholder="AIza...">
                        <button class="api-input-toggle" id="toggleGemini">üëÅÔ∏è</button>
                    </div>
                    <p class="api-helper">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>ÏóêÏÑú API ÌÇ§Î•º Î∞úÍ∏âÎ∞õÏúºÏÑ∏Ïöî.
                    </p>
                </div>
                <div style="padding: 12px 16px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: var(--radius-md); margin-top: 8px;">
                    <p style="font-size: 0.8rem; color: var(--accent-gemini); line-height: 1.5;">
                        üí° API ÌÇ§Îäî Î∏åÎùºÏö∞Ï†Ä Î°úÏª¨ Ï†ÄÏû•ÏÜåÏóêÎßå Ï†ÄÏû•ÎêòÎ©∞ Ïô∏Î∂ÄÎ°ú Ï†ÑÏÜ°ÎêòÏßÄ ÏïäÏäµÎãàÎã§.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="clearApiBtn">üóëÔ∏è ÏÇ≠Ï†ú</button>
                <button class="btn btn-primary" id="saveApiBtn">üíæ Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>
    
    </div><!-- end mainApp -->

    <script>
        // ===== BACKEND =====
        const BACKEND_URL = 'https://detailcraft-backend.vercel.app';
        let useBackend = true;

        // ===== AUTHENTICATION =====
        const AUTH_TOKEN_KEY = 'detailcraft_auth_token';
        const AUTH_USER_KEY = 'detailcraft_auth_user';
        let currentUser = null;

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïù∏Ï¶ù Ï≤¥ÌÅ¨
        async function checkAuth() {
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            const loginContent = document.getElementById('loginContent');
            const loginLoading = document.getElementById('loginLoading');
            const loginError = document.getElementById('loginError');

            // URLÏóêÏÑú ÌÜ†ÌÅ∞ ÎòêÎäî ÏóêÎü¨ ÌôïÏù∏
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');
            const errorFromUrl = urlParams.get('error');

            // URL Ï†ïÎ¶¨ (ÌÜ†ÌÅ∞/ÏóêÎü¨ ÌååÎùºÎØ∏ÌÑ∞ Ï†úÍ±∞)
            if (tokenFromUrl || errorFromUrl) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            // ÏóêÎü¨ Ï≤òÎ¶¨
            if (errorFromUrl) {
                loginContent.style.display = 'block';
                loginLoading.style.display = 'none';
                loginError.style.display = 'block';
                
                const errorMessages = {
                    'auth_denied': 'Î°úÍ∑∏Ïù∏Ïù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.',
                    'invalid_domain': 'snack24h.com Í≥ÑÏ†ïÏúºÎ°úÎßå Î°úÍ∑∏Ïù∏ Í∞ÄÎä•Ìï©ÎãàÎã§.',
                    'token_exchange_failed': 'Ïù∏Ï¶ù Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.',
                    'user_info_failed': 'ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.',
                    'server_error': 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.'
                };
                loginError.textContent = errorMessages[errorFromUrl] || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                return;
            }

            // URLÏóêÏÑú Î∞õÏùÄ ÌÜ†ÌÅ∞ Ï†ÄÏû•
            if (tokenFromUrl) {
                localStorage.setItem(AUTH_TOKEN_KEY, tokenFromUrl);
            }

            // Ï†ÄÏû•Îêú ÌÜ†ÌÅ∞ ÌôïÏù∏
            const token = localStorage.getItem(AUTH_TOKEN_KEY);

            if (!token) {
                // ÌÜ†ÌÅ∞ ÏóÜÏùå ‚Üí Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ ÌëúÏãú
                loginScreen.style.display = 'flex';
                mainApp.style.display = 'none';
                return;
            }

            // ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù Ï§ë Î°úÎî© ÌëúÏãú
            loginContent.style.display = 'none';
            loginLoading.style.display = 'flex';
            loginError.style.display = 'none';

            try {
                // Î∞±ÏóîÎìúÏóêÏÑú ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù
                const response = await fetch(`${BACKEND_URL}/api/auth/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.valid) {
                    // Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ
                    currentUser = data.user;
                    localStorage.setItem(AUTH_USER_KEY, JSON.stringify(data.user));
                    
                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    showMainApp();
                    updateUserUI();
                } else {
                    // ÌÜ†ÌÅ∞ Î¨¥Ìö®
                    localStorage.removeItem(AUTH_TOKEN_KEY);
                    localStorage.removeItem(AUTH_USER_KEY);
                    
                    loginContent.style.display = 'block';
                    loginLoading.style.display = 'none';
                    loginError.style.display = 'block';
                    loginError.textContent = data.error === 'Token expired' 
                        ? 'ÏÑ∏ÏÖòÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.' 
                        : 'Ïù∏Ï¶ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.';
                }
            } catch (error) {
                console.error('Auth verification error:', error);
                // ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò ÏãúÏóêÎèÑ Ï†ÄÏû•Îêú Ïú†Ï†Ä Ï†ïÎ≥¥Î°ú ÏûÑÏãú ÌóàÏö© (Ïò§ÌîÑÎùºÏù∏ ÎåÄÏùë)
                const savedUser = localStorage.getItem(AUTH_USER_KEY);
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    showMainApp();
                    updateUserUI();
                } else {
                    loginContent.style.display = 'block';
                    loginLoading.style.display = 'none';
                    loginError.style.display = 'block';
                    loginError.textContent = 'ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                }
            }
        }

        // Google Î°úÍ∑∏Ïù∏ ÏãúÏûë
        function startGoogleLogin() {
            const btn = document.getElementById('googleLoginBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="login-spinner" style="width:20px;height:20px;border-width:2px;"></div> Ïó∞Í≤∞ Ï§ë...';
            
            // Î∞±ÏóîÎìú Î°úÍ∑∏Ïù∏ URLÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏
            window.location.href = `${BACKEND_URL}/api/auth/login`;
        }

        // Î°úÍ∑∏ÏïÑÏõÉ
        function logout() {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            localStorage.removeItem(AUTH_USER_KEY);
            currentUser = null;
            
            // Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ ÌëúÏãú
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginContent').style.display = 'block';
            document.getElementById('loginLoading').style.display = 'none';
            document.getElementById('loginError').style.display = 'none';
        }

        // Î©îÏù∏ Ïï± ÌëúÏãú
        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ UI ÏóÖÎç∞Ïù¥Ìä∏
        function updateUserUI() {
            if (!currentUser) return;
            
            const userInfo = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            
            if (userInfo) {
                userInfo.style.display = 'flex';
                if (currentUser.picture) {
                    userAvatar.src = currentUser.picture;
                    userAvatar.style.display = 'block';
                } else {
                    userAvatar.style.display = 'none';
                }
                userName.textContent = currentUser.name || currentUser.email;
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïù∏Ï¶ù Ï≤¥ÌÅ¨ (init Ï†ÑÏóê Ïã§Ìñâ)
        checkAuth();
        
        // ===== ASPECT RATIO =====
        let selectedAspectRatio = '3:4';
        
        // ===== STATE =====
        let claudeApiKey = '';
        let geminiApiKey = '';
        let currentStep = 1;
        let generatedPlan = '';
        let generatedSections = [];
        let uploadedImages = {
            product: [],
            package: [],
            references: []
        };
        let sectionReferences = {}; // { sectionIndex: [base64, base64, ...] }
        let generatedImages = {};
        let selectedModel = 'fast'; // 'fast' ÎòêÎäî 'quality'
        let currentTheme = 'dark'; // 'dark' ÎòêÎäî 'light'
        let focusedUploadZone = null; // ÌòÑÏû¨ Ìè¨Ïª§Ïä§Îêú ÏóÖÎ°úÎìú Ï°¥

        // ===== MODEL CONFIGURATIONS =====
        const MODEL_CONFIGS = {
            fast: {
                name: '‚ö° Îπ†Î•∏ ÏÉùÏÑ± (Í∂åÏû•)',
                model: 'gemini-2.0-flash-exp-image-generation',
                timeout: 60000, // 60Ï¥à
                config: {},
                description: '10~30Ï¥à, 1K Ìï¥ÏÉÅÎèÑ'
            },
            quality: {
                name: 'üé® Í≥†ÌíàÏßà (ÎäêÎ¶º)',
                model: 'gemini-3-pro-image-preview',
                timeout: 180000, // 3Î∂Ñ
                config: {
                    imageConfig: {
                        imageSize: '2K'
                    }
                },
                description: '1~5Î∂Ñ, 2K Ìï¥ÏÉÅÎèÑ, ÌïúÍ∏Ä Í∞úÏÑ†'
            }
        };
        
        // ÎèôÏ†ÅÏúºÎ°ú aspectRatio Ìè¨Ìï®Ìïú config Î∞òÌôò
        function getModelConfigWithRatio(baseConfig) {
            const config = { ...baseConfig };
            if (config.imageConfig) {
                config.imageConfig = { ...config.imageConfig, aspectRatio: selectedAspectRatio };
            } else {
                config.imageConfig = { aspectRatio: selectedAspectRatio };
            }
            return config;
        }

        // ===== TIMEOUT FETCH =====
        async function fetchWithTimeout(url, options, timeout = 60000) {
            return new Promise(async (resolve, reject) => {
                const timeoutId = setTimeout(() => {
                    reject(new Error(`‚è±Ô∏è ÌÉÄÏûÑÏïÑÏõÉ: ${timeout/1000}Ï¥à Ï¥àÍ≥º. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.`));
                }, timeout);
                
                try {
                    const response = await fetch(url, options);
                    clearTimeout(timeoutId);
                    resolve(response);
                } catch (error) {
                    clearTimeout(timeoutId);
                    console.error('Fetch error details:', error);
                    if (error.message.includes('Failed to fetch')) {
                        reject(new Error('CORS/ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò: ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÍ≥† Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.'));
                    } else {
                        reject(new Error(`ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò: ${error.message}`));
                    }
                }
            });
        }

        function getSelectedModelConfig() {
            return MODEL_CONFIGS[selectedModel] || MODEL_CONFIGS.fast;
        }

        function setSelectedModel(model) {
            selectedModel = model;
            localStorage.setItem('detailcraft_model', model);
            updateModelDisplay();
            
            // Í≤ΩÍ≥† ÌëúÏãú
            const warning = document.getElementById('modelWarning');
            if (warning) {
                warning.style.display = model === 'quality' ? 'block' : 'none';
            }
            
            // ÎùºÎîîÏò§ Î≤ÑÌäº ÎèôÍ∏∞Ìôî
            const radio = document.querySelector(`input[name="imageModel"][value="${model}"]`);
            if (radio) radio.checked = true;
        }
        
        function setAspectRatio(ratio) {
            selectedAspectRatio = ratio;
            localStorage.setItem('detailcraft_aspect_ratio', ratio);
            const radio = document.querySelector(`input[name="aspectRatio"][value="${ratio}"]`);
            if (radio) radio.checked = true;
        }

        function updateModelDisplay() {
            const display = document.getElementById('selectedModelDisplay');
            const config = getSelectedModelConfig();
            if (display) {
                display.textContent = `ÌòÑÏû¨: ${config.name}`;
            }
        }

        // ===== INIT =====
        function init() {
            claudeApiKey = localStorage.getItem('detailcraft_claude_key') || '';
            geminiApiKey = localStorage.getItem('detailcraft_gemini_key') || '';
            selectedModel = localStorage.getItem('detailcraft_model') || 'fast';
            selectedAspectRatio = localStorage.getItem('detailcraft_aspect_ratio') || '3:4';
            currentTheme = localStorage.getItem('detailcraft_theme') || 'dark';
            
            applyTheme(currentTheme);
            updateApiStatus();
            setupEventListeners();
            setupUploadZones();
            updateModelDisplay();
            setupPasteHandler();
            
            // ÎπÑÏú® ÎùºÎîîÏò§ Î≤ÑÌäº ÎèôÍ∏∞Ìôî
            const ratioRadio = document.querySelector(`input[name="aspectRatio"][value="${selectedAspectRatio}"]`);
            if (ratioRadio) ratioRadio.checked = true;
        }
        
        // ===== THEME =====
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const toggleBtn = document.getElementById('themeToggle');
            if (toggleBtn) {
                toggleBtn.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
                toggleBtn.title = theme === 'dark' ? 'ÎùºÏù¥Ìä∏ Î™®ÎìúÎ°ú Ï†ÑÌôò' : 'Îã§ÌÅ¨ Î™®ÎìúÎ°ú Ï†ÑÌôò';
            }
            currentTheme = theme;
        }
        
        function toggleTheme() {
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('detailcraft_theme', newTheme);
            applyTheme(newTheme);
        }
        
        // ===== PASTE HANDLER =====
        function setupPasteHandler() {
            document.addEventListener('paste', async (e) => {
                if (!focusedUploadZone) return;
                
                const items = e.clipboardData?.items;
                if (!items) return;
                
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        if (file) {
                            handlePastedImage(file);
                        }
                        break;
                    }
                }
            });
            
            // Îã§Î•∏ Í≥≥ ÌÅ¥Î¶≠ Ïãú Ìè¨Ïª§Ïä§ Ìï¥Ï†ú
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.upload-zone')) {
                    clearUploadFocus();
                }
            });
        }
        
        function handlePastedImage(file) {
            if (!focusedUploadZone) return;
            
            const zoneId = focusedUploadZone.id;
            let type, containerId, maxCount;
            
            if (zoneId === 'productImageZone') {
                type = 'product';
                containerId = 'productPreviewContainer';
                maxCount = 5;
            } else if (zoneId === 'packageImageZone') {
                type = 'package';
                containerId = 'packagePreviewContainer';
                maxCount = 5;
            } else if (zoneId === 'referenceImageZone') {
                type = 'references';
                containerId = 'referencePreviewContainer';
                maxCount = 5;
            } else {
                return;
            }
            
            const container = document.getElementById(containerId);
            if (uploadedImages[type].length >= maxCount) {
                showToast(`ÏµúÎåÄ ${maxCount}Ïû•ÍπåÏßÄÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.`, 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImages[type].push(e.target.result);
                renderPreviewContainer(type, container, maxCount);
                showToast('Ïù¥ÎØ∏ÏßÄÍ∞Ä Î∂ôÏó¨ÎÑ£Í∏∞ ÎêòÏóàÏäµÎãàÎã§!', 'success');
            };
            reader.readAsDataURL(file);
        }
        
        function setUploadFocus(zone) {
            clearUploadFocus();
            zone.classList.add('focused');
            focusedUploadZone = zone;
        }
        
        function clearUploadFocus() {
            document.querySelectorAll('.upload-zone.focused').forEach(z => z.classList.remove('focused'));
            focusedUploadZone = null;
        }

        function updateApiStatus() {
            const claudeStatus = document.getElementById('claudeStatus');
            const claudeText = document.getElementById('claudeStatusText');
            const geminiStatus = document.getElementById('geminiStatus');
            const geminiText = document.getElementById('geminiStatusText');
            const warning = document.getElementById('noApiWarning');
            const planBtn = document.getElementById('generatePlanBtn');
            const imagesBtn = document.getElementById('generateImagesBtn');
            const apiSettingsBtn = document.getElementById('apiSettingsBtn');

            if (useBackend) {
                claudeStatus.classList.remove('disconnected');
                claudeStatus.classList.add('connected');
                claudeText.textContent = 'Í∏∞Ìöç AI (ÏÑúÎ≤Ñ)';
                geminiStatus.classList.remove('disconnected');
                geminiStatus.classList.add('connected');
                geminiText.textContent = 'Ïù¥ÎØ∏ÏßÄ AI (ÏÑúÎ≤Ñ)';
                warning.style.display = 'none';
                planBtn.disabled = false;
                if (imagesBtn) imagesBtn.disabled = false;
                if (apiSettingsBtn) apiSettingsBtn.style.display = 'none';
                return;
            }

            if (geminiApiKey) {
                claudeStatus.classList.remove('disconnected');
                claudeStatus.classList.add('connected');
                claudeText.textContent = 'Í∏∞Ìöç AI ‚úì';
            } else {
                claudeStatus.classList.remove('connected');
                claudeStatus.classList.add('disconnected');
                claudeText.textContent = 'Í∏∞Ìöç AI ÎØ∏Ïó∞Í≤∞';
            }

            if (geminiApiKey) {
                geminiStatus.classList.remove('disconnected');
                geminiStatus.classList.add('connected');
                geminiText.textContent = 'Ïù¥ÎØ∏ÏßÄ AI ‚úì';
            } else {
                geminiStatus.classList.remove('connected');
                geminiStatus.classList.add('disconnected');
                geminiText.textContent = 'Ïù¥ÎØ∏ÏßÄ AI ÎØ∏Ïó∞Í≤∞';
            }

            warning.style.display = geminiApiKey ? 'none' : 'block';
            planBtn.disabled = !geminiApiKey;
            if (imagesBtn) imagesBtn.disabled = !geminiApiKey;
        }

        function setupEventListeners() {
            // Theme Toggle
            document.getElementById('themeToggle').onclick = toggleTheme;
            
            // API Modal
            document.getElementById('apiSettingsBtn').onclick = openModal;
            document.getElementById('setupApiBtn').onclick = openModal;
            document.getElementById('modalClose').onclick = closeModal;
            document.getElementById('apiModal').onclick = e => { if (e.target.id === 'apiModal') closeModal(); };
            document.getElementById('toggleClaude').onclick = () => togglePassword('claudeApiInput', 'toggleClaude');
            document.getElementById('toggleGemini').onclick = () => togglePassword('geminiApiInput', 'toggleGemini');
            document.getElementById('saveApiBtn').onclick = saveApiKeys;
            document.getElementById('clearApiBtn').onclick = clearApiKeys;

            // Step Navigation
            document.querySelectorAll('.step-indicator').forEach(nav => {
                nav.onclick = () => {
                    const step = parseInt(nav.dataset.step);
                    if (canNavigateToStep(step)) {
                        goToStep(step);
                    } else {
                        if (step === 2) showToast('Î®ºÏ†Ä Í∏∞ÌöçÏÑúÎ•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                        if (step === 3) showToast('Î®ºÏ†Ä Ïù¥ÎØ∏ÏßÄÎ•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    }
                };
            });

            // Generate Buttons
            document.getElementById('generatePlanBtn').onclick = generatePlan;
            document.getElementById('generateImagesBtn').onclick = generateAllImages;

            // Plan Actions
            document.getElementById('copyPlanBtn').onclick = () => {
                navigator.clipboard.writeText(generatedPlan);
                showToast('Í∏∞ÌöçÏÑúÍ∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!', 'success');
            };
            document.getElementById('downloadPlanBtn').onclick = () => {
                downloadFile(generatedPlan, 'detail-page-plan.md', 'text/markdown');
                showToast('Í∏∞ÌöçÏÑúÍ∞Ä Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§!', 'success');
            };
            document.getElementById('editPlanBtn').onclick = openPlanEditor;

            // Download All
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            if (downloadAllBtn) downloadAllBtn.onclick = downloadAllImages;
            
            const regenerateAllBtn = document.getElementById('regenerateAllBtn');
            if (regenerateAllBtn) regenerateAllBtn.onclick = regenerateAllImagesInStep3;
            
            // STEP 3Î°ú Ïù¥Îèô Î≤ÑÌäº
            const goToStep3Btn = document.getElementById('goToStep3Btn');
            if (goToStep3Btn) goToStep3Btn.onclick = () => goToStep(3);
            
            // Checklist
            const runChecklistBtn = document.getElementById('runChecklistBtn');
            if (runChecklistBtn) runChecklistBtn.onclick = runChecklist;
            setupChecklistUI();
        }
        
        // ===== CHECKLIST UI SETUP =====
        function setupChecklistUI() {
            // Í≤ΩÏüÅÏÇ¨ ÎπÑÍµê Í∏∞Îä• Ï†úÍ±∞Îê® - Îπà Ìï®ÏàòÎ°ú Ïú†ÏßÄ
        }

        // ===== UPLOAD ZONES =====
        function setupUploadZones() {
            // Product Images (up to 5)
            setupMultiUploadZone('productImageZone', 'productImageInput', 'product', 'productPreviewContainer', 5);
            // Package Images (up to 5)
            setupMultiUploadZone('packageImageZone', 'packageImageInput', 'package', 'packagePreviewContainer', 5);
            // Reference Images (up to 5)
            setupMultiUploadZone('referenceImageZone', 'referenceImageInput', 'references', 'referencePreviewContainer', 5);
        }

        function setupMultiUploadZone(zoneId, inputId, type, containerId, maxCount) {
            const zone = document.getElementById(zoneId);
            const input = document.getElementById(inputId);
            const container = document.getElementById(containerId);

            zone.onclick = (e) => {
                if (e.target.closest('.remove-btn')) return;
                e.stopPropagation();
                
                // Ïù¥ÎØ∏ Ìè¨Ïª§Ïä§Îêú ÏÉÅÌÉúÎ©¥ ÌååÏùº ÏÑ†ÌÉù Ï∞Ω Ïó¥Í∏∞
                if (zone.classList.contains('focused')) {
                    input.click();
                } else {
                    // Ìè¨Ïª§Ïä§ ÏÑ§Ï†ï
                    setUploadFocus(zone);
                }
            };
            
            zone.ondragover = e => { 
                e.preventDefault(); 
                zone.classList.add('dragover'); 
            };
            zone.ondragleave = e => { 
                e.preventDefault();
                zone.classList.remove('dragover'); 
            };
            zone.ondrop = e => {
                e.preventDefault();
                zone.classList.remove('dragover');
                handleMultiUpload(e.dataTransfer.files, type, container, maxCount);
            };
            
            input.onchange = () => {
                handleMultiUpload(input.files, type, container, maxCount);
                input.value = ''; // Reset for re-upload
            };
        }

        // Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï Ìï®Ïàò (API Ï†ÑÏÜ° Ï†Ñ ÌÅ¨Í∏∞ Ï∂ïÏÜå)
        function compressImage(base64, maxWidth = 1200, quality = 0.7) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // ÏµúÎåÄ ÎÑàÎπÑÎ•º Ï¥àÍ≥ºÌïòÎ©¥ ÎπÑÏú®Ïóê ÎßûÍ≤å Ï∂ïÏÜå
                    if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);

                    // JPEGÎ°ú ÏïïÏ∂ïÌïòÏó¨ Ïö©Îüâ Í∞êÏÜå
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = () => resolve(base64); // Ïã§Ìå® Ïãú ÏõêÎ≥∏ Î∞òÌôò
                img.src = base64;
            });
        }

        function handleMultiUpload(files, type, container, maxCount) {
            const currentCount = uploadedImages[type].length;
            const remaining = maxCount - currentCount;

            if (remaining <= 0) {
                showToast(`ÏµúÎåÄ ${maxCount}Ïû•ÍπåÏßÄÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.`, 'error');
                return;
            }

            Array.from(files).slice(0, remaining).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    showToast('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.', 'error');
                    return;
                }

                // ÌååÏùº ÌÅ¨Í∏∞ Ï≤¥ÌÅ¨ (10MB Ï¥àÍ≥º Ïãú Í≤ΩÍ≥†)
                if (file.size > 10 * 1024 * 1024) {
                    showToast('ÌååÏùºÏù¥ ÎÑàÎ¨¥ ÌÅΩÎãàÎã§. 10MB Ïù¥Ìïò Ïù¥ÎØ∏ÏßÄÎ•º ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = async e => {
                    // Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï ÌõÑ Ï†ÄÏû•
                    const compressed = await compressImage(e.target.result);
                    uploadedImages[type].push(compressed);
                    renderPreviewContainer(type, container, maxCount);
                };
                reader.readAsDataURL(file);
            });
        }

        function renderPreviewContainer(type, container, maxCount) {
            container.innerHTML = uploadedImages[type].map((src, i) => `
                <div class="preview-item">
                    <img src="${src}" alt="Preview ${i + 1}">
                    <button class="remove-btn" onclick="removeUploadedImage('${type}', ${i}, '${container.id}', ${maxCount})">√ó</button>
                </div>
            `).join('');
            
            // Update zone status
            const zoneId = type === 'references' ? 'referenceImageZone' : `${type}ImageZone`;
            const zone = document.getElementById(zoneId);
            if (uploadedImages[type].length > 0) {
                zone.querySelector('.upload-text').textContent = `${uploadedImages[type].length}/${maxCount}Ïû• ÏóÖÎ°úÎìúÎê® (ÌÅ¥Î¶≠ÌïòÏó¨ Ï∂îÍ∞Ä)`;
            } else {
                zone.querySelector('.upload-text').textContent = 'ÌÅ¥Î¶≠ÌïòÍ±∞ÎÇò Ïù¥ÎØ∏ÏßÄÎ•º ÎìúÎûòÍ∑∏ÌïòÏÑ∏Ïöî';
            }
            
            // Î†àÌçºÎü∞Ïä§ Ïù¥ÎØ∏ÏßÄÏùº Í≤ΩÏö∞ Í∞ïÎèÑ ÏÑ†ÌÉù UI ÌëúÏãú/Ïà®ÍπÄ
            if (type === 'references') {
                const refStrengthSection = document.getElementById('refStrengthSection');
                if (refStrengthSection) {
                    refStrengthSection.style.display = uploadedImages.references.length > 0 ? 'block' : 'none';
                }
            }
        }

        function removeUploadedImage(type, index, containerId, maxCount) {
            uploadedImages[type].splice(index, 1);
            renderPreviewContainer(type, document.getElementById(containerId), maxCount);
        }

        // ===== MODAL =====
        function openModal() {
            document.getElementById('apiModal').classList.add('active');
            document.getElementById('claudeApiInput').value = claudeApiKey;
            document.getElementById('geminiApiInput').value = geminiApiKey;
        }

        function closeModal() {
            document.getElementById('apiModal').classList.remove('active');
        }

        function togglePassword(inputId, btnId) {
            const input = document.getElementById(inputId);
            const btn = document.getElementById(btnId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
            }
        }

        function saveApiKeys() {
            const claude = document.getElementById('claudeApiInput').value.trim();
            const gemini = document.getElementById('geminiApiInput').value.trim();

            if (claude && !claude.startsWith('sk-ant-')) {
                showToast('Claude API ÌÇ§ ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.', 'error');
                return;
            }
            if (gemini && !gemini.startsWith('AIza')) {
                showToast('Gemini API ÌÇ§ ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.', 'error');
                return;
            }

            claudeApiKey = claude;
            geminiApiKey = gemini;
            if (claude) localStorage.setItem('detailcraft_claude_key', claude);
            if (gemini) localStorage.setItem('detailcraft_gemini_key', gemini);
            
            updateApiStatus();
            closeModal();
            showToast('API ÌÇ§Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');
        }

        function clearApiKeys() {
            claudeApiKey = '';
            geminiApiKey = '';
            localStorage.removeItem('detailcraft_claude_key');
            localStorage.removeItem('detailcraft_gemini_key');
            document.getElementById('claudeApiInput').value = '';
            document.getElementById('geminiApiInput').value = '';
            updateApiStatus();
            closeModal();
            showToast('API ÌÇ§Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
        }

        // ===== STEP NAVIGATION =====
        function goToStep(step) {
            // STEP 3ÏóêÏÑú Îí§Î°ú Í∞à Îïå Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄ
            const previousStep = currentStep;
            currentStep = step;
            
            document.querySelectorAll('.step-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            
            // ÏµúÎåÄ ÎèÑÎã¨ Ïä§ÌÖù Í∏∞Î°ù (Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏôÑÎ£å Ïó¨Î∂Ä)
            const maxReachedStep = Object.keys(generatedImages).length > 0 ? 3 : (generatedSections.length > 0 ? 2 : 1);
            
            document.querySelectorAll('.step-indicator').forEach((nav, i) => {
                nav.classList.remove('active', 'completed');
                if (i + 1 < step) nav.classList.add('completed');
                if (i + 1 === step) nav.classList.add('active');
                // Ïù¥ÎØ∏ ÎèÑÎã¨Ìïú Ïä§ÌÖùÏùÄ ÌÅ¥Î¶≠ Í∞ÄÎä•ÌïòÎèÑÎ°ù completed ÌëúÏãú
                if (i + 1 <= maxReachedStep && i + 1 !== step) nav.classList.add('completed');
            });

            document.querySelectorAll('.step-connector').forEach((conn, i) => {
                conn.classList.toggle('completed', i + 1 < Math.max(step, maxReachedStep));
            });
            
            // STEP 3ÏúºÎ°ú ÎèåÏïÑÏò¨ Îïå Ïù¥ÎØ∏ÏßÄ Í∑∏Î¶¨Îìú Îã§Ïãú Î†åÎçîÎßÅ
            if (step === 3 && Object.keys(generatedImages).length > 0) {
                renderImagesGrid();
            }
        }
        
        // Ïä§ÌÖù ÌÅ¥Î¶≠ Í∞ÄÎä• Ïó¨Î∂Ä ÌôïÏù∏
        function canNavigateToStep(step) {
            if (step === 1) return true;
            if (step === 2) return generatedSections.length > 0;
            if (step === 3) {
                const hasAnyImage = Object.values(generatedImages).some(img => img && !img.error);
                return hasAnyImage;
            }
            return false;
        }

        // ===== GENERATE PLAN =====
        async function generatePlan() {
            const name = document.getElementById('productName').value.trim();
            if (!name) {
                showToast('Ï†úÌíàÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            const btn = document.getElementById('generatePlanBtn');
            const progress = document.getElementById('step1Progress');
            
            btn.classList.add('loading');
            btn.disabled = true;
            progress.classList.add('active');

            try {
                const data = {
                    productName: name,
                    category: document.getElementById('category').value,
                    priceRange: document.getElementById('priceRange').value || 'ÎØ∏Ï†ï',
                    targetAudience: document.getElementById('targetAudience').value || 'ÏùºÎ∞ò ÏÜåÎπÑÏûê',
                    productFeatures: document.getElementById('productFeatures').value || '',
                    additionalNotes: document.getElementById('additionalNotes').value || ''
                };

                await animateProgress('step1', 10);
                
                // üîç Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Îã®Í≥Ñ Ï∂îÍ∞Ä
                let imageAnalysis = null;
                const hasImages = uploadedImages.product.length > 0 || uploadedImages.package.length > 0;
                
                if (hasImages) {
                    showToast('üîç Ï†úÌíà Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Ï§ë...', 'success');
                    try {
                        imageAnalysis = await analyzeProductImages();
                        await animateProgress('step1', 40);
                    } catch (err) {
                        console.warn('Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Ïã§Ìå®, Í∏∞Î≥∏ Í∏∞ÌöçÏúºÎ°ú ÏßÑÌñâ:', err);
                        await animateProgress('step1', 30);
                    }
                } else {
                    await animateProgress('step1', 30);
                }
                
                const prompt = buildPlanPrompt(data, imageAnalysis);
                const response = await callClaudeAPI(prompt);
                
                await animateProgress('step1', 100);
                
                generatedPlan = response;
                generatedSections = parseSections(response);
                
                displayPlan(response);
                renderSectionsEditor();
                
                showToast('Í∏∞ÌöçÏÑú ÏÉùÏÑ± ÏôÑÎ£å!', 'success');
                
                setTimeout(() => {
                    goToStep(2);
                }, 500);

            } catch (error) {
                console.error('Error:', error);
                showToast(error.message || 'Í∏∞ÌöçÏÑú ÏÉùÏÑ± Ïã§Ìå®', 'error');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
                progress.classList.remove('active');
            }
        }
        
        // API Ï†ÑÏÜ°Ïö© Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï (Îçî ÏûëÏùÄ ÌÅ¨Í∏∞)
        function compressImageForAPI(base64, maxWidth = 800, quality = 0.5) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);

                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = () => resolve(base64);
                img.src = base64;
            });
        }

        // ===== Ï†úÌíà Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù (Gemini Vision) =====
        async function analyzeProductImages() {
            const images = [];

            // Ï†úÌíà Ïù¥ÎØ∏ÏßÄ ÏàòÏßë (ÏµúÎåÄ 1Ïû• - Vercel Ïö©Îüâ Ï†úÌïú ÎåÄÏùë)
            if (uploadedImages.product.length > 0) {
                images.push({ type: 'product', index: 0, data: uploadedImages.product[0] });
            }

            // Ìå®ÌÇ§ÏßÄ Ïù¥ÎØ∏ÏßÄ ÏàòÏßë (ÏµúÎåÄ 1Ïû•)
            if (uploadedImages.package.length > 0) {
                images.push({ type: 'package', index: 0, data: uploadedImages.package[0] });
            }

            if (images.length === 0) return null;

            // Gemini Vision ÏöîÏ≤≠ Íµ¨ÏÑ±
            const parts = [
                { text: `ÎãπÏã†ÏùÄ Ïù¥Ïª§Î®∏Ïä§ ÏÉÅÌíà Î∂ÑÏÑù Ï†ÑÎ¨∏Í∞ÄÏûÖÎãàÎã§. ÏïÑÎûò Ï†úÌíà/Ìå®ÌÇ§ÏßÄ Ïù¥ÎØ∏ÏßÄÎ•º Î∂ÑÏÑùÌïòÏó¨ ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Í∏∞ÌöçÏóê ÌïÑÏöîÌïú Ï†ïÎ≥¥Î•º Ï∂îÏ∂úÌï¥Ï£ºÏÑ∏Ïöî.

## Î∂ÑÏÑù Ìï≠Î™© (JSON ÌòïÏãùÏúºÎ°ú ÎãµÎ≥Ä)

{
    "productAppearance": "Ï†úÌíàÏùò Ïô∏Ìòï, ÏÉâÏÉÅ, ÌòïÌÉú, ÌÅ¨Í∏∞Í∞ê Î¨òÏÇ¨",
    "packageDesign": "Ìå®ÌÇ§ÏßÄ ÎîîÏûêÏù∏ Ïä§ÌÉÄÏùº, ÏÉâÏÉÅ ÌÜ§, Í≥†Í∏âÍ∞ê/Ï∫êÏ£ºÏñºÌï® Ï†ïÎèÑ",
    "textFromImage": "Ïù¥ÎØ∏ÏßÄÏóêÏÑú ÏùΩÏùÑ Ïàò ÏûàÎäî ÌÖçÏä§Ìä∏ (Ï†úÌíàÎ™Ö, ÏÑ±Î∂Ñ, ÌäπÏßï Î¨∏Íµ¨ Îì±)",
    "productCategory": "Ï∂îÏ†ïÎêòÎäî ÏÉÅÏÑ∏ Ïπ¥ÌÖåÍ≥†Î¶¨ (Ïòà: Í∞êÏûêÏä§ÎÇµ, Ï¥àÏΩúÎ¶ø, Ï†§Î¶¨ Îì±)",
    "keyFeatures": ["Ïù¥ÎØ∏ÏßÄÏóêÏÑú ÌååÏïÖÎêòÎäî Ï†úÌíà ÌäπÏßï 3~5Í∞ÄÏßÄ"],
    "moodAndTone": "Ï†úÌíà/Ìå®ÌÇ§ÏßÄÏóêÏÑú ÎäêÍª¥ÏßÄÎäî Î∂ÑÏúÑÍ∏∞ (ÌîÑÎ¶¨ÎØ∏ÏóÑ/Ï∫êÏ£ºÏñº/Í±¥Í∞ï/Ïû¨ÎØ∏ Îì±)",
    "targetAudienceGuess": "Ïù¥ÎØ∏ÏßÄ Í∏∞Î∞ò Ï∂îÏ†ï ÌÉÄÍ≤üÏ∏µ",
    "colorPalette": ["Ï£ºÏöî ÏÉâÏÉÅ 3~4Í∞ú"],
    "uniqueSellingPoints": ["ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú Í∞ïÏ°∞Îêú USP 2~3Í∞ÄÏßÄ"]
}

JSONÎßå Ï∂úÎ†•ÌïòÍ≥† Îã§Î•∏ ÏÑ§Î™ÖÏùÄ ÌïòÏßÄ ÎßàÏÑ∏Ïöî.` }
            ];

            // Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï ÌõÑ Ï∂îÍ∞Ä
            for (const img of images) {
                const compressed = await compressImageForAPI(img.data);
                const base64Data = compressed.replace(/^data:image\/\w+;base64,/, '');
                parts.push({
                    inlineData: {
                        mimeType: 'image/jpeg',
                        data: base64Data
                    }
                });
            }
            
            const url = useBackend 
                ? `${BACKEND_URL}/api/gemini`
                : `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            
            const reqBody = {
                contents: [{ parts }],
                generationConfig: {
                    temperature: 0.3,
                    maxOutputTokens: 1500
                }
            };
            
            if (useBackend) reqBody.model = 'gemini-2.0-flash';
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(reqBody)
            });
            
            if (!response.ok) {
                throw new Error('Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù API Ïò§Î•ò');
            }
            
            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            
            // JSON ÌååÏã±
            try {
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
            } catch (e) {
                console.warn('Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù JSON ÌååÏã± Ïã§Ìå®:', e);
            }
            
            return null;
        }

        function buildPlanPrompt(d, imageAnalysis = null) {
            // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏÉÅÏÑ∏ Í∞ÄÏù¥Îìú
            const categoryGuide = {
                'snack': {
                    keywords: 'Î∞îÏÇ≠Ìï®, Í≥†ÏÜåÌï®, Îã¨ÏΩ§Ìï®, Ïß≠Ïß§Ìï®, Ï§ëÎèÖÏÑ±, Í∞ÑÏãù, ÏïºÏãù, ÌûêÎßÅ',
                    emotions: 'ÏÜåÌôïÌñâ, ÎÇòÎßåÏùò ÏãúÍ∞Ñ, ÏúÑÎ°ú, ÌñâÎ≥µÌïú ÏàúÍ∞Ñ',
                    painPoints: 'ÏÇ¥Ï∞îÍπåÎ¥ê Í±±Ï†ï, Í±¥Í∞ïÏóê Ïïà Ï¢ãÏùÑÍπå, ÏñëÏù¥ Ï†ÅÏùÑÍπå',
                    trustElements: 'ÏõêÏû¨Î£å ÏõêÏÇ∞ÏßÄ, Î¨¥Ï≤®Í∞Ä, Ï†ÑÌÜµ Î∞©Ïãù, Ïû•Ïù∏ Ï†ïÏã†'
                },
                'beverage': {
                    keywords: 'Ï≤≠ÎüâÍ∞ê, ÍπîÎÅîÌï®, ÏãúÏõêÌï®, Îã¨ÏΩ§Ìï®, Í±¥Í∞ï, ÏóêÎÑàÏßÄ',
                    emotions: 'Í∞àÏ¶ù Ìï¥ÏÜå, ÌôúÎ†• Ï∂©Ï†Ñ, Ìú¥Ïãù, Î¶¨ÌîÑÎ†àÏãú',
                    painPoints: 'ÎãπÎ∂Ñ Í±±Ï†ï, Ïπ¥ÌéòÏù∏ Î∂ÄÏûëÏö©, Ïù∏Í≥µ Ï≤®Í∞ÄÎ¨º',
                    trustElements: 'Ï≤úÏó∞ ÏõêÎ£å, Î¨¥ÏÑ§ÌÉï, Ï†ÄÏπºÎ°úÎ¶¨, Ïú†Í∏∞ÎÜç Ïù∏Ï¶ù'
                },
                'instant': {
                    keywords: 'Í∞ÑÌé∏Ìï®, Îπ†Î¶Ñ, ÎßõÏûàÏùå, Îì†Îì†Ìï®, Ïã§ÏÜç',
                    emotions: 'Î∞îÏÅú ÏùºÏÉÅ ÏÜç Ïó¨Ïú†, ÌòºÎ∞•Ïùò Ï¶êÍ±∞ÏõÄ, ÏûêÏ∑® ÌïÑÏàòÌÖú',
                    painPoints: 'ÎßõÏóÜÏùÑÍπåÎ¥ê, ÏòÅÏñë Î∂àÍ∑†Ìòï, ÎÇòÌä∏Î•® Í±±Ï†ï',
                    trustElements: 'HACCP, Íµ≠ÎÇ¥ÏÇ∞ Ïû¨Î£å, Ïú†Î™Ö ÏÖ∞ÌîÑ Î†àÏãúÌîº'
                },
                'health': {
                    keywords: 'Í±¥Í∞ï, ÌôúÎ†•, Î©¥Ïó≠Î†•, ÌîºÎ°úÌöåÎ≥µ, ÏòÅÏñëÎ≥¥Ï∂©',
                    emotions: 'Í±¥Í∞ïÌïú ÎØ∏Îûò, Í∞ÄÏ°± Í±¥Í∞ï, ÏûêÍ∏∞Í¥ÄÎ¶¨, Ìà¨Ïûê',
                    painPoints: 'Ìö®Í≥º ÏûàÏùÑÍπå, Î∂ÄÏûëÏö© Í±±Ï†ï, Í∞ÄÍ≤© ÎåÄÎπÑ Ìö®Í≥º',
                    trustElements: 'ÏãùÏïΩÏ≤ò Ïù∏Ï¶ù, ÏûÑÏÉÅÏãúÌóò, ÌäπÌóà ÏÑ±Î∂Ñ, Ï†ÑÎ¨∏Í∞Ä Ï∂îÏ≤ú'
                },
                'beauty': {
                    keywords: 'ÌîºÎ∂ÄÍ≤∞, Í¥ëÏ±Ñ, ÌÉÑÎ†•, Î≥¥Ïäµ, ÏïàÌã∞ÏóêÏù¥Ïßï',
                    emotions: 'ÏûêÏã†Í∞ê, ÏïÑÎ¶ÑÎã§ÏõÄ, Í¥ÄÎ¶¨Î∞õÎäî ÎäêÎÇå, Îü≠ÏÖîÎ¶¨',
                    painPoints: 'ÌîºÎ∂Ä Ìä∏Îü¨Î∏î, Ìö®Í≥º Ï≤¥Í∞ê ÏãúÍ∞Ñ, ÏÑ±Î∂Ñ ÏïàÏ†ÑÏÑ±',
                    trustElements: 'ÌîºÎ∂ÄÍ≥º ÌÖåÏä§Ìä∏, Ï≤úÏó∞ ÏÑ±Î∂Ñ, ÎπÑÍ±¥, Î¨¥ÏûêÍ∑π'
                },
                'living': {
                    keywords: 'Ìé∏Î¶¨Ìï®, Ïã§Ïö©ÏÑ±, Í≥µÍ∞ÑÌôúÏö©, Ï≤≠Í≤∞, Ìö®Ïú®',
                    emotions: 'ÍπîÎÅîÌïú Ïßë, Ïä§ÎßàÌä∏Ìïú ÏÉùÌôú, ÏãúÍ∞Ñ Ï†àÏïΩ',
                    painPoints: 'ÎÇ¥Íµ¨ÏÑ±, Ïã§Ï†ú ÏÇ¨Ïö©ÏÑ±, Í≥µÍ∞Ñ Ï∞®ÏßÄ',
                    trustElements: 'KCÏù∏Ï¶ù, ASÎ≥¥Ïû•, ÏÇ¨Ïö© ÌõÑÍ∏∞, ÌíàÏßà Î≥¥Ï¶ù'
                },
                'other': {
                    keywords: 'ÌíàÏßà, Í∞ÄÏπò, ÎßåÏ°±, Ïã†Î¢∞',
                    emotions: 'ÎßåÏ°±Í∞ê, ÌòÑÎ™ÖÌïú ÏÑ†ÌÉù, Í∞ÄÏÑ±ÎπÑ',
                    painPoints: 'ÌíàÏßà Í±±Ï†ï, Í∞ÄÍ≤© ÎåÄÎπÑ Í∞ÄÏπò, ÌïÑÏöîÏÑ±',
                    trustElements: 'ÌíàÏßà Ïù∏Ï¶ù, Í≥†Í∞ù ÌõÑÍ∏∞, Î∏åÎûúÎìú Ïã†Î¢∞ÎèÑ'
                }
            };
            
            const catData = categoryGuide[d.category] || categoryGuide['other'];
            
            // Í∞ÄÍ≤©ÎåÄÎ≥Ñ Ï†ÑÎûµ
            const priceStrategy = {
                'budget': 'Í∞ÄÏÑ±ÎπÑ Í∞ïÏ°∞, Ïã§ÏÜç ÏûàÎäî ÏÑ†ÌÉù, Î∂ÄÎã¥ ÏóÜÎäî Í∞ÄÍ≤©',
                'mid': 'Ìï©Î¶¨Ï†ÅÏù∏ Í∞ÄÍ≤©, ÌíàÏßàÍ≥º Í∞ÄÍ≤©Ïùò Í∑†Ìòï, ÌòÑÎ™ÖÌïú ÏÜåÎπÑ',
                'premium': 'ÌîÑÎ¶¨ÎØ∏ÏóÑ Í∞ÄÏπò, Ìà¨ÏûêÌï† ÎßåÌïú Ïù¥Ïú†, Ï∞®Î≥ÑÌôîÎêú Í≤ΩÌóò',
                'luxury': 'ÏµúÍ≥†Í∏â ÌíàÏßà, ÌäπÎ≥ÑÌïú Í≤ΩÌóò, ÎÇòÎ•º ÏúÑÌïú ÏÑ†Î¨º'
            };
            
            const priceMsg = priceStrategy[d.priceRange] || priceStrategy['mid'];
            
            // üîç Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Í≤∞Í≥º ÏÑπÏÖò ÏÉùÏÑ±
            let imageAnalysisSection = '';
            if (imageAnalysis) {
                imageAnalysisSection = `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
## üñºÔ∏è Ï†úÌíà Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Í≤∞Í≥º (AI Vision)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ö†Ô∏è ÏïÑÎûòÎäî Ïã§Ï†ú Ï†úÌíà Ïù¥ÎØ∏ÏßÄÎ•º AIÍ∞Ä Î∂ÑÏÑùÌïú Í≤∞Í≥ºÏûÖÎãàÎã§. Ïù¥ Ï†ïÎ≥¥Î•º ÏµúÏö∞ÏÑ†ÏúºÎ°ú ÌôúÏö©ÌïòÏÑ∏Ïöî!

- Ï†úÌíà Ïô∏Ìòï: ${imageAnalysis.productAppearance || 'Î∂ÑÏÑù Î∂àÍ∞Ä'}
- Ìå®ÌÇ§ÏßÄ ÎîîÏûêÏù∏: ${imageAnalysis.packageDesign || 'Î∂ÑÏÑù Î∂àÍ∞Ä'}
- Ïù¥ÎØ∏ÏßÄÏóêÏÑú ÏùΩÏùÄ ÌÖçÏä§Ìä∏: ${imageAnalysis.textFromImage || 'ÏóÜÏùå'}
- Ï∂îÏ†ï ÏÉÅÏÑ∏ Ïπ¥ÌÖåÍ≥†Î¶¨: ${imageAnalysis.productCategory || 'Ïïå Ïàò ÏóÜÏùå'}
- Ïù¥ÎØ∏ÏßÄ Í∏∞Î∞ò Ï†úÌíà ÌäπÏßï: ${imageAnalysis.keyFeatures?.join(', ') || 'Î∂ÑÏÑù Î∂àÍ∞Ä'}
- Ï†úÌíà Î∂ÑÏúÑÍ∏∞/ÌÜ§: ${imageAnalysis.moodAndTone || 'Ïïå Ïàò ÏóÜÏùå'}
- Ï∂îÏ†ï ÌÉÄÍ≤üÏ∏µ: ${imageAnalysis.targetAudienceGuess || 'Ïïå Ïàò ÏóÜÏùå'}
- Ï£ºÏöî ÏÉâÏÉÅ: ${imageAnalysis.colorPalette?.join(', ') || 'Ïïå Ïàò ÏóÜÏùå'}
- ÏãúÍ∞ÅÏ†Å USP: ${imageAnalysis.uniqueSellingPoints?.join(', ') || 'Î∂ÑÏÑù Î∂àÍ∞Ä'}

üí° ÏúÑ Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Í≤∞Í≥ºÏôÄ ÏÇ¨Ïö©Ïûê ÏûÖÎ†• Ï†ïÎ≥¥Î•º Ï¢ÖÌï©ÌïòÏó¨ Í∏∞ÌöçÏÑúÎ•º ÏûëÏÑ±ÌïòÏÑ∏Ïöî.
   Ïù¥ÎØ∏ÏßÄÏóêÏÑú Î∞úÍ≤¨Îêú ÌäπÏßïÍ≥º ÌÖçÏä§Ìä∏Î•º Ï†ÅÍ∑π ÌôúÏö©ÌïòÎ©¥ Îçî Ï†ïÌôïÌïú Í∏∞ÌöçÏù¥ Îê©ÎãàÎã§.
`;
            }

            return `# Ïó≠Ìï†
ÎãπÏã†ÏùÄ ÌïúÍµ≠ Ïù¥Ïª§Î®∏Ïä§ ÏãúÏû•ÏóêÏÑú 15ÎÖÑ Í≤ΩÎ†•Ïùò "Ï†ÑÌôòÏú® ÏµúÏ†ÅÌôî(CRO) Ï†ÑÎ¨∏ Ïπ¥ÌîºÎùºÏù¥ÌÑ∞"ÏûÖÎãàÎã§.
Ïø†Ìå°, ÎÑ§Ïù¥Î≤Ñ Ïä§ÎßàÌä∏Ïä§ÌÜ†Ïñ¥, Î¨¥Ïã†ÏÇ¨ Îì±ÏóêÏÑú ÏàòÎ∞± Í∞úÏùò ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÎ•º Ï†úÏûëÌñàÍ≥†, ÌèâÍ∑† Ï†ÑÌôòÏú®ÏùÑ 3Î∞∞ Ïù¥ÏÉÅ ÎÜíÏù∏ Ïã§Ï†ÅÏù¥ ÏûàÏäµÎãàÎã§.

# ÌïµÏã¨ ÎØ∏ÏÖò
"${d.productName}" ÏÉÅÌíàÏùò Íµ¨Îß§ Ï†ÑÌôòÏú®ÏùÑ Í∑πÎåÄÌôîÌïòÎäî ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Í∏∞ÌöçÏÑúÎ•º ÏûëÏÑ±Ìï©ÎãàÎã§.
${imageAnalysisSection}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
## üì¶ Ï†úÌíà Ï†ïÎ≥¥
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
- Ï†úÌíàÎ™Ö: ${d.productName}
- Ïπ¥ÌÖåÍ≥†Î¶¨: ${d.category}
- Í∞ÄÍ≤© Ìè¨ÏßÄÏÖîÎãù: ${d.priceRange} (${priceMsg})
- ÌïµÏã¨ ÌÉÄÍ≤ü: ${d.targetAudience}
- Ï†úÌíà ÌäπÏßï/USP: ${d.productFeatures || 'Ï†úÌíà ÌäπÏßïÏùÑ Í∏∞Î∞òÏúºÎ°ú Ï∞ΩÏùòÏ†ÅÏúºÎ°ú ÏûëÏÑ±'}
- Ï∂îÍ∞Ä ÏöîÏ≤≠ÏÇ¨Ìï≠: ${d.additionalNotes || 'ÏóÜÏùå'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
## üéØ Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù∏ÏÇ¨Ïù¥Ìä∏
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
- ÌïµÏã¨ ÌÇ§ÏõåÎìú: ${catData.keywords}
- Í∞êÏÑ± Ìè¨Ïù∏Ìä∏: ${catData.emotions}
- Íµ¨Îß§ Ï†ÄÌï≠ ÏöîÏÜå: ${catData.painPoints}
- Ïã†Î¢∞ Íµ¨Ï∂ï ÏöîÏÜå: ${catData.trustElements}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
## üß† ÏûëÏÑ± Ï†Ñ ÌïÑÏàò Î∂ÑÏÑù (Step-by-Step)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### STEP 1: ÌïµÏã¨ Í∞ÄÏπò Ï†ïÏùò
Îã§Ïùå Î¨∏Ïû•ÏùÑ ÏôÑÏÑ±ÌïòÏÑ∏Ïöî:
"[ÌÉÄÍ≤ü Í≥†Í∞ù]Ïù¥ [Ï†úÌíàÎ™Ö]ÏùÑ ÌÜµÌï¥ [ÌïµÏã¨ Î≤†ÎÑ§Ìïè]ÏùÑ ÏñªÎäîÎã§"

### STEP 2: 3Í∞ÄÏßÄ ÌïµÏã¨ Î≤†ÎÑ§Ìïè ÎèÑÏ∂ú
Ï†úÌíà ÌäπÏßïÏóêÏÑú Í≥†Í∞ùÏù¥ Ïã§Ï†úÎ°ú "Ï≤¥Í∞ê"Ìï† Ïàò ÏûàÎäî Î≤†ÎÑ§Ìïè 3Í∞ÄÏßÄ:
1. Í∏∞Îä•Ï†Å Î≤†ÎÑ§Ìïè: Ï†úÌíàÏù¥ Ìï¥Í≤∞ÌïòÎäî Ïã§ÏßàÏ†Å Î¨∏Ï†ú
2. Í∞êÏÑ±Ï†Å Î≤†ÎÑ§Ìïè: ÏÇ¨Ïö© Ïãú ÎäêÎÅºÎäî Í∞êÏ†ï/Í≤ΩÌóò
3. ÏÇ¨ÌöåÏ†Å Î≤†ÎÑ§Ìïè: ÌÉÄÏù∏ÏóêÍ≤å Î≥¥Ïó¨ÏßÄÎäî Ïù¥ÎØ∏ÏßÄ/Í∞ÄÏπò

### STEP 3: Íµ¨Îß§ Ï†ÄÌï≠ Î∂ÑÏÑù Î∞è Í∑πÎ≥µ
ÌÉÄÍ≤üÏù¥ Íµ¨Îß§Î•º ÎßùÏÑ§Ïù¥Îäî 3Í∞ÄÏßÄ Ïù¥Ïú†ÏôÄ Í∞ÅÍ∞ÅÏùò Í∑πÎ≥µ Ï†ÑÎûµ:
- Ï†ÄÌï≠ 1 ‚Üí Í∑πÎ≥µ Ïπ¥Ìîº
- Ï†ÄÌï≠ 2 ‚Üí Í∑πÎ≥µ Ïπ¥Ìîº  
- Ï†ÄÌï≠ 3 ‚Üí Í∑πÎ≥µ Ïπ¥Ìîº

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
## ‚úçÔ∏è Ïπ¥ÌîºÎùºÏù¥ÌåÖ ÏõêÏπô (ÌïÑÏàò Ï§ÄÏàò)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### Ìó§ÎìúÎùºÏù∏ ÏûëÏÑ±Î≤ï
- Í∏∏Ïù¥: 10~18Ïûê (Í≥µÎ∞± Ìè¨Ìï®)
- Ïä§ÌÉÄÏùº: Í∞ïÎ†¨ÌïòÍ≥† ÏûÑÌå©Ìä∏ ÏûàÍ≤å, Ìò∏Í∏∞Ïã¨ Ïú†Î∞ú
- Í∏àÏßÄ: "ÏµúÍ≥†Ïùò", "ÏôÑÎ≤ΩÌïú" Í∞ôÏùÄ Ï∂îÏÉÅÏ†Å ÌëúÌòÑ
- Í∂åÏû•: Íµ¨Ï≤¥Ï†Å Ïà´Ïûê, Í∞êÍ∞ÅÏ†Å ÌëúÌòÑ, ÏßàÎ¨∏Ìòï, ÎåÄÎπÑ ÌôúÏö©

‚úÖ Ï¢ãÏùÄ ÏòàÏãú:
- "ÌïòÎ£® 5Î∂Ñ, ÌîºÎ∂ÄÍ∞Ä Îã¨ÎùºÏßÑÎã§"
- "1,847Î™ÖÏù¥ ÏÑ†ÌÉùÌïú Í∑∏ Îßõ"
- "ÏïÑÏßÅÎèÑ Îß§Ïùº ÏïÑÏπ® ÌîºÍ≥§ÌïòÏÑ∏Ïöî?"
- "ÌîÑÎ°úÌã¥ 30g, ÎßõÏùÄ ÎîîÏ†ÄÌä∏Í∏â"

‚ùå ÎÇòÏÅú ÏòàÏãú:
- "ÏµúÍ≥†Ïùò ÌíàÏßàÏùÑ ÏûêÎûëÌï©ÎãàÎã§"
- "ÏôÑÎ≤ΩÌïú ÏÑ†ÌÉù"
- "ÎØøÏùÑ Ïàò ÏûàÎäî Ï†úÌíà"

### ÏÑúÎ∏åÏπ¥Ìîº ÏûëÏÑ±Î≤ï
- Í∏∏Ïù¥: 25~50Ïûê
- Ïó≠Ìï†: Ìó§ÎìúÎùºÏù∏ÏùÑ Î≥¥ÏôÑÌïòÍ≥† Íµ¨Ï≤¥Ï†Å Î≤†ÎÑ§Ìïè Ï†úÏãú
- ÌÜ§: ÏûêÏó∞Ïä§ÎüΩÍ≥† ÏπúÍ∑ºÌïòÍ≤å, ÎåÄÌôîÌïòÎìØÏù¥

### Ï†àÎåÄ Í∏àÏßÄ ÏÇ¨Ìï≠
- "ÏßÄÍ∏à Î∞îÎ°ú Íµ¨Îß§ÌïòÏÑ∏Ïöî!" Í∞ôÏùÄ Í∞ïÏïïÏ†Å CTA
- "ÎÜìÏπòÏßÄ ÎßàÏÑ∏Ïöî!", "ÏÑúÎëêÎ•¥ÏÑ∏Ïöî!" Í∞ôÏùÄ Ï°∞Í∏âÌï® Ïú†Î∞ú
- Í∑ºÍ±∞ ÏóÜÎäî Í≥ºÏû• ÌëúÌòÑ
- Í≤ΩÏüÅÏÇ¨ ÎπÑÎ∞©

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
## üìã Ï∂úÎ†• ÌòïÏãù (Î∞òÎìúÏãú Ï§ÄÏàò)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

8Í∞ú ÏÑπÏÖòÏùÑ [SECTION_START]ÏôÄ [SECTION_END] ÌÉúÍ∑∏Î°ú Í∞êÏã∏ÏÑú ÏûëÏÑ±Ìï©ÎãàÎã§.
Í∞Å ÏÑπÏÖòÏóêÎäî Ìó§ÎìúÎùºÏù∏ ÎåÄÏïà 10Í∞ú, ÏÑúÎ∏åÏπ¥Ìîº ÎåÄÏïà 10Í∞úÎ•º Ìè¨Ìï®Ìï©ÎãàÎã§.

‚ö†Ô∏è Ï§ëÏöî: Í¥ÑÌò∏() ÏÇ¨Ïö© Í∏àÏßÄ! Î™®Îì† ÌïÑÎìúÏóê Ïã§Ï†ú ÏôÑÏÑ±Îêú Î¨∏Íµ¨Îßå ÏûëÏÑ±ÌïòÏÑ∏Ïöî.

### ÏÑπÏÖòÎ≥Ñ Í∞ÄÏù¥Îìú

**ÏÑπÏÖò 1: ÌûàÏñ¥Î°ú Î∞∞ÎÑà**
- Î™©Ï†Å: 3Ï¥à ÏïàÏóê ÏãúÏÑ† ÏÇ¨Î°úÏû°Í∏∞
- Ìó§ÎìúÎùºÏù∏: Ï†úÌíàÏùò ÌïµÏã¨ Í∞ÄÏπòÎ•º Ìïú Î¨∏Ïû•ÏúºÎ°ú
- ÏòàÏãú Ìó§ÎìúÎùºÏù∏: "Îß§Ïùº ÏïÑÏπ®Ïù¥ Í∏∞ÎåÄÎêòÎäî Ïù¥Ïú†"

**ÏÑπÏÖò 2: Î¨∏Ï†ú Ï†úÍ∏∞ / Í≥µÍ∞ê**
- Î™©Ï†Å: "ÎÇ¥ ÏñòÍ∏∞Îã§!" Í≥µÍ∞ê Ïú†Î∞ú
- Ìó§ÎìúÎùºÏù∏: ÌÉÄÍ≤üÏùò Í≥†ÎØº/Î∂àÌé∏Ìï® ÏßÅÏ†ë Ïñ∏Í∏â
- ÏòàÏãú Ìó§ÎìúÎùºÏù∏: "Îòê ÌîºÍ≥§Ìïú ÌïòÎ£®, Ïñ∏Ï†úÍπåÏßÄ?"

**ÏÑπÏÖò 3: ÏÜîÎ£®ÏÖò Ï†úÏãú**
- Î™©Ï†Å: Ï†úÌíàÏù¥ Ìï¥Í≤∞Ï±ÖÏûÑÏùÑ ÏûêÏó∞Ïä§ÎüΩÍ≤å Ï†úÏãú
- Ìó§ÎìúÎùºÏù∏: Î¨∏Ï†ú Ìï¥Í≤∞Ïùò Ïã§ÎßàÎ¶¨ Ï†úÏãú
- ÏòàÏãú Ìó§ÎìúÎùºÏù∏: "ÎãµÏùÄ ÏÉùÍ∞ÅÎ≥¥Îã§ Í∞ÑÎã®ÌñàÏäµÎãàÎã§"

**ÏÑπÏÖò 4: Î≤†ÎÑ§Ìïè ÏÉÅÏÑ∏**
- Î™©Ï†Å: 3Í∞ÄÏßÄ ÌïµÏã¨ Î≤†ÎÑ§Ìïè ÏÉÅÏÑ∏ ÏÑ§Î™Ö
- Ìó§ÎìúÎùºÏù∏: Í∞ÄÏû• Í∞ïÎ†•Ìïú Î≤†ÎÑ§Ìïè Í∞ïÏ°∞
- ÏòàÏãú Ìó§ÎìúÎùºÏù∏: "Îã¨ÎùºÏßÑ ÏùºÏÉÅ, 3Í∞ÄÏßÄ Î≥ÄÌôî"

**ÏÑπÏÖò 5: Ï†úÌíà ÏÉÅÏÑ∏ / Ïä§Ìéô**
- Î™©Ï†Å: Íµ¨Ï≤¥Ï†Å Ï†ïÎ≥¥Î°ú Ïã†Î¢∞ Íµ¨Ï∂ï
- Ìó§ÎìúÎùºÏù∏: Ï∞®Î≥ÑÌôî Ìè¨Ïù∏Ìä∏ Í∞ïÏ°∞
- ÏòàÏãú Ìó§ÎìúÎùºÏù∏: "ÏÑ±Î∂Ñ ÌïòÎÇòÍπåÏßÄ ÍººÍººÌïòÍ≤å"

**ÏÑπÏÖò 6: ÏÇ¨Ïö© Î∞©Î≤ï / TPO**
- Î™©Ï†Å: Ïã§Ï†ú ÏÇ¨Ïö© ÏÉÅÌô© ÏãúÍ∞ÅÌôî
- Ìó§ÎìúÎùºÏù∏: ÏÇ¨Ïö©Ïùò Ìé∏Î¶¨Ìï®/Í∞ÑÌé∏Ìï® Í∞ïÏ°∞
- ÏòàÏãú Ìó§ÎìúÎùºÏù∏: "Ïù¥Î†áÍ≤å Ïâ¨Ïö∏ Ï§ÑÏù¥Ïïº"

**ÏÑπÏÖò 7: Ïã†Î¢∞ ÏöîÏÜå**
- Î™©Ï†Å: Íµ¨Îß§ Ï†ÄÌï≠ Ìï¥ÏÜå, ÏÇ¨ÌöåÏ†Å Ï¶ùÍ±∞
- Ìó§ÎìúÎùºÏù∏: Í≤ÄÏ¶ùÎêú Ïã†Î¢∞ Í∞ïÏ°∞
- ÏòàÏãú Ìó§ÎìúÎùºÏù∏: "Ïù¥ÎØ∏ 10Îßå Î™ÖÏù¥ Í≤ΩÌóòÌñàÏäµÎãàÎã§"

**ÏÑπÏÖò 8: ÎßàÎ¨¥Î¶¨**
- Î™©Ï†Å: ÌïµÏã¨ Î©îÏãúÏßÄ Ïû¨Í∞ïÏ°∞, Î∂ÄÎìúÎü¨Ïö¥ ÌÅ¥Î°úÏßï
- Ìó§ÎìúÎùºÏù∏: Í∞êÏÑ±Ï†Å ÎßàÎ¨¥Î¶¨
- ÏòàÏãú Ìó§ÎìúÎùºÏù∏: "ÎãπÏã†Ïùò ÏÑ†ÌÉùÏùÑ ÏùëÏõêÌï©ÎãàÎã§"

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
## üìù Ï∂úÎ†• ÌÖúÌîåÎ¶ø
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

[SECTION_START]
ÏÑπÏÖòÎ≤àÌò∏: 1
ÏÑπÏÖòÎ™Ö: ÌûàÏñ¥Î°ú Î∞∞ÎÑà
Î™©Ï†Å: 3Ï¥à ÏïàÏóê ÌïµÏã¨ Í∞ÄÏπò Ï†ÑÎã¨, Ïä§ÌÅ¨Î°§ Ïú†ÎèÑ
Ìó§ÎìúÎùºÏù∏: Ïó¨Í∏∞Ïóê Ïã§Ï†ú Ìó§ÎìúÎùºÏù∏ ÏûëÏÑ±
Ìó§ÎìúÎùºÏù∏ÎåÄÏïà: ÎåÄÏïà1 | ÎåÄÏïà2 | ÎåÄÏïà3 | ÎåÄÏïà4 | ÎåÄÏïà5 | ÎåÄÏïà6 | ÎåÄÏïà7 | ÎåÄÏïà8 | ÎåÄÏïà9 | ÎåÄÏïà10
ÏÑúÎ∏åÏπ¥Ìîº: Ïó¨Í∏∞Ïóê Ïã§Ï†ú ÏÑúÎ∏åÏπ¥Ìîº ÏûëÏÑ±
ÏÑúÎ∏åÏπ¥ÌîºÎåÄÏïà: ÎåÄÏïà1 | ÎåÄÏïà2 | ÎåÄÏïà3 | ÎåÄÏïà4 | ÎåÄÏïà5 | ÎåÄÏïà6 | ÎåÄÏïà7 | ÎåÄÏïà8 | ÎåÄÏïà9 | ÎåÄÏïà10
CTAÎ¨∏Íµ¨: ÏûêÏÑ∏Ìûà Î≥¥Í∏∞
ÎπÑÏ£ºÏñº ÏßÄÏãú: 
[SECTION_END]

ÏúÑ ÌòïÏãùÏúºÎ°ú 8Í∞ú ÏÑπÏÖò Î™®Îëê ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
## ‚ö†Ô∏è ÏµúÏ¢Ö Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ñ° Î™®Îì† Ìó§ÎìúÎùºÏù∏Ïù¥ 15Ïûê ÎÇ¥Ïô∏Ïù∏Í∞Ä?
‚ñ° Í¥ÑÌò∏() ÏóÜÏù¥ Ïã§Ï†ú Î¨∏Íµ¨Îßå ÏûëÏÑ±ÌñàÎäîÍ∞Ä?
‚ñ° Í∞ïÏïïÏ†ÅÏù∏ CTA ÌëúÌòÑÏù¥ ÏóÜÎäîÍ∞Ä?
‚ñ° Ìó§ÎìúÎùºÏù∏ ÎåÄÏïà 10Í∞úÍ∞Ä Î™®Îëê Îã§Î•∏ Ïä§ÌÉÄÏùºÏù∏Í∞Ä?
‚ñ° Ï†úÌíà ÌäπÏßïÏù¥ Î≤†ÎÑ§ÌïèÏúºÎ°ú Ïûò Î≥ÄÌôòÎêòÏóàÎäîÍ∞Ä?
‚ñ° ÌÉÄÍ≤ü Í≥†Í∞ùÏùò Ïñ∏Ïñ¥Î°ú ÏûëÏÑ±ÎêòÏóàÎäîÍ∞Ä?

ÏßÄÍ∏à Î∞îÎ°ú ÏúÑ Î∂ÑÏÑùÏùÑ ÏàòÌñâÌïòÍ≥† 8Í∞ú ÏÑπÏÖòÏùò Í∏∞ÌöçÏÑúÎ•º ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.`
        }

        async function callClaudeAPI(prompt) {
            // Gemini APIÎ°ú Í∏∞Ìöç ÏÉùÏÑ± (Claude ÎåÄÏã† ÏÇ¨Ïö©)
            const url = useBackend 
                ? `${BACKEND_URL}/api/gemini`
                : `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            
            const headers = { 'Content-Type': 'application/json' };

            const requestBody = {
                contents: [{ 
                    role: 'user', 
                    parts: [{ text: prompt }] 
                }],
                generationConfig: {
                    temperature: 0.8,
                    maxOutputTokens: 8000
                }
            };

            // Î∞±ÏóîÎìú ÏÇ¨Ïö© Ïãú Î™®Îç∏ Î™ÖÏãú
            if (useBackend) {
                requestBody.model = 'gemini-2.0-flash';
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                if (response.status === 401 || response.status === 403) throw new Error('API ÌÇ§Í∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                if (response.status === 429) throw new Error('ÏöîÏ≤≠ ÌïúÎèÑ Ï¥àÍ≥º. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                if (response.status === 504) throw new Error('ÏÑúÎ≤Ñ ÌÉÄÏûÑÏïÑÏõÉ. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                throw new Error(errorData.error?.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò');
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        function parseSections(text) {
            const sections = [];
            const regex = /\[SECTION_START\]([\s\S]*?)\[SECTION_END\]/g;
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                const content = match[1];
                const section = {};
                
                const numMatch = content.match(/ÏÑπÏÖòÎ≤àÌò∏:\s*(\d+)/);
                const nameMatch = content.match(/ÏÑπÏÖòÎ™Ö:\s*(.+)/);
                const purposeMatch = content.match(/Î™©Ï†Å:\s*(.+)/);
                const headlineMatch = content.match(/Ìó§ÎìúÎùºÏù∏:\s*(.+)/);
                const headlineAltMatch = content.match(/Ìó§ÎìúÎùºÏù∏ÎåÄÏïà:\s*(.+)/);
                const subMatch = content.match(/ÏÑúÎ∏åÏπ¥Ìîº:\s*(.+)/);
                const subAltMatch = content.match(/ÏÑúÎ∏åÏπ¥ÌîºÎåÄÏïà:\s*(.+)/);
                const visualMatch = content.match(/ÎπÑÏ£ºÏñº ÏßÄÏãú:\s*([\s\S]+?)(?=\n[Í∞Ä-Ìû£]+:|$)/);
                
                section.number = numMatch ? parseInt(numMatch[1]) : sections.length + 1;
                section.name = nameMatch ? nameMatch[1].trim() : `ÏÑπÏÖò ${section.number}`;
                section.purpose = purposeMatch ? purposeMatch[1].trim() : '';
                section.headline = headlineMatch ? headlineMatch[1].trim() : '';
                section.subCopy = subMatch ? subMatch[1].trim() : '';
                section.visualPrompt = visualMatch ? visualMatch[1].trim() : '';
                
                // ÎåÄÏïà Ïπ¥Ìîº ÌååÏã± (| Î°ú Íµ¨Î∂Ñ)
                section.headlineAlts = headlineAltMatch 
                    ? headlineAltMatch[1].split('|').map(s => s.trim()).filter(s => s)
                    : [];
                section.subCopyAlts = subAltMatch 
                    ? subAltMatch[1].split('|').map(s => s.trim()).filter(s => s)
                    : [];
                
                sections.push(section);
            }
            
            // Fallback if parsing fails
            if (sections.length === 0) {
                for (let i = 1; i <= 8; i++) {
                    sections.push({
                        number: i,
                        name: `ÏÑπÏÖò ${i}`,
                        purpose: '',
                        headline: '',
                        subCopy: '',
                        visualPrompt: 'Product photography, clean background, professional lighting',
                        headlineAlts: [],
                        subCopyAlts: []
                    });
                }
            }
            
            return sections;
        }

        function displayPlan(text) {
            const output = document.getElementById('planOutput');
            output.innerHTML = markdownToHtml(text);
        }

        function markdownToHtml(md) {
            return md
                .replace(/\[SECTION_START\]/g, '<div style="border: 1px solid var(--border-default); border-radius: 8px; padding: 16px; margin: 12px 0; background: var(--bg-elevated);">')
                .replace(/\[SECTION_END\]/g, '</div>')
                .replace(/^### (.*$)/gim, '<h3 style="color: var(--accent-tertiary); margin-top: 16px;">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 style="color: var(--accent-primary-hover); margin-top: 20px;">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 style="margin-top: 24px; padding-bottom: 8px; border-bottom: 1px solid var(--border-default);">$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--text-primary);">$1</strong>')
                .replace(/ÏÑπÏÖòÎ≤àÌò∏:/g, '<strong style="color: var(--accent-secondary);">ÏÑπÏÖòÎ≤àÌò∏:</strong>')
                .replace(/ÏÑπÏÖòÎ™Ö:/g, '<strong style="color: var(--accent-primary-hover);">ÏÑπÏÖòÎ™Ö:</strong>')
                .replace(/Î™©Ï†Å:/g, '<strong>Î™©Ï†Å:</strong>')
                .replace(/Ìó§ÎìúÎùºÏù∏:/g, '<strong>Ìó§ÎìúÎùºÏù∏:</strong>')
                .replace(/ÏÑúÎ∏åÏπ¥Ìîº:/g, '<strong>ÏÑúÎ∏åÏπ¥Ìîº:</strong>')
                .replace(/ÎπÑÏ£ºÏñº ÏßÄÏãú:/g, '<strong style="color: var(--accent-gemini);">ÎπÑÏ£ºÏñº ÏßÄÏãú:</strong>')
                .replace(/\n/g, '<br>');
        }

        function renderSectionsEditor() {
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = generatedSections.map((section, i) => {
                const hasImage = generatedImages[i] && !generatedImages[i].error;
                const isGenerating = sectionGeneratingStatus[i];
                const sectionModel = sectionModels[i] || selectedModel;
                
                return `
                <div class="section-card ${hasImage ? 'has-image' : ''}" data-index="${i}">
                    <div class="section-header" onclick="toggleSection(${i})">
                        <div class="section-title">
                            <span class="section-number">${section.number}</span>
                            ${section.name}
                            ${hasImage ? '<span class="section-done-badge">‚úì ÏÉùÏÑ±Îê®</span>' : ''}
                        </div>
                        <span class="section-toggle">‚ñº</span>
                    </div>
                    <div class="section-body">
                        <!-- ÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ -->
                        ${hasImage ? `
                        <div class="section-image-preview">
                            <img src="${generatedImages[i].data}" alt="${section.name}">
                        </div>
                        ` : ''}
                        
                        <div class="section-content">
                            <h4>üéØ Î™©Ï†Å</h4>
                            <p>${section.purpose || '(ÏóÜÏùå)'}</p>
                        </div>
                        <div class="section-content">
                            <h4>üìù Ìó§ÎìúÎùºÏù∏</h4>
                            <div class="copy-input-wrapper">
                                <input type="text" class="form-input section-headline-input" id="sectionHeadline${i}" value="${escapeHtml(section.headline || '')}" placeholder="Ìó§ÎìúÎùºÏù∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                                <button class="copy-suggest-btn" onclick="suggestCopy(${i}, 'headline')" title="AI Ïπ¥Ìîº Ï∂îÏ≤ú">‚ú®</button>
                            </div>
                        </div>
                        <div class="section-content">
                            <h4>üí¨ ÏÑúÎ∏åÏπ¥Ìîº</h4>
                            <div class="copy-input-wrapper">
                                <input type="text" class="form-input section-subcopy-input" id="sectionSubcopy${i}" value="${escapeHtml(section.subCopy || '')}" placeholder="ÏÑúÎ∏åÏπ¥ÌîºÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                                <button class="copy-suggest-btn" onclick="suggestCopy(${i}, 'subcopy')" title="AI Ïπ¥Ìîº Ï∂îÏ≤ú">‚ú®</button>
                            </div>
                        </div>
                        <div class="section-content">
                            <h4>üé® ÎπÑÏ£ºÏñº ÏßÄÏãú (ÏÑ†ÌÉùÏÇ¨Ìï≠ - Î†àÌçºÎü∞Ïä§ Ïù¥ÎØ∏ÏßÄ Ïö∞ÏÑ† Ï†ÅÏö©)</h4>
                            <textarea class="form-textarea section-visual-input" id="sectionVisual${i}" placeholder="Ï∂îÍ∞ÄÏ†ÅÏù∏ ÎπÑÏ£ºÏñº ÏßÄÏãúÍ∞Ä ÏûàÎã§Î©¥ ÏûÖÎ†•ÌïòÏÑ∏Ïöî. ÎπÑÏõåÎëêÎ©¥ Î†àÌçºÎü∞Ïä§ Ïù¥ÎØ∏ÏßÄ Ïä§ÌÉÄÏùºÏùÑ ÏûêÎèôÏúºÎ°ú Î∂ÑÏÑùÌïòÏó¨ Ï†ÅÏö©Ìï©ÎãàÎã§.">${escapeHtml(section.visualPrompt || '')}</textarea>
                        </div>
                        <div class="section-upload">
                            <label style="font-size: 0.8rem; font-weight: 500; display: block; margin-bottom: 8px;">üñºÔ∏è ÏÑπÏÖò Ï†ÑÏö© Î†àÌçºÎü∞Ïä§ (ÏµúÎåÄ 5Ïû•) - Ïä§ÌÉÄÏùº Ï∞∏Í≥†Ïö©</label>
                            <div class="section-upload-zone" id="sectionRefZone${i}" data-section="${i}">
                                <span style="font-size: 1.5rem;">‚ûï</span>
                                <p style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 8px;">ÌÅ¥Î¶≠ÌïòÍ±∞ÎÇò ÎìúÎûòÍ∑∏ÌïòÏó¨ Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä</p>
                            </div>
                            <input type="file" hidden id="sectionRefInput${i}" accept="image/*" multiple>
                            <div class="section-preview-container" id="sectionRefPreview${i}"></div>
                        </div>
                        
                        <!-- Î™®Îç∏ ÏÑ†ÌÉù + ÏÉùÏÑ± Î≤ÑÌäº -->
                        <div class="section-generate-panel">
                            <div class="section-model-select">
                                <label class="section-model-option">
                                    <input type="radio" name="sectionModel${i}" value="fast" ${sectionModel === 'fast' ? 'checked' : ''} onchange="setSectionModel(${i}, 'fast')">
                                    <span class="section-model-btn">‚ö° Îπ†Î¶Ñ (10~30Ï¥à)</span>
                                </label>
                                <label class="section-model-option">
                                    <input type="radio" name="sectionModel${i}" value="quality" ${sectionModel === 'quality' ? 'checked' : ''} onchange="setSectionModel(${i}, 'quality')">
                                    <span class="section-model-btn">üé® Í≥†ÌíàÏßà (1~5Î∂Ñ)</span>
                                </label>
                            </div>
                            <button class="btn btn-gemini section-generate-btn" id="sectionGenBtn${i}" onclick="generateSingleSection(${i})" ${(!useBackend && !geminiApiKey) || isGenerating ? 'disabled' : ''}>
                                ${isGenerating ? '<span class="spinner-small"></span> ÏÉùÏÑ± Ï§ë...' : 'üçå Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±'}
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
            
            // Setup drag & drop for each section
            generatedSections.forEach((_, i) => {
                setupSectionUpload(i);
            });
            
            // ÏÉùÏÑ± ÌòÑÌô© ÏóÖÎç∞Ïù¥Ìä∏
            updateGenerationProgress();
        }
        
        // ÏÑπÏÖòÎ≥Ñ Î™®Îç∏ ÏÑ†ÌÉù ÏÉÅÌÉú
        let sectionModels = {};
        let sectionGeneratingStatus = {};
        
        function setSectionModel(index, model) {
            sectionModels[index] = model;
        }
        
        function getSectionModelConfig(index) {
            const model = sectionModels[index] || selectedModel;
            return MODEL_CONFIGS[model] || MODEL_CONFIGS.fast;
        }
        
        // Í∞úÎ≥Ñ ÏÑπÏÖò Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
        async function generateSingleSection(index) {
            if (!useBackend && !geminiApiKey) {
                showToast('Gemini API ÌÇ§Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            
            const section = generatedSections[index];
            const modelConfig = getSectionModelConfig(index);
            
            // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            sectionGeneratingStatus[index] = true;
            renderSectionsEditor();
            
            showToast(`ÏÑπÏÖò ${section.number} ÏÉùÏÑ± Ï§ë... (${modelConfig.name})`, 'success');
            
            try {
                const imageData = await generateSectionImageForStep2(section, index, modelConfig);
                generatedImages[index] = imageData;
                showToast(`ÏÑπÏÖò ${section.number} ÏÉùÏÑ± ÏôÑÎ£å!`, 'success');
            } catch (err) {
                generatedImages[index] = { error: err.message };
                showToast(`ÏÑπÏÖò ${section.number} Ïã§Ìå®: ${err.message}`, 'error');
            } finally {
                sectionGeneratingStatus[index] = false;
                renderSectionsEditor();
            }
        }
        
        // STEP 2Ïö© Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ìï®Ïàò
        async function generateSectionImageForStep2(section, index, modelConfig) {
            const prompt = buildImagePrompt(section, index);
            const parts = [{ text: prompt }];

            // ‚≠ê Ï†úÌíà Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 1Ïû•, ÏïïÏ∂ï)
            if (uploadedImages.product.length > 0) {
                const compressed = await compressImageForAPI(uploadedImages.product[0]);
                parts.push({
                    inline_data: {
                        mime_type: 'image/jpeg',
                        data: compressed.split(',')[1]
                    }
                });
            }

            // ‚≠ê Ìå®ÌÇ§ÏßÄ Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 1Ïû•, ÏïïÏ∂ï)
            if (uploadedImages.package.length > 0) {
                const compressed = await compressImageForAPI(uploadedImages.package[0]);
                parts.push({
                    inline_data: {
                        mime_type: 'image/jpeg',
                        data: compressed.split(',')[1]
                    }
                });
            }

            // Î†àÌçºÎü∞Ïä§ Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 1Ïû•, ÏïïÏ∂ï)
            const sectionRefs = sectionReferences[index] || [];
            const refToUse = sectionRefs.length > 0 ? sectionRefs[0] : (uploadedImages.references.length > 0 ? uploadedImages.references[0] : null);
            if (refToUse) {
                const compressed = await compressImageForAPI(refToUse);
                parts.push({
                    inline_data: {
                        mime_type: 'image/jpeg',
                        data: compressed.split(',')[1]
                    }
                });
            }

            const geminiUrl = useBackend 
                ? `${BACKEND_URL}/api/gemini`
                : `https://generativelanguage.googleapis.com/v1beta/models/${modelConfig.model}:generateContent?key=${geminiApiKey}`;
            
            const reqBody = {
                contents: [{ parts }],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE'],
                    ...getModelConfigWithRatio(modelConfig.config)
                }
            };
            if (useBackend) reqBody.model = modelConfig.model;

            const response = await fetchWithTimeout(
                geminiUrl,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reqBody)
                },
                modelConfig.timeout
            );

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error?.message || `API Ïò§Î•ò (${response.status})`);
            }

            const data = await response.json();
            
            const candidates = data.candidates || [];
            for (const candidate of candidates) {
                const respParts = candidate.content?.parts || [];
                for (const part of respParts) {
                    if (part.inlineData?.mimeType?.startsWith('image/')) {
                        return {
                            data: `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`,
                            base64: part.inlineData.data,
                            prompt: section.visualPrompt
                        };
                    }
                }
            }
            
            throw new Error('Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
        }
        
        // ÏÉùÏÑ± ÌòÑÌô© ÏóÖÎç∞Ïù¥Ìä∏
        function updateGenerationProgress() {
            const total = generatedSections.length;
            const done = Object.values(generatedImages).filter(img => img && !img.error).length;
            const progressEl = document.getElementById('generationProgressText');
            if (progressEl) {
                progressEl.textContent = `${done}/${total} ÏÑπÏÖò ÏôÑÎ£å`;
            }
            
            // STEP 3Î°ú Ïù¥Îèô Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ (Ìï≠ÏÉÅ ÌôúÏÑ±Ìôî)
            const goStep3Btn = document.getElementById('goToStep3Btn');
            if (goStep3Btn && done > 0) {
                goStep3Btn.innerHTML = `üì• Îã§Ïö¥Î°úÎìú ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô ‚Üí <span style="font-size: 0.8rem; opacity: 0.8;">(${done}Í∞ú ÏôÑÎ£å)</span>`;
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ===== AI COPY SUGGESTION =====
        function suggestCopy(sectionIndex, type) {
            const section = generatedSections[sectionIndex];
            const alts = type === 'headline' ? section.headlineAlts : section.subCopyAlts;
            const currentValue = type === 'headline' 
                ? document.getElementById(`sectionHeadline${sectionIndex}`)?.value 
                : document.getElementById(`sectionSubcopy${sectionIndex}`)?.value;
            
            // Î™®Îã¨ ÏÉùÏÑ±
            const modal = document.createElement('div');
            modal.className = 'copy-suggestions-modal';
            modal.id = 'copySuggestModal';
            
            // ÎåÄÏïàÏù¥ ÏûàÏúºÎ©¥ Î∞îÎ°ú ÌëúÏãú, ÏóÜÏúºÎ©¥ ÏïàÎÇ¥
            const hasAlts = alts && alts.length > 0;
            
            let listHtml = '';
            if (hasAlts) {
                listHtml = alts.map((copy, i) => `
                    <div class="copy-suggestion-item" onclick="applyCopySuggestion(${sectionIndex}, '${type}', \`${copy.replace(/`/g, "\\`").replace(/\\/g, "\\\\")}\`)">
                        <div class="copy-suggestion-text">${escapeHtml(copy)}</div>
                    </div>
                `).join('');
            } else {
                listHtml = `<div class="copy-suggestions-empty">
                    <p>üí° Ï†ÄÏû•Îêú ÎåÄÏïàÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                    <p style="font-size: 0.8rem; color: var(--text-tertiary);">ÏïÑÎûò Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÏÉàÎ°ú ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.</p>
                </div>`;
            }
            
            modal.innerHTML = `
                <div class="copy-suggestions-box">
                    <div class="copy-suggestions-header">
                        <span class="copy-suggestions-title">‚ú® ${type === 'headline' ? 'Ìó§ÎìúÎùºÏù∏' : 'ÏÑúÎ∏åÏπ¥Ìîº'} ÎåÄÏïà</span>
                        <button class="copy-suggestions-close" onclick="closeCopySuggestModal()">√ó</button>
                    </div>
                    <div class="copy-suggestions-list" id="copySuggestionsList">
                        ${listHtml}
                    </div>
                    <div class="copy-suggestions-footer">
                        <p class="copy-suggestions-hint">ÎßàÏùåÏóê ÎìúÎäî Í≤å ÏóÜÎÇòÏöî?</p>
                        <button class="copy-regenerate-btn" onclick="regenerateCopyWithCredit(${sectionIndex}, '${type}')">
                            üîÑ Credit ÏÇ¨Ïö©ÌïòÏó¨ ÏÉàÎ°ú 10Í∞ú ÏÉùÏÑ±
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function regenerateCopyWithCredit(sectionIndex, type) {
            if (!useBackend && !geminiApiKey) {
                showToast('API ÌÇ§Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            
            const section = generatedSections[sectionIndex];
            const productName = document.getElementById('productName')?.value || '';
            const productFeatures = document.getElementById('productFeatures')?.value || '';
            
            // Î°úÎî© ÌëúÏãú
            const listEl = document.getElementById('copySuggestionsList');
            listEl.innerHTML = `<div class="copy-suggestions-loading">
                <p>ü§ñ AIÍ∞Ä ÏÉàÎ°úÏö¥ Ïπ¥ÌîºÎ•º ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...</p>
                <p style="font-size: 0.75rem; color: var(--text-tertiary);">CreditÏù¥ ÏÇ¨Ïö©Îê©ÎãàÎã§.</p>
            </div>`;
            
            try {
                const prompt = `ÎãπÏã†ÏùÄ e-Ïª§Î®∏Ïä§ ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Ï†ÑÎ¨∏ Ïπ¥ÌîºÎùºÏù¥ÌÑ∞ÏûÖÎãàÎã§.

## Ï†úÌíà Ï†ïÎ≥¥
- Ï†úÌíàÎ™Ö: ${productName}
- Ï†úÌíà ÌäπÏßï: ${productFeatures}

## ÏÑπÏÖò Ï†ïÎ≥¥
- ÏÑπÏÖòÎ™Ö: ${section.name}
- ÏÑπÏÖò Î™©Ï†Å: ${section.purpose}

## ÏöîÏ≤≠
Ïù¥ ÏÑπÏÖòÏóê Ï†ÅÌï©Ìïú ${type === 'headline' ? 'Ìó§ÎìúÎùºÏù∏' : 'ÏÑúÎ∏åÏπ¥Ìîº'}ÏùÑ 10Í∞ú Ï∂îÏ≤úÌï¥Ï£ºÏÑ∏Ïöî.

## Ï°∞Í±¥
- ${type === 'headline' ? '15Ïûê Ïù¥ÎÇ¥Ïùò ÏûÑÌå©Ìä∏ ÏûàÎäî Î¨∏Íµ¨' : '40Ïûê Ïù¥ÎÇ¥Ïùò Î≥¥Ï°∞ ÏÑ§Î™Ö'}
- Í∞ÅÍ∞Å Îã§Î•∏ Ïä§ÌÉÄÏùºÍ≥º ÌÜ§ÏúºÎ°ú Îã§ÏñëÌïòÍ≤å ÏûëÏÑ±
- ÌïúÍµ≠Ïñ¥Î°ú ÏûëÏÑ±
- Íµ¨Îß§ ÏöïÍµ¨Î•º ÏûêÍ∑πÌïòÎäî Î¨∏Íµ¨

## Ï∂úÎ†• ÌòïÏãù (JSON Î∞∞Ïó¥Îßå Ï∂úÎ†•, Îã§Î•∏ ÌÖçÏä§Ìä∏ ÏóÜÏù¥)
["Ï≤´Î≤àÏß∏", "ÎëêÎ≤àÏß∏", "ÏÑ∏Î≤àÏß∏", "ÎÑ§Î≤àÏß∏", "Îã§ÏÑØÎ≤àÏß∏", "Ïó¨ÏÑØÎ≤àÏß∏", "ÏùºÍ≥±Î≤àÏß∏", "Ïó¨ÎçüÎ≤àÏß∏", "ÏïÑÌôâÎ≤àÏß∏", "Ïó¥Î≤àÏß∏"]`;

                const url = useBackend 
                    ? `${BACKEND_URL}/api/gemini`
                    : `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                
                const requestBody = {
                    contents: [{ 
                        role: 'user', 
                        parts: [{ text: prompt }] 
                    }],
                    generationConfig: {
                        temperature: 0.8,
                        maxOutputTokens: 1000
                    }
                };
                
                if (useBackend) {
                    requestBody.model = 'gemini-2.0-flash';
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error('API ÏöîÏ≤≠ Ïã§Ìå®');
                }
                
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                // JSON ÌååÏã±
                const jsonMatch = text.match(/\[[\s\S]*\]/);
                if (!jsonMatch) throw new Error('ÏùëÎãµ ÌååÏã± Ïã§Ìå®');
                
                const suggestions = JSON.parse(jsonMatch[0]);
                
                // ÏÑπÏÖò Îç∞Ïù¥ÌÑ∞Ïóê Ï†ÄÏû• (Îã§ÏùåÏóê Îã§Ïãú Ïó¥Î©¥ Ï†ÄÏû•Îêú Í≤É ÌëúÏãú)
                if (type === 'headline') {
                    generatedSections[sectionIndex].headlineAlts = suggestions;
                } else {
                    generatedSections[sectionIndex].subCopyAlts = suggestions;
                }
                
                // Í≤∞Í≥º Î†åÎçîÎßÅ
                listEl.innerHTML = suggestions.map((copy, i) => `
                    <div class="copy-suggestion-item" onclick="applyCopySuggestion(${sectionIndex}, '${type}', \`${copy.replace(/`/g, "\\`").replace(/\\/g, "\\\\")}\`)">
                        <div class="copy-suggestion-text">${escapeHtml(copy)}</div>
                    </div>
                `).join('');
                
                showToast('ÏÉàÎ°úÏö¥ Ïπ¥ÌîºÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!', 'success');
                
            } catch (error) {
                console.error('Copy regeneration error:', error);
                listEl.innerHTML = `<div class="copy-suggestions-loading"><p>‚ùå ÏÉùÏÑ± Ïã§Ìå®: ${error.message}</p></div>`;
            }
        }
        
        function applyCopySuggestion(sectionIndex, type, copy) {
            const inputId = type === 'headline' ? `sectionHeadline${sectionIndex}` : `sectionSubcopy${sectionIndex}`;
            const input = document.getElementById(inputId);
            if (input) {
                input.value = copy;
                // ÏÑπÏÖò Îç∞Ïù¥ÌÑ∞ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                if (type === 'headline') {
                    generatedSections[sectionIndex].headline = copy;
                } else {
                    generatedSections[sectionIndex].subCopy = copy;
                }
            }
            closeCopySuggestModal();
            showToast('Ïπ¥ÌîºÍ∞Ä Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!', 'success');
        }
        
        function closeCopySuggestModal() {
            const modal = document.getElementById('copySuggestModal');
            if (modal) modal.remove();
        }
        
        function getSectionInputValues(index) {
            return {
                headline: document.getElementById(`sectionHeadline${index}`)?.value || '',
                subCopy: document.getElementById(`sectionSubcopy${index}`)?.value || '',
                visualPrompt: document.getElementById(`sectionVisual${index}`)?.value || ''
            };
        }

        function setupSectionUpload(index) {
            const zone = document.getElementById(`sectionRefZone${index}`);
            const input = document.getElementById(`sectionRefInput${index}`);
            const preview = document.getElementById(`sectionRefPreview${index}`);
            
            if (!sectionReferences[index]) {
                sectionReferences[index] = [];
            }

            zone.onclick = (e) => {
                if (e.target.closest('.remove-btn')) return;
                input.click();
            };
            
            zone.ondragover = e => {
                e.preventDefault();
                e.stopPropagation();
                zone.classList.add('dragover');
            };
            
            zone.ondragleave = e => {
                e.preventDefault();
                e.stopPropagation();
                zone.classList.remove('dragover');
            };
            
            zone.ondrop = e => {
                e.preventDefault();
                e.stopPropagation();
                zone.classList.remove('dragover');
                handleSectionFiles(e.dataTransfer.files, index);
            };
            
            input.onchange = () => {
                handleSectionFiles(input.files, index);
                input.value = '';
            };
        }

        function handleSectionFiles(files, index) {
            if (!sectionReferences[index]) {
                sectionReferences[index] = [];
            }
            
            const currentCount = sectionReferences[index].length;
            const maxCount = 5;
            const remaining = maxCount - currentCount;
            
            if (remaining <= 0) {
                showToast(`ÏÑπÏÖòÎãπ ÏµúÎåÄ ${maxCount}Ïû•ÍπåÏßÄÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.`, 'error');
                return;
            }

            Array.from(files).slice(0, remaining).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    showToast('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = e => {
                    sectionReferences[index].push(e.target.result);
                    renderSectionRefPreview(index);
                };
                reader.readAsDataURL(file);
            });
        }

        function renderSectionRefPreview(index) {
            const preview = document.getElementById(`sectionRefPreview${index}`);
            const zone = document.getElementById(`sectionRefZone${index}`);
            const refs = sectionReferences[index] || [];
            
            preview.innerHTML = refs.map((src, i) => `
                <div class="section-preview-item">
                    <img src="${src}" alt="Reference ${i + 1}">
                    <button class="remove-btn" onclick="event.stopPropagation(); removeSectionRef(${index}, ${i})">√ó</button>
                </div>
            `).join('');
            
            if (refs.length > 0) {
                zone.classList.add('has-images');
                zone.innerHTML = `
                    <span style="font-size: 1rem;">‚ûï</span>
                    <p style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px;">${refs.length}/5Ïû• (ÌÅ¥Î¶≠ÌïòÏó¨ Ï∂îÍ∞Ä)</p>
                `;
            } else {
                zone.classList.remove('has-images');
                zone.innerHTML = `
                    <span style="font-size: 1.5rem;">‚ûï</span>
                    <p style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 8px;">ÌÅ¥Î¶≠ÌïòÍ±∞ÎÇò ÎìúÎûòÍ∑∏ÌïòÏó¨ Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä</p>
                `;
            }
        }

        function removeSectionRef(sectionIndex, imageIndex) {
            sectionReferences[sectionIndex].splice(imageIndex, 1);
            renderSectionRefPreview(sectionIndex);
        }

        function toggleSection(index) {
            const card = document.querySelector(`.section-card[data-index="${index}"]`);
            card.classList.toggle('expanded');
        }

        // ===== GENERATE IMAGES =====
        async function generateAllImages() {
            if (!useBackend && !geminiApiKey) {
                showToast('Gemini API ÌÇ§Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                openModal();
                return;
            }

            const btn = document.getElementById('generateImagesBtn');
            const progress = document.getElementById('step2Progress');
            const log = document.getElementById('imageGenLog');
            
            btn.classList.add('loading');
            btn.disabled = true;
            progress.classList.add('active');
            log.innerHTML = '';

            generatedImages = {};
            
            // STEP 3 Ïã§ÏãúÍ∞Ñ ÏßÑÌñâ ÏÉÅÌÉú ÌëúÏãú ÏãúÏûë
            showStep3Progress(true);
            
            try {
                const total = generatedSections.length;
                
                for (let i = 0; i < total; i++) {
                    const section = generatedSections[i];
                    const percent = Math.round(((i + 1) / total) * 100);
                    
                    addLog(log, `üé® ÏÑπÏÖò ${section.number}: ${section.name} ÏÉùÏÑ± Ï§ë...`, 'info');
                    await animateProgress('step2', percent);
                    
                    // STEP 3 Ïã§ÏãúÍ∞Ñ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                    updateStep3SectionStatus(i, 'generating');
                    
                    try {
                        const imageData = await generateSectionImage(section, i);
                        generatedImages[i] = imageData;
                        addLog(log, `‚úÖ ÏÑπÏÖò ${section.number} ÏôÑÎ£å!`, 'success');
                        
                        // STEP 3 Ïã§ÏãúÍ∞Ñ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                        updateStep3SectionStatus(i, 'done');
                        
                        // STEP 3 Í∑∏Î¶¨Îìú Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
                        renderImagesGrid();
                        updateStep3ProgressBar(i + 1, total);
                        
                    } catch (err) {
                        addLog(log, `‚ùå ÏÑπÏÖò ${section.number} Ïã§Ìå®: ${err.message}`, 'error');
                        generatedImages[i] = { error: err.message };
                        
                        // STEP 3 Ïã§ÏãúÍ∞Ñ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                        updateStep3SectionStatus(i, 'error');
                        renderImagesGrid();
                    }
                    
                    await sleep(500); // Rate limiting
                }
                
                renderImagesGrid();
                showToast('Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏôÑÎ£å!', 'success');
                
                // STEP 3 ÏßÑÌñâ ÏÉÅÌÉú ÏôÑÎ£å
                showStep3Progress(false);
                
                setTimeout(() => {
                    goToStep(3);
                }, 500);

            } catch (error) {
                console.error('Error:', error);
                showToast(error.message || 'Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå®', 'error');
                showStep3Progress(false);
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
                progress.classList.remove('active');
            }
        }
        
        // STEP 3 Ïã§ÏãúÍ∞Ñ ÏßÑÌñâ ÏÉÅÌÉú Ìï®ÏàòÎì§
        function showStep3Progress(show) {
            const progressSection = document.getElementById('step3Progress');
            const sectionsContainer = document.getElementById('step3ProgressSections');
            
            if (show) {
                progressSection.style.display = 'block';
                document.getElementById('step3ProgressFill').style.width = '0%';
                document.getElementById('step3ProgressPercent').textContent = '0/' + generatedSections.length;
                document.getElementById('step3ProgressTitle').textContent = 'üçå Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...';
                
                // ÏÑπÏÖòÎ≥Ñ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                sectionsContainer.innerHTML = generatedSections.map((s, i) => `
                    <div class="step3-section-status" id="step3Status${i}">
                        <span class="step3-section-num">${s.number}</span>
                        <span class="step3-section-name">${s.name}</span>
                        <span class="step3-section-state pending">ÎåÄÍ∏∞</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('step3ProgressTitle').textContent = '‚úÖ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏôÑÎ£å!';
                setTimeout(() => {
                    progressSection.style.display = 'none';
                }, 2000);
            }
        }
        
        function updateStep3SectionStatus(index, status) {
            const statusEl = document.getElementById(`step3Status${index}`);
            if (!statusEl) return;
            
            const stateEl = statusEl.querySelector('.step3-section-state');
            if (!stateEl) return;
            
            stateEl.className = 'step3-section-state ' + status;
            
            switch(status) {
                case 'generating':
                    stateEl.textContent = 'ÏÉùÏÑ± Ï§ë...';
                    break;
                case 'done':
                    stateEl.textContent = 'ÏôÑÎ£å ‚úì';
                    break;
                case 'error':
                    stateEl.textContent = 'Ïã§Ìå® ‚úó';
                    break;
                default:
                    stateEl.textContent = 'ÎåÄÍ∏∞';
            }
        }
        
        function updateStep3ProgressBar(done, total) {
            const percent = Math.round((done / total) * 100);
            document.getElementById('step3ProgressFill').style.width = percent + '%';
            document.getElementById('step3ProgressPercent').textContent = `${done}/${total}`;
        }

        async function generateSectionImage(section, index) {
            const prompt = buildImagePrompt(section, index);
            const parts = [{ text: prompt }];

            // ‚≠ê 1ÏàúÏúÑ: Ï†úÌíà Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 1Ïû•, ÏïïÏ∂ï)
            if (uploadedImages.product.length > 0) {
                const compressed = await compressImageForAPI(uploadedImages.product[0]);
                parts.push({
                    inline_data: {
                        mime_type: 'image/jpeg',
                        data: compressed.split(',')[1]
                    }
                });
            }

            // ‚≠ê 2ÏàúÏúÑ: Ìå®ÌÇ§ÏßÄ Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 1Ïû•, ÏïïÏ∂ï)
            if (uploadedImages.package.length > 0) {
                const compressed = await compressImageForAPI(uploadedImages.package[0]);
                parts.push({
                    inline_data: {
                        mime_type: 'image/jpeg',
                        data: compressed.split(',')[1]
                    }
                });
            }

            // ‚≠ê 3ÏàúÏúÑ: Î†àÌçºÎü∞Ïä§ Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 1Ïû•, ÏïïÏ∂ï)
            const sectionRefs = sectionReferences[index] || [];
            const refToUse = sectionRefs.length > 0 ? sectionRefs[0] : (uploadedImages.references.length > 0 ? uploadedImages.references[0] : null);
            if (refToUse) {
                const compressed = await compressImageForAPI(refToUse);
                parts.push({
                    inline_data: {
                        mime_type: 'image/jpeg',
                        data: compressed.split(',')[1]
                    }
                });
            }

            // Î™®Îç∏ ÏÑ§Ï†ï Í∞ÄÏ†∏Ïò§Í∏∞
            const modelConfig = getSelectedModelConfig();
            
            const geminiUrl = useBackend 
                ? `${BACKEND_URL}/api/gemini`
                : `https://generativelanguage.googleapis.com/v1beta/models/${modelConfig.model}:generateContent?key=${geminiApiKey}`;
            
            const reqBody = {
                contents: [{ parts }],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE'],
                    ...getModelConfigWithRatio(modelConfig.config)
                }
            };
            if (useBackend) reqBody.model = modelConfig.model;

            const response = await fetchWithTimeout(
                geminiUrl,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reqBody)
                },
                modelConfig.timeout
            );

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error?.message || `API Ïò§Î•ò (${response.status})`);
            }

            const data = await response.json();
            
            // Find image in response
            const candidates = data.candidates || [];
            for (const candidate of candidates) {
                const parts = candidate.content?.parts || [];
                for (const part of parts) {
                    if (part.inlineData?.mimeType?.startsWith('image/')) {
                        return {
                            data: `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`,
                            base64: part.inlineData.data,
                            prompt: section.visualPrompt
                        };
                    }
                }
            }
            
            throw new Error('Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
        }

        function buildImagePrompt(section, index) {
            // ÏÇ¨Ïö©Ïûê ÏûÖÎ†•Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
            const inputs = getSectionInputValues(index);
            const headline = inputs.headline || section.headline || '';
            const subCopy = inputs.subCopy || section.subCopy || '';
            const userVisualPrompt = inputs.visualPrompt || '';
            
            const sectionRefs = sectionReferences[index] || [];
            const hasRefs = sectionRefs.length > 0 || uploadedImages.references.length > 0;
            const hasProduct = uploadedImages.product.length > 0;
            const hasPackage = uploadedImages.package.length > 0;
            
            // Ï†úÌíà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            const productName = document.getElementById('productName')?.value || '';
            const productFeatures = document.getElementById('productFeatures')?.value || '';
            const targetAudience = document.getElementById('targetAudience')?.value || '';
            const category = document.getElementById('category')?.value || '';
            const additionalNotes = document.getElementById('additionalNotes')?.value || '';
            
            // Ïπ¥ÌÖåÍ≥†Î¶¨ Îß§Ìïë (ÏùºÎ∞òÏ†ÅÏù∏ Ï¥¨ÏòÅ/Ïó∞Ï∂ú Ïä§ÌÉÄÏùºÎßå)
            const categoryMap = {
                'snack': 'Food photography style - appetizing presentation, highlight texture and appeal',
                'beverage': 'Beverage photography style - liquid dynamics, condensation, refreshing presentation',
                'instant': 'Food photography style - appetizing, convenient meal presentation, steam/warmth',
                'health': 'Health/wellness photography style - clean, trustworthy, professional medical aesthetic',
                'beauty': 'Beauty/cosmetics photography style - soft lighting, skin-friendly, elegant presentation',
                'living': 'Product photography style - clean, practical, lifestyle context',
                'other': 'Professional e-commerce product photography style'
            };
            
            // ‚≠ê ÏÑπÏÖòÎ≥Ñ Î†àÏù¥ÏïÑÏõÉ Í∞ÄÏù¥Îìú (CRO Í¥ÄÏ†ê + Í∞Å ÏÑπÏÖòÎßàÎã§ Îã§Î•∏ Ïä§ÌÉÄÏùº)
            const sectionLayoutGuide = {
                1: `HERO BANNER - Ï≤´Ïù∏ÏÉÅ
- Large, impactful hero image with product as the star
- Bold headline at top or center (ÌïµÏã¨ ÏïΩÏÜç)
- Sub-copy visible below headline
- Premium, trustworthy first impression
- Product prominently featured
- NO explicit CTA button in image`,

                2: `PROBLEM/EMPATHY - Í≥µÍ∞ê Ïú†Î∞ú
- Lifestyle scene showing the pain point
- Relatable everyday frustration
- "Ïù¥Îü∞ Í≥†ÎØº ÏûàÏúºÏãúÏ£†?" feeling
- Person-focused, emotional approach
- Soft, empathetic mood
- NO product in this section`,

                3: `SOLUTION - Ìï¥Í≤∞Ï±Ö Ï†úÏãú
- Product as the hero solving the problem
- Bright, positive, hopeful mood
- "Ïù¥Ï†ú Ìï¥Í≤∞Îê©ÎãàÎã§" transformation feel
- Before/after concept if applicable
- Focus on BENEFIT, not selling
- NO "ÏßÄÍ∏à Íµ¨Îß§" or CTA buttons`,

                4: `BENEFITS (3Í∞ÄÏßÄ) - ÌïµÏã¨ Î≤†ÎÑ§Ìïè
- Clean infographic layout
- 3 benefit boxes or icons
- Each benefit with icon + short text
- Scannable, easy to understand
- Feature + Benefit language
- Product integrated with benefits`,

                5: `PRODUCT DETAIL / SPEC
- Close-up product shots
- Ingredient or material highlight
- Technical specifications
- Certifications or quality marks
- Detailed, informative layout
- Trust-building details`,

                6: `USAGE / TPO - ÏÇ¨Ïö©Î≤ï
- Product in use scenario
- Step-by-step or situation-based
- Morning/evening, home/office context
- Practical, relatable scenes
- Easy to follow visual guide
- Lifestyle integration`,

                7: `TRUST / SOCIAL PROOF - Ïã†Î¢∞
- Customer reviews or testimonials
- Star ratings, satisfaction %
- Certifications, awards, media
- "OOÎßåÎ™ÖÏù¥ ÏÑ†ÌÉù" social proof
- Trust badges prominent
- NO aggressive CTA`,

                8: `CLOSING - ÎßàÎ¨¥Î¶¨ Ï†ïÎ¶¨
- Product beauty shot
- Key benefits summary (subtle)
- Brand message or tagline
- Clean, premium closing feel
- Soft invitation, NOT hard sell
- NO "ÏßÄÍ∏à Íµ¨Îß§", "Î∞îÎ°ú Ï£ºÎ¨∏" buttons`
            };
            
            const layoutGuide = sectionLayoutGuide[section.number] || sectionLayoutGuide[1];
            const categoryDescription = categoryMap[category] || categoryMap['other'];
            
            // ÎπÑÏú® Ï†ïÎ≥¥
            const aspectRatioText = {
                '1:1': 'SQUARE format (1:1)',
                '3:4': 'VERTICAL format (3:4) - portrait, taller than wide',
                '4:3': 'HORIZONTAL format (4:3) - landscape, wider than tall',
                '9:16': 'TALL VERTICAL format (9:16) - mobile-optimized',
                '16:9': 'WIDE BANNER format (16:9) - cinematic'
            };
            const ratioDesc = aspectRatioText[selectedAspectRatio] || aspectRatioText['3:4'];
            
            let prompt = `Create a HIGH-QUALITY e-commerce product detail page image for Korean market.

=== ‚ö†Ô∏è CRITICAL: IMAGE ASPECT RATIO (MUST FOLLOW) ===
üìê **${ratioDesc}**
üéØ GENERATE THE IMAGE IN EXACTLY ${selectedAspectRatio} ASPECT RATIO
- This is NOT optional - the output image MUST be ${selectedAspectRatio}
- Do NOT generate square or any other ratio

=== CRITICAL: SINGLE SECTION IMAGE ===
‚ö†Ô∏è THIS IS THE MOST IMPORTANT RULE:
- Create ONE single focused image for THIS SECTION ONLY
- DO NOT create a collage or multi-section layout
- DO NOT combine multiple scenes or stack sections
- ONE clear visual concept, ONE focused composition

=== SECTION-SPECIFIC LAYOUT (MUST FOLLOW) ===
This is Section ${section.number}: ${section.name}
${layoutGuide}

=== PRODUCT CATEGORY ===
${categoryDescription}

=== PRODUCT INFORMATION ===
Product Name: ${productName}
Product Features: ${productFeatures}
Target Audience: ${targetAudience}

=== TEXT TO DISPLAY IN IMAGE ===
Main Headline (Korean): ${headline}
Sub Copy (Korean): ${subCopy}

CRITICAL TEXT RULES:
- ONLY include the headline and sub copy above
- Korean text must be clear, legible, modern typography
- DO NOT add section labels like "ÌûàÏñ¥Î°ú Î∞∞ÎÑà", "USP", "CTA"

‚ö†Ô∏è FORBIDDEN TEXT:
- "${section.name}", "USP", "Ï†úÌíà ÏÉÅÏÑ∏", "ÌûàÏñ¥Î°ú Î∞∞ÎÑà", "ÏÜîÎ£®ÏÖò", "CTA", "Íµ¨Îß§ Ïú†ÎèÑ"`;

            if (hasProduct || hasPackage) {
                prompt += `

=== PRODUCT IMAGES (COLOR SOURCE - HIGHEST PRIORITY) ===
‚ö†Ô∏è CRITICAL: Extract ALL colors from product/package images.
- Color palette MUST come from the actual product/package
- Brand colors from packaging
- The product must be accurately represented
- Match the product's actual appearance exactly`;
            }

            if (hasRefs) {
                // Î†àÌçºÎü∞Ïä§ Í∞ïÎèÑ ÌôïÏù∏
                const refStrength = document.querySelector('input[name="refStrength"]:checked')?.value || 'strong';
                
                if (refStrength === 'strong') {
                    prompt += `

=== REFERENCE IMAGES (STYLE SOURCE) ===
From the reference images, extract and apply:
- Overall mood and atmosphere
- Typography style and text treatment
- Background style, texture, and gradients
- Visual composition feeling and layout flow
- Design aesthetic and quality level

‚ö†Ô∏è IMPORTANT: 
- Colors must come from PRODUCT images, NOT from references
- Use reference for STYLE/MOOD/TYPOGRAPHY only`;
                } else {
                    prompt += `

=== REFERENCE IMAGES (LAYOUT ONLY) ===
Use reference images ONLY for layout and composition inspiration.
DO NOT copy colors, style, or mood from references.
Use PRODUCT colors and default professional style.`;
                }
            }
            
            if (userVisualPrompt.trim()) {
                prompt += `

=== SECTION-SPECIFIC INSTRUCTIONS ===
${userVisualPrompt}`;
            }
            
            // Ï∂îÍ∞Ä ÏöîÏ≤≠ÏÇ¨Ìï≠ (STEP 1ÏóêÏÑú ÏûÖÎ†•Ìïú Ï†ÑÏ≤¥ Ïä§ÌÉÄÏùº Í∞ÄÏù¥Îìú)
            if (additionalNotes.trim()) {
                prompt += `

=== GLOBAL STYLE REQUIREMENTS (HIGHEST PRIORITY) ===
The user has specified the following requirements that MUST be applied:
${additionalNotes}

IMPORTANT: These global requirements override default styles.`;
            }

            prompt += `

=== OUTPUT ===
- High resolution, professional e-commerce quality
- Clean, polished result for Korean online shopping platforms
- Make this section visually DISTINCT from other sections`;

            return prompt;
        }

        function renderImagesGrid() {
            const grid = document.getElementById('imagesGrid');
            const count = document.getElementById('imageCount');
            
            const successCount = Object.values(generatedImages).filter(img => !img.error).length;
            count.textContent = `${successCount}/${generatedSections.length}`;
            
            // STEP 1 Ï†ÑÏ≤¥ Î†àÌçºÎü∞Ïä§ Í∞úÏàò
            const step1RefCount = uploadedImages.references.length;
            
            grid.innerHTML = generatedSections.map((section, i) => {
                const img = generatedImages[i];
                const hasImage = img && !img.error;
                const status = !img ? 'pending' : (img.error ? 'error' : 'complete');
                const step3Refs = step3References[i] || [];
                const step3Prompt = step3Prompts[i] || '';
                const sectionModel = step3Models[i] || selectedModel;
                
                // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉú Î≥µÏõê (Ï†ÄÏû•Îêú Í∞í ÎòêÎäî Í∏∞Î≥∏Í∞í)
                const opts = step3IncludeOptions[i] || {};
                const chkGenerated = opts.generated !== undefined ? opts.generated : hasImage;
                const chkStep1Ref = opts.step1Reference !== undefined ? opts.step1Reference : false;
                const chkReference = opts.reference !== undefined ? opts.reference : false;
                const chkPrompt = opts.prompt !== undefined ? opts.prompt : true;
                
                return `
                    <div class="image-card" data-index="${i}">
                        <div class="image-card-header">
                            <span class="image-card-title">${section.number}. ${section.name}</span>
                            <span class="image-card-status ${status}">${
                                status === 'pending' ? 'ÎåÄÍ∏∞Ï§ë' :
                                status === 'error' ? 'Ïã§Ìå®' : 'ÏôÑÎ£å'
                            }</span>
                        </div>
                        <div class="image-card-body">
                            ${hasImage ? 
                                `<img src="${img.data}" alt="${section.name}">` :
                                `<div class="image-placeholder">
                                    <div class="image-placeholder-icon">${status === 'error' ? '‚ùå' : 'üñºÔ∏è'}</div>
                                    <p>${img?.error || 'Ïù¥ÎØ∏ÏßÄ ÏóÜÏùå'}</p>
                                </div>`
                            }
                        </div>
                        
                        <!-- Ïû¨ÏÉùÏÑ± ÏòµÏÖò Ìå®ÎÑê -->
                        <div class="image-card-regen-panel">
                            <div class="regen-toggle" onclick="toggleRegenPanel(${i})">
                                <span>üé® Ïû¨ÏÉùÏÑ± ÏòµÏÖò</span>
                                <span class="regen-toggle-icon" id="regenIcon${i}">‚ñº</span>
                            </div>
                            <div class="regen-panel-content" id="regenPanel${i}" style="display: none;">
                                <!-- Î™®Îç∏ ÏÑ†ÌÉù -->
                                <div class="regen-model-section">
                                    <label class="regen-label">ü§ñ ÏÉùÏÑ± Î™®Îç∏</label>
                                    <div class="regen-model-options">
                                        <label class="regen-model-option">
                                            <input type="radio" name="regenModel${i}" value="fast" ${sectionModel === 'fast' ? 'checked' : ''} onchange="setStep3Model(${i}, 'fast')">
                                            <span class="regen-model-btn">‚ö° Îπ†Î¶Ñ (10~30Ï¥à)</span>
                                        </label>
                                        <label class="regen-model-option">
                                            <input type="radio" name="regenModel${i}" value="quality" ${sectionModel === 'quality' ? 'checked' : ''} onchange="setStep3Model(${i}, 'quality')">
                                            <span class="regen-model-btn">üé® Í≥†ÌíàÏßà (1~5Î∂Ñ)</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Ïû¨ÏÉùÏÑ± Ìè¨Ìï® ÏöîÏÜå Ï≤¥ÌÅ¨Î∞ïÏä§ -->
                                <div class="regen-include-section">
                                    <label class="regen-label">üéØ Ïû¨ÏÉùÏÑ±Ïóê Ìè¨Ìï®Ìï† ÏöîÏÜå</label>
                                    <div class="regen-include-options">
                                        <label class="regen-include-option">
                                            <input type="checkbox" id="includeGenerated${i}" ${chkGenerated ? 'checked' : ''} ${!hasImage ? 'disabled' : ''} onchange="saveIncludeOption(${i}, 'generated', this.checked)">
                                            <span class="regen-include-text">üñºÔ∏è Í∏∞Ï°¥ ÏÉùÏÑ± Ïù¥ÎØ∏ÏßÄ</span>
                                        </label>
                                        <label class="regen-include-option ${step1RefCount === 0 ? 'disabled-option' : ''}">
                                            <input type="checkbox" id="includeStep1Ref${i}" ${chkStep1Ref ? 'checked' : ''} ${step1RefCount === 0 ? 'disabled' : ''} onchange="saveIncludeOption(${i}, 'step1Reference', this.checked)">
                                            <span class="regen-include-text">üé® STEP 1 Ï†ÑÏ≤¥ Î†àÌçºÎü∞Ïä§ (${step1RefCount}Ïû•)</span>
                                        </label>
                                        <label class="regen-include-option">
                                            <input type="checkbox" id="includeReference${i}" ${chkReference ? 'checked' : ''} onchange="saveIncludeOption(${i}, 'reference', this.checked)">
                                            <span class="regen-include-text">üì∑ Ï∂îÍ∞Ä Î†àÌçºÎü∞Ïä§ Ïù¥ÎØ∏ÏßÄ</span>
                                        </label>
                                        <label class="regen-include-option">
                                            <input type="checkbox" id="includePrompt${i}" ${chkPrompt ? 'checked' : ''} onchange="saveIncludeOption(${i}, 'prompt', this.checked)">
                                            <span class="regen-include-text">‚úçÔ∏è Ï∂îÍ∞Ä ÌîÑÎ°¨ÌîÑÌä∏</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="regen-ref-section" id="refSection${i}">
                                    <label class="regen-label">üì∑ Ï∂îÍ∞Ä Î†àÌçºÎü∞Ïä§ Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 5Ïû•)</label>
                                    <div class="regen-upload-zone" id="step3RefZone${i}" data-index="${i}">
                                        <span class="regen-zone-text">‚ûï ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉù ÎòêÎäî Ctrl+V</span>
                                    </div>
                                    <input type="file" hidden id="step3RefInput${i}" accept="image/*" multiple>
                                    <div class="regen-preview-container" id="step3RefPreview${i}"></div>
                                </div>
                                <div class="regen-prompt-section" id="promptSection${i}">
                                    <label class="regen-label">‚úçÔ∏è Ï∂îÍ∞Ä ÌîÑÎ°¨ÌîÑÌä∏ (ÏÑ†ÌÉù)</label>
                                    <textarea class="regen-prompt-input" id="step3Prompt${i}" placeholder="ÏõêÌïòÎäî Ïä§ÌÉÄÏùºÏù¥ÎÇò ÏàòÏ†ïÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">${escapeHtml(step3Prompt)}</textarea>
                                </div>
                                <button class="btn btn-gemini regen-generate-btn" onclick="regenerateWithOptions(${i})">
                                    üçå ÎÇ¥Ïö©ÏúºÎ°ú Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
                                </button>
                            </div>
                        </div>
                        
                        <div class="image-card-footer">
                            <button class="btn btn-secondary" onclick="regenerateSingle(${i})" ${!useBackend && !geminiApiKey ? 'disabled' : ''}>üîÑ ÎûúÎç§ Ïû¨ÏÉùÏÑ±</button>
                            <button class="btn btn-primary" onclick="downloadSingle(${i})" ${!hasImage ? 'disabled' : ''}>‚¨áÔ∏è Îã§Ïö¥Î°úÎìú</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Setup step3 upload zones
            generatedSections.forEach((_, i) => {
                setupStep3Upload(i);
            });
        }
        
        // STEP 3 Î†àÌçºÎü∞Ïä§ Í¥ÄÎ¶¨
        let step3References = {};
        let step3Prompts = {};
        let step3Models = {}; // ÏÑπÏÖòÎ≥Ñ Î™®Îç∏ ÏÑ†ÌÉù
        let step3IncludeOptions = {}; // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉú Ï†ÄÏû•
        
        // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉú Ï†ÄÏû• Ìï®Ïàò
        function saveIncludeOption(index, type, value) {
            if (!step3IncludeOptions[index]) {
                step3IncludeOptions[index] = {};
            }
            step3IncludeOptions[index][type] = value;
        }
        
        function setStep3Model(index, model) {
            step3Models[index] = model;
        }
        
        function getStep3ModelConfig(index) {
            const model = step3Models[index] || selectedModel;
            return MODEL_CONFIGS[model] || MODEL_CONFIGS.fast;
        }
        
        function toggleRegenPanel(index) {
            const panel = document.getElementById(`regenPanel${index}`);
            const icon = document.getElementById(`regenIcon${index}`);
            const isHidden = panel.style.display === 'none';
            panel.style.display = isHidden ? 'block' : 'none';
            icon.textContent = isHidden ? '‚ñ≤' : '‚ñº';
        }
        
        function setupStep3Upload(index) {
            const zone = document.getElementById(`step3RefZone${index}`);
            const input = document.getElementById(`step3RefInput${index}`);
            
            if (!zone || !input) return;
            
            if (!step3References[index]) {
                step3References[index] = [];
            }

            // Ìè¨Ïª§Ïä§ Î∞©Ïãù: Ï≤´ ÌÅ¥Î¶≠ = Ìè¨Ïª§Ïä§, Îëê Î≤àÏß∏ ÌÅ¥Î¶≠ = ÌååÏùº ÏÑ†ÌÉù
            zone.onclick = (e) => {
                if (e.target.closest('.remove-btn')) return;
                e.stopPropagation();
                
                if (zone.classList.contains('focused')) {
                    input.click();
                } else {
                    setStep3UploadFocus(zone, index);
                }
            };
            
            zone.ondragover = e => {
                e.preventDefault();
                zone.style.borderColor = 'var(--accent-gemini)';
                zone.style.background = 'rgba(139, 92, 246, 0.1)';
            };
            
            zone.ondragleave = e => {
                e.preventDefault();
                zone.style.borderColor = '';
                zone.style.background = '';
            };
            
            zone.ondrop = e => {
                e.preventDefault();
                zone.style.borderColor = '';
                zone.style.background = '';
                handleStep3Files(e.dataTransfer.files, index);
            };
            
            input.onchange = () => {
                handleStep3Files(input.files, index);
                input.value = '';
            };
            
            // Í∏∞Ï°¥ Î†àÌçºÎü∞Ïä§Í∞Ä ÏûàÏúºÎ©¥ Î†åÎçîÎßÅ
            if (step3References[index]?.length > 0) {
                renderStep3RefPreview(index);
            }
        }
        
        // STEP 3 Ìè¨Ïª§Ïä§ Í¥ÄÎ¶¨
        let focusedStep3Zone = null;
        let focusedStep3Index = null;
        
        function setStep3UploadFocus(zone, index) {
            clearStep3UploadFocus();
            zone.classList.add('focused');
            focusedStep3Zone = zone;
            focusedStep3Index = index;
            
            // 5Ï¥à ÌõÑ ÏûêÎèô Ìï¥Ï†ú
            setTimeout(() => {
                if (focusedStep3Zone === zone) {
                    clearStep3UploadFocus();
                }
            }, 5000);
        }
        
        function clearStep3UploadFocus() {
            document.querySelectorAll('.regen-upload-zone.focused').forEach(z => z.classList.remove('focused'));
            focusedStep3Zone = null;
            focusedStep3Index = null;
        }
        
        // STEP 3 Î∂ôÏó¨ÎÑ£Í∏∞ Ìï∏Îì§Îü¨ (Ï†ÑÏó≠)
        document.addEventListener('paste', (e) => {
            if (focusedStep3Zone && focusedStep3Index !== null) {
                const items = e.clipboardData?.items;
                if (!items) return;
                
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        if (file) {
                            handleStep3PastedImage(file, focusedStep3Index);
                        }
                        break;
                    }
                }
            }
        });
        
        function handleStep3PastedImage(file, index) {
            if (!step3References[index]) {
                step3References[index] = [];
            }
            
            if (step3References[index].length >= 5) {
                showToast('ÏµúÎåÄ 5Ïû•ÍπåÏßÄÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                step3References[index].push(e.target.result);
                renderStep3RefPreview(index);
                showToast('Ïù¥ÎØ∏ÏßÄÍ∞Ä Î∂ôÏó¨ÎÑ£Í∏∞ ÎêòÏóàÏäµÎãàÎã§!', 'success');
            };
            reader.readAsDataURL(file);
        }
        
        function handleStep3Files(files, index) {
            if (!step3References[index]) {
                step3References[index] = [];
            }
            
            const maxCount = 5;
            const remaining = maxCount - step3References[index].length;
            
            if (remaining <= 0) {
                showToast('ÏµúÎåÄ 5Ïû•ÍπåÏßÄÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.', 'error');
                return;
            }

            Array.from(files).slice(0, remaining).forEach(file => {
                if (!file.type.startsWith('image/')) return;
                
                const reader = new FileReader();
                reader.onload = e => {
                    step3References[index].push(e.target.result);
                    renderStep3RefPreview(index);
                };
                reader.readAsDataURL(file);
            });
        }
        
        function renderStep3RefPreview(index) {
            const preview = document.getElementById(`step3RefPreview${index}`);
            const zone = document.getElementById(`step3RefZone${index}`);
            const refs = step3References[index] || [];
            
            preview.innerHTML = refs.map((src, i) => `
                <div class="regen-preview-item">
                    <img src="${src}" alt="Ref ${i + 1}">
                    <button class="remove-btn" onclick="event.stopPropagation(); removeStep3Ref(${index}, ${i})">√ó</button>
                </div>
            `).join('');
            
            if (refs.length > 0) {
                zone.innerHTML = `<span class="regen-zone-text">‚ûï ${refs.length}/5Ïû• (ÌÅ¥Î¶≠ Ï∂îÍ∞Ä / Ctrl+V)</span>`;
            } else {
                zone.innerHTML = `<span class="regen-zone-text">‚ûï ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉù ÎòêÎäî Ctrl+V</span>`;
            }
        }
        
        function removeStep3Ref(sectionIndex, imageIndex) {
            step3References[sectionIndex].splice(imageIndex, 1);
            renderStep3RefPreview(sectionIndex);
        }
        
        async function regenerateWithOptions(index) {
            if (!useBackend && !geminiApiKey) {
                showToast('Gemini API ÌÇ§Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            
            // ÌîÑÎ°¨ÌîÑÌä∏ Ï†ÄÏû•
            step3Prompts[index] = document.getElementById(`step3Prompt${index}`)?.value || '';
            
            const section = generatedSections[index];
            showToast(`ÏÑπÏÖò ${section.number} Ïû¨ÏÉùÏÑ± Ï§ë...`, 'success');
            
            // Ïπ¥Îìú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            const card = document.querySelector(`.image-card[data-index="${index}"]`);
            const statusEl = card?.querySelector('.image-card-status');
            if (statusEl) {
                statusEl.className = 'image-card-status generating';
                statusEl.textContent = 'ÏÉùÏÑ±Ï§ë...';
            }
            
            // üîÑ ÏÉÅÎã® ÏßÑÌñâÎ∞î ÏÉÅÌÉúÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            const topStatusEl = document.getElementById(`step3Status${index}`);
            if (topStatusEl) {
                topStatusEl.className = 'step3-section-status generating';
                topStatusEl.textContent = `‚è≥ ${section.number}. ${section.name}`;
            }
            
            try {
                const imageData = await generateSectionImageWithStep3Options(section, index);
                generatedImages[index] = imageData;
                renderImagesGrid();
                
                // üîÑ ÏÉÅÎã® ÏßÑÌñâÎ∞î ÏôÑÎ£å ÏÉÅÌÉú
                if (topStatusEl) {
                    topStatusEl.className = 'step3-section-status done';
                    topStatusEl.textContent = `‚úì ${section.number}. ${section.name}`;
                }
                updateOverallProgress();
                
                showToast(`ÏÑπÏÖò ${section.number} Ïû¨ÏÉùÏÑ± ÏôÑÎ£å!`, 'success');
            } catch (err) {
                generatedImages[index] = { error: err.message };
                renderImagesGrid();
                
                // üîÑ ÏÉÅÎã® ÏßÑÌñâÎ∞î Ïã§Ìå® ÏÉÅÌÉú
                if (topStatusEl) {
                    topStatusEl.className = 'step3-section-status error';
                    topStatusEl.textContent = `‚úó ${section.number}. ${section.name}`;
                }
                updateOverallProgress();
                
                showToast(`Ïû¨ÏÉùÏÑ± Ïã§Ìå®: ${err.message}`, 'error');
            }
        }
        
        async function generateSectionImageWithStep3Options(section, index) {
            // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉú ÌôïÏù∏
            const includeGenerated = document.getElementById(`includeGenerated${index}`)?.checked || false;
            const includeStep1Ref = document.getElementById(`includeStep1Ref${index}`)?.checked || false;
            const includeReference = document.getElementById(`includeReference${index}`)?.checked || false;
            const includePrompt = document.getElementById(`includePrompt${index}`)?.checked || false;
            
            // STEP 3ÏóêÏÑú ÏûÖÎ†•Ìïú Î†àÌçºÎü∞Ïä§ÏôÄ ÌîÑÎ°¨ÌîÑÌä∏ ÏÇ¨Ïö©
            const step3Refs = step3References[index] || [];
            const step3Prompt = step3Prompts[index] || '';
            
            // Î†àÌçºÎü∞Ïä§ Í∞ïÎèÑ ÌôïÏù∏
            const refStrength = document.querySelector('input[name="refStrength"]:checked')?.value || 'strong';
            
            const inputs = getSectionInputValues(index);
            const headline = inputs.headline || section.headline || '';
            const subCopy = inputs.subCopy || section.subCopy || '';
            
            let prompt = `Create a high-quality e-commerce product detail page image for Korean market.

=== SECTION INFO ===
Section Name: ${section.name}
Purpose: ${section.purpose || 'Product promotion'}

=== KOREAN TEXT TO INCLUDE ===
Main Headline (Korean): ${headline}
Sub Copy (Korean): ${subCopy}

CRITICAL: Render Korean text clearly and legibly.`;

            // Í∏∞Ï°¥ ÏÉùÏÑ± Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï® Ïãú
            if (includeGenerated && generatedImages[index]?.base64) {
                prompt += `

=== EXISTING IMAGE (REFERENCE FOR IMPROVEMENT) ===
The provided existing image is the current result. Improve upon it while maintaining its overall concept and style.
Keep the good aspects and fix any issues mentioned in the user instructions.`;
            }

            // STEP 1 Ï†ÑÏ≤¥ Î†àÌçºÎü∞Ïä§ Ìè¨Ìï® Ïãú
            if (includeStep1Ref && uploadedImages.references.length > 0) {
                if (refStrength === 'strong') {
                    prompt += `

=== STEP 1 GLOBAL REFERENCE (STYLE SOURCE) ===
From the ${uploadedImages.references.length} global reference image(s), extract and apply:
- Overall mood and atmosphere
- Typography style and text treatment
- Background style and texture
- Visual composition feeling

‚ö†Ô∏è Colors must come from PRODUCT images, NOT from references.`;
                } else {
                    prompt += `

=== STEP 1 GLOBAL REFERENCE (LAYOUT ONLY) ===
Use global reference images ONLY for layout inspiration.`;
                }
            }

            // Ï∂îÍ∞Ä Î†àÌçºÎü∞Ïä§ Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï® Ïãú (STEP 3)
            if (includeReference && step3Refs.length > 0) {
                prompt += `

=== ADDITIONAL STYLE REFERENCE (HIGH PRIORITY) ===
Analyze the ${step3Refs.length} additional reference image(s) and CLOSELY MATCH the style, mood, and composition.
This takes priority over global references for this section.`;
            }
            
            // Ï∂îÍ∞Ä ÌîÑÎ°¨ÌîÑÌä∏ Ìè¨Ìï® Ïãú
            if (includePrompt && step3Prompt.trim()) {
                prompt += `

=== USER INSTRUCTIONS (HIGHEST PRIORITY) ===
${step3Prompt}`;
            }

            prompt += `

=== OUTPUT ===
- 4K resolution, professional e-commerce quality
- Clean, polished result for Korean online shopping platforms`;

            const parts = [{ text: prompt }];

            // ‚≠ê Í∏∞Ï°¥ ÏÉùÏÑ± Ïù¥ÎØ∏ÏßÄ (Ï≤¥ÌÅ¨ Ïãú, ÏïïÏ∂ï)
            if (includeGenerated && generatedImages[index]?.base64) {
                const existingImg = `data:image/png;base64,${generatedImages[index].base64}`;
                const compressed = await compressImageForAPI(existingImg);
                parts.push({
                    inline_data: {
                        mime_type: 'image/jpeg',
                        data: compressed.split(',')[1]
                    }
                });
            }

            // ‚≠ê Ï†úÌíà Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 1Ïû•, ÏïïÏ∂ï)
            if (uploadedImages.product.length > 0) {
                const compressed = await compressImageForAPI(uploadedImages.product[0]);
                parts.push({
                    inline_data: {
                        mime_type: 'image/jpeg',
                        data: compressed.split(',')[1]
                    }
                });
            }

            // ‚≠ê Ìå®ÌÇ§ÏßÄ Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 1Ïû•, ÏïïÏ∂ï)
            if (uploadedImages.package.length > 0) {
                const compressed = await compressImageForAPI(uploadedImages.package[0]);
                parts.push({
                    inline_data: {
                        mime_type: 'image/jpeg',
                        data: compressed.split(',')[1]
                    }
                });
            }

            // ‚≠ê STEP 1 Ï†ÑÏ≤¥ Î†àÌçºÎü∞Ïä§ (ÏµúÎåÄ 1Ïû•, ÏïïÏ∂ï)
            if (includeStep1Ref && uploadedImages.references.length > 0) {
                const compressed = await compressImageForAPI(uploadedImages.references[0]);
                parts.push({
                    inline_data: {
                        mime_type: 'image/jpeg',
                        data: compressed.split(',')[1]
                    }
                });
            }

            // ‚≠ê Ï∂îÍ∞Ä Î†àÌçºÎü∞Ïä§ Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 1Ïû•, ÏïïÏ∂ï)
            if (includeReference && step3Refs.length > 0) {
                const compressed = await compressImageForAPI(step3Refs[0]);
                parts.push({
                    inline_data: {
                        mime_type: 'image/jpeg',
                        data: compressed.split(',')[1]
                    }
                });
            }

            // Î™®Îç∏ ÏÑ§Ï†ï Í∞ÄÏ†∏Ïò§Í∏∞ (ÏÑπÏÖòÎ≥Ñ ÏÑ§Ï†ï Ïö∞ÏÑ†)
            const modelConfig = getStep3ModelConfig(index);

            const geminiUrl = useBackend 
                ? `${BACKEND_URL}/api/gemini`
                : `https://generativelanguage.googleapis.com/v1beta/models/${modelConfig.model}:generateContent?key=${geminiApiKey}`;
            
            const reqBody = {
                contents: [{ parts }],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE'],
                    ...getModelConfigWithRatio(modelConfig.config)
                }
            };
            if (useBackend) reqBody.model = modelConfig.model;

            const response = await fetchWithTimeout(
                geminiUrl,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reqBody)
                },
                modelConfig.timeout
            );

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error?.message || `API Ïò§Î•ò (${response.status})`);
            }

            const data = await response.json();
            
            const candidates = data.candidates || [];
            for (const candidate of candidates) {
                const respParts = candidate.content?.parts || [];
                for (const part of respParts) {
                    if (part.inlineData?.mimeType?.startsWith('image/')) {
                        return {
                            data: `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`,
                            base64: part.inlineData.data,
                            prompt: prompt
                        };
                    }
                }
            }
            
            throw new Error('Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
        }

        async function regenerateSingle(index) {
            const section = generatedSections[index];
            const modelConfig = getStep3ModelConfig(index);
            showToast(`ÏÑπÏÖò ${section.number} Ïû¨ÏÉùÏÑ± Ï§ë... (${modelConfig.name})`, 'success');
            
            // Ïπ¥Îìú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            const card = document.querySelector(`.image-card[data-index="${index}"]`);
            const statusEl = card?.querySelector('.image-card-status');
            if (statusEl) {
                statusEl.className = 'image-card-status generating';
                statusEl.textContent = 'ÏÉùÏÑ±Ï§ë...';
            }
            
            // üîÑ ÏÉÅÎã® ÏßÑÌñâÎ∞î ÏÉÅÌÉúÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            const topStatusEl = document.getElementById(`step3Status${index}`);
            if (topStatusEl) {
                topStatusEl.className = 'step3-section-status generating';
                topStatusEl.textContent = `‚è≥ ${section.number}. ${section.name}`;
            }
            
            try {
                const imageData = await generateSectionImageWithModel(section, index, modelConfig);
                generatedImages[index] = imageData;
                renderImagesGrid();
                
                // üîÑ ÏÉÅÎã® ÏßÑÌñâÎ∞î ÏôÑÎ£å ÏÉÅÌÉú
                if (topStatusEl) {
                    topStatusEl.className = 'step3-section-status done';
                    topStatusEl.textContent = `‚úì ${section.number}. ${section.name}`;
                }
                updateOverallProgress();
                
                showToast(`ÏÑπÏÖò ${section.number} Ïû¨ÏÉùÏÑ± ÏôÑÎ£å!`, 'success');
            } catch (err) {
                generatedImages[index] = { error: err.message };
                renderImagesGrid();
                
                // üîÑ ÏÉÅÎã® ÏßÑÌñâÎ∞î Ïã§Ìå® ÏÉÅÌÉú
                if (topStatusEl) {
                    topStatusEl.className = 'step3-section-status error';
                    topStatusEl.textContent = `‚úó ${section.number}. ${section.name}`;
                }
                updateOverallProgress();
                
                showToast(`Ïû¨ÏÉùÏÑ± Ïã§Ìå®: ${err.message}`, 'error');
            }
        }
        
        // üîÑ Ï†ÑÏ≤¥ ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateOverallProgress() {
            const total = generatedSections.length;
            let completed = 0;
            let errors = 0;
            
            for (let i = 0; i < total; i++) {
                const img = generatedImages[i];
                if (img && !img.error) completed++;
                else if (img && img.error) errors++;
            }
            
            const progressTitle = document.getElementById('step3ProgressTitle');
            const progressFill = document.getElementById('step3ProgressFill');
            const progressPercent = document.getElementById('step3ProgressPercent');
            
            if (progressTitle && progressFill && progressPercent) {
                const percent = Math.round(((completed + errors) / total) * 100);
                progressFill.style.width = `${percent}%`;
                progressPercent.textContent = `${completed + errors}/${total}`;
                
                if (completed + errors === total) {
                    if (errors > 0) {
                        progressTitle.textContent = `‚ö†Ô∏è ${completed}Í∞ú ÏôÑÎ£å, ${errors}Í∞ú Ïã§Ìå®`;
                    } else {
                        progressTitle.textContent = `‚úÖ Ï†ÑÏ≤¥ ${total}Í∞ú ÏôÑÎ£å!`;
                    }
                }
            }
        }
        
        // Î™®Îç∏ ÏÑ§Ï†ïÏùÑ Î∞õÏïÑÏÑú Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±ÌïòÎäî Ìï®Ïàò
        async function generateSectionImageWithModel(section, index, modelConfig) {
            const prompt = buildImagePrompt(section, index);
            const parts = [{ text: prompt }];

            // ‚≠ê Ï†úÌíà Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 1Ïû•, ÏïïÏ∂ï)
            if (uploadedImages.product.length > 0) {
                const compressed = await compressImageForAPI(uploadedImages.product[0]);
                parts.push({
                    inline_data: {
                        mime_type: 'image/jpeg',
                        data: compressed.split(',')[1]
                    }
                });
            }

            // ‚≠ê Ìå®ÌÇ§ÏßÄ Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 1Ïû•, ÏïïÏ∂ï)
            if (uploadedImages.package.length > 0) {
                const compressed = await compressImageForAPI(uploadedImages.package[0]);
                parts.push({
                    inline_data: {
                        mime_type: 'image/jpeg',
                        data: compressed.split(',')[1]
                    }
                });
            }

            // Î†àÌçºÎü∞Ïä§ Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 1Ïû•, ÏïïÏ∂ï)
            const sectionRefs = sectionReferences[index] || [];
            const refToUse = sectionRefs.length > 0 ? sectionRefs[0] : (uploadedImages.references.length > 0 ? uploadedImages.references[0] : null);
            if (refToUse) {
                const compressed = await compressImageForAPI(refToUse);
                parts.push({
                    inline_data: {
                        mime_type: 'image/jpeg',
                        data: compressed.split(',')[1]
                    }
                });
            }

            const geminiUrl = useBackend 
                ? `${BACKEND_URL}/api/gemini`
                : `https://generativelanguage.googleapis.com/v1beta/models/${modelConfig.model}:generateContent?key=${geminiApiKey}`;
            
            const reqBody = {
                contents: [{ parts }],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE'],
                    ...getModelConfigWithRatio(modelConfig.config)
                }
            };
            if (useBackend) reqBody.model = modelConfig.model;

            const response = await fetchWithTimeout(
                geminiUrl,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reqBody)
                },
                modelConfig.timeout
            );

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error?.message || `API Ïò§Î•ò (${response.status})`);
            }

            const data = await response.json();
            
            const candidates = data.candidates || [];
            for (const candidate of candidates) {
                const respParts = candidate.content?.parts || [];
                for (const part of respParts) {
                    if (part.inlineData?.mimeType?.startsWith('image/')) {
                        return {
                            data: `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`,
                            base64: part.inlineData.data,
                            prompt: section.visualPrompt
                        };
                    }
                }
            }
            
            throw new Error('Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
        }

        // ===== STEP 3 Ï†ÑÏ≤¥ Ïû¨ÏÉùÏÑ± (ÏßÑÌñâ ÏÉÅÌô© UI Ìè¨Ìï®) =====
        async function regenerateAllImagesInStep3() {
            if (!useBackend && !geminiApiKey) {
                showToast('Gemini API ÌÇ§Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            const btn = document.getElementById('regenerateAllBtn');
            const progressSection = document.getElementById('step3Progress');
            const progressFill = document.getElementById('step3ProgressFill');
            const progressPercent = document.getElementById('step3ProgressPercent');
            const progressTitle = document.getElementById('step3ProgressTitle');
            const progressSections = document.getElementById('step3ProgressSections');
            
            // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            btn.disabled = true;
            btn.textContent = '‚è≥ Ïû¨ÏÉùÏÑ± Ï§ë...';
            
            // ÏßÑÌñâ ÏÉÅÌô© UI ÌëúÏãú
            progressSection.style.display = 'block';
            progressFill.style.width = '0%';
            
            // ÏÑπÏÖòÎ≥Ñ ÏÉÅÌÉú ÌëúÏãú Ï¥àÍ∏∞Ìôî
            const total = generatedSections.length;
            progressSections.innerHTML = generatedSections.map((section, i) => 
                `<span class="step3-section-status waiting" id="step3Status${i}">${section.number}. ${section.name}</span>`
            ).join('');
            
            let completed = 0;
            let errors = 0;
            
            try {
                for (let i = 0; i < total; i++) {
                    const section = generatedSections[i];
                    const statusEl = document.getElementById(`step3Status${i}`);
                    const modelConfig = getStep3ModelConfig(i);
                    
                    // ÌòÑÏû¨ ÏÑπÏÖò ÏÉùÏÑ± Ï§ë ÌëúÏãú
                    statusEl.className = 'step3-section-status generating';
                    progressTitle.textContent = `üçå ÏÑπÏÖò ${section.number}: ${section.name} ÏÉùÏÑ± Ï§ë...`;
                    
                    try {
                        const imageData = await generateSectionImageWithModel(section, i, modelConfig);
                        generatedImages[i] = imageData;
                        statusEl.className = 'step3-section-status done';
                        statusEl.textContent = `‚úì ${section.number}. ${section.name}`;
                        completed++;
                    } catch (err) {
                        generatedImages[i] = { error: err.message };
                        statusEl.className = 'step3-section-status error';
                        statusEl.textContent = `‚úó ${section.number}. ${section.name}`;
                        errors++;
                    }
                    
                    // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
                    const percent = Math.round(((i + 1) / total) * 100);
                    progressFill.style.width = `${percent}%`;
                    progressPercent.textContent = `${i + 1}/${total}`;
                    
                    // Ïù¥ÎØ∏ÏßÄ Í∑∏Î¶¨Îìú Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    renderImagesGrid();
                    
                    // Rate limiting
                    if (i < total - 1) {
                        await sleep(500);
                    }
                }
                
                // ÏôÑÎ£å Î©îÏãúÏßÄ
                progressTitle.textContent = `‚úÖ ÏôÑÎ£å! ${completed}Í∞ú ÏÑ±Í≥µ, ${errors}Í∞ú Ïã§Ìå®`;
                showToast(`Ï†ÑÏ≤¥ Ïû¨ÏÉùÏÑ± ÏôÑÎ£å! (${completed}/${total} ÏÑ±Í≥µ)`, completed === total ? 'success' : 'error');
                
            } catch (error) {
                console.error('Error:', error);
                showToast(`Ïò§Î•ò: ${error.message}`, 'error');
                progressTitle.textContent = `‚ùå Ïò§Î•ò Î∞úÏÉù: ${error.message}`;
            } finally {
                // Î≤ÑÌäº Î≥µÏõê
                btn.disabled = false;
                btn.textContent = 'üîÑ Ï†ÑÏ≤¥ Ïû¨ÏÉùÏÑ±';
                
                // 3Ï¥à ÌõÑ ÏßÑÌñâ ÏÉÅÌô© UI Ïà®Í∏∞Í∏∞
                setTimeout(() => {
                    progressSection.style.display = 'none';
                }, 5000);
            }
        }

        function downloadSingle(index) {
            const img = generatedImages[index];
            if (!img || img.error) return;
            
            const section = generatedSections[index];
            const link = document.createElement('a');
            link.href = img.data;
            link.download = `section-${section.number}-${section.name.replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, '_')}.png`;
            link.click();
        }

        // ===== PLATFORM CONFIGURATIONS =====
        const PLATFORM_CONFIGS = [
            { name: 'Ïä§ÎßàÌä∏Ïä§ÌÜ†Ïñ¥', folder: 'smartstore_860px', width: 860 },
            { name: 'Ïø†Ìå°', folder: 'coupang_780px', width: 780 },
            { name: '11Î≤àÍ∞Ä', folder: '11st_800px', width: 800 },
            { name: 'GÎßàÏºì_Ïò•ÏÖò', folder: 'gmarket_auction_860px', width: 860 }
        ];

        // Ïù¥ÎØ∏ÏßÄ Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï®Ïàò
        function resizeImage(base64, targetWidth) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ratio = targetWidth / img.width;
                    canvas.width = targetWidth;
                    canvas.height = Math.round(img.height * ratio);
                    
                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = base64;
            });
        }

        // Base64Î•º BlobÏúºÎ°ú Î≥ÄÌôò
        function base64ToBlob(base64) {
            const parts = base64.split(',');
            const mime = parts[0].match(/:(.*?);/)[1];
            const bstr = atob(parts[1]);
            const arr = new Uint8Array(bstr.length);
            for (let i = 0; i < bstr.length; i++) {
                arr[i] = bstr.charCodeAt(i);
            }
            return new Blob([arr], { type: mime });
        }

        async function downloadAllImages() {
            const images = Object.entries(generatedImages)
                .filter(([_, img]) => img && !img.error)
                .map(([i, img]) => ({
                    name: `section-${generatedSections[i].number}-${generatedSections[i].name.replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, '_')}.png`,
                    data: img.data
                }));
            
            if (images.length === 0) {
                showToast('Îã§Ïö¥Î°úÎìúÌï† Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            const btn = document.getElementById('downloadAllBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥ ZIP ÏÉùÏÑ± Ï§ë...</span>';

            try {
                // JSZip ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎèôÏ†Å Î°úÎìú
                if (!window.JSZip) {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
                }

                const zip = new JSZip();
                const totalSteps = PLATFORM_CONFIGS.length * images.length;
                let currentStep = 0;

                // ÌîåÎû´ÌèºÎ≥ÑÎ°ú Ìè¥Îçî ÏÉùÏÑ± Î∞è Î¶¨ÏÇ¨Ïù¥Ï¶àÎêú Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä
                for (const platform of PLATFORM_CONFIGS) {
                    const folder = zip.folder(platform.folder);
                    
                    for (const img of images) {
                        currentStep++;
                        btn.innerHTML = `<span>‚è≥ Ï≤òÎ¶¨ Ï§ë... ${Math.round((currentStep / totalSteps) * 100)}%</span>`;
                        
                        const resizedData = await resizeImage(img.data, platform.width);
                        const blob = base64ToBlob(resizedData);
                        folder.file(img.name, blob);
                    }
                }

                btn.innerHTML = '<span>‚è≥ ZIP ÏïïÏ∂ï Ï§ë...</span>';

                // ZIP ÌååÏùº ÏÉùÏÑ± Î∞è Îã§Ïö¥Î°úÎìú
                const content = await zip.generateAsync({ 
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });

                const productName = document.getElementById('productName')?.value || 'product';
                const safeName = productName.replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, '_');
                const timestamp = new Date().toISOString().slice(0, 10);
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `${safeName}_ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ_${timestamp}.zip`;
                link.click();
                URL.revokeObjectURL(link.href);

                showToast(`${images.length}Í∞ú Ïù¥ÎØ∏ÏßÄ √ó ${PLATFORM_CONFIGS.length}Í∞ú ÌîåÎû´Ìèº Îã§Ïö¥Î°úÎìú ÏôÑÎ£å!`, 'success');

            } catch (error) {
                console.error('Download error:', error);
                showToast('Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>‚¨áÔ∏è Ï†ÑÏ≤¥ Îã§Ïö¥Î°úÎìú (ZIP)</span>';
            }
        }

        // Ïä§ÌÅ¨Î¶ΩÌä∏ ÎèôÏ†Å Î°úÎìú Ìï®Ïàò
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // ===== IMAGE ANALYSIS WITH GEMINI VISION =====
        async function analyzeGeneratedImages() {
            // ÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏúºÎ©¥ Îπà Í≤∞Í≥º Î∞òÌôò
            const images = Object.values(generatedImages).filter(img => img && !img.error);
            if (images.length === 0 || (!useBackend && !geminiApiKey)) {
                return { analyzed: false };
            }
            
            try {
                // Ï≤´ 3Í∞ú Ïù¥ÎØ∏ÏßÄÎßå Î∂ÑÏÑù (API ÎπÑÏö© Ï†àÏïΩ)
                const imagesToAnalyze = images.slice(0, 3);
                
                const parts = [
                    { text: `Îã§Ïùå Ïù¥ÎØ∏ÏßÄÎì§ÏùÄ e-Ïª§Î®∏Ïä§ ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÏö© Ïù¥ÎØ∏ÏßÄÏûÖÎãàÎã§. Í∞Å Ïù¥ÎØ∏ÏßÄÎ•º Î∂ÑÏÑùÌïòÏó¨ ÏïÑÎûò Ìï≠Î™©Îì§Ïùò Ï°¥Ïû¨ Ïó¨Î∂ÄÎ•º JSONÏúºÎ°ú ÎãµÌï¥Ï£ºÏÑ∏Ïöî.

Î∂ÑÏÑù Ìï≠Î™©:
- hasProductImage: Ï†úÌíà Ïã§Î¨ºÏù¥ Î≥¥Ïù¥ÎäîÍ∞Ä
- hasPackageImage: Ìå®ÌÇ§ÏßÄ/Ìè¨Ïû•Ïù¥ Î≥¥Ïù¥ÎäîÍ∞Ä
- hasNutritionInfo: ÏòÅÏñëÏ†ïÎ≥¥/ÏπºÎ°úÎ¶¨ ÌëúÏãúÍ∞Ä ÏûàÎäîÍ∞Ä
- hasPriceInfo: Í∞ÄÍ≤© Ï†ïÎ≥¥Í∞Ä ÏûàÎäîÍ∞Ä
- hasCTAButton: Íµ¨Îß§ Î≤ÑÌäºÏù¥ÎÇò CTA ÏöîÏÜåÍ∞Ä ÏûàÎäîÍ∞Ä
- hasReviewContent: Î¶¨Î∑∞/ÌõÑÍ∏∞ ÎÇ¥Ïö©Ïù¥ ÏûàÎäîÍ∞Ä
- hasCertification: Ïù∏Ï¶ùÎßàÌÅ¨(HACCP Îì±)Í∞Ä ÏûàÎäîÍ∞Ä
- hasIngredients: ÏõêÏû¨Î£å/ÏÑ±Î∂Ñ Ï†ïÎ≥¥Í∞Ä ÏûàÎäîÍ∞Ä
- textQuality: ÌÖçÏä§Ìä∏ Í∞ÄÎèÖÏÑ± (good/medium/poor)
- designQuality: Ï†ÑÏ≤¥ ÎîîÏûêÏù∏ ÌíàÏßà (good/medium/poor)

JSON ÌòïÏãùÏúºÎ°úÎßå ÎãµÌï¥Ï£ºÏÑ∏Ïöî:
{"hasProductImage": true, "hasPackageImage": false, ...}` }
                ];
                
                // Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä
                for (const img of imagesToAnalyze) {
                    parts.push({
                        inline_data: {
                            mime_type: 'image/png',
                            data: img.data.split(',')[1]
                        }
                    });
                }
                
                const analysisUrl = useBackend 
                    ? `${BACKEND_URL}/api/gemini`
                    : `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiApiKey}`;
                
                const analysisBody = {
                    contents: [{ parts }],
                    generationConfig: { temperature: 0.1 }
                };
                if (useBackend) analysisBody.model = 'gemini-2.0-flash-exp';
                
                const response = await fetch(
                    analysisUrl,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(analysisBody)
                    }
                );
                
                if (!response.ok) {
                    console.error('Image analysis failed');
                    return { analyzed: false };
                }
                
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                // JSON ÌååÏã±
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const result = JSON.parse(jsonMatch[0]);
                    return { analyzed: true, ...result };
                }
                
                return { analyzed: false };
                
            } catch (error) {
                console.error('Image analysis error:', error);
                return { analyzed: false };
            }
        }
        
        // ===== CHECKLIST ANALYSIS =====
        const CATEGORY_CHECKLISTS = {
            snack: {
                name: 'Ïä§ÎÇµ/Í≥ºÏûê/Ï†úÍ≥º',
                icon: 'üç™',
                items: [
                    { id: 'nutrition', label: 'ÏòÅÏñëÏ†ïÎ≥¥ ÌëúÍ∏∞', detail: 'ÏπºÎ°úÎ¶¨, Îã®Î∞±Ïßà, ÌÉÑÏàòÌôîÎ¨º Îì±' },
                    { id: 'ingredients', label: 'ÏõêÏû¨Î£å Î™ÖÏãú', detail: 'Ï£ºÏöî ÏõêÏû¨Î£å Î∞è ÏïåÎ†àÎ•¥Í∏∞ Ï†ïÎ≥¥' },
                    { id: 'taste', label: 'Îßõ ÌëúÌòÑ', detail: 'ÎßõÏùÑ ÎäêÎÇÑ Ïàò ÏûàÎäî Í∞êÍ∞ÅÏ†Å ÌëúÌòÑ' },
                    { id: 'texture', label: 'ÏãùÍ∞ê ÌëúÌòÑ', detail: 'Î∞îÏÇ≠, Ï´ÄÎìù Îì± ÏãùÍ∞ê Î¨òÏÇ¨' },
                    { id: 'certification', label: 'HACCP/Ïù∏Ï¶ùÎßàÌÅ¨', detail: 'ÏãùÌíàÏïàÏ†Ñ Ïù∏Ï¶ù ÌëúÍ∏∞' }
                ]
            },
            beverage: {
                name: 'ÏùåÎ£å/Ï£ºÎ•ò',
                icon: 'ü•§',
                items: [
                    { id: 'volume', label: 'Ïö©Îüâ ÌëúÍ∏∞', detail: 'ml, L Îì± Ï†ïÌôïÌïú Ïö©Îüâ' },
                    { id: 'nutrition', label: 'ÏòÅÏñëÏ†ïÎ≥¥', detail: 'ÏπºÎ°úÎ¶¨, ÎãπÎ•ò Îì±' },
                    { id: 'storage', label: 'Î≥¥Í¥ÄÎ∞©Î≤ï', detail: 'ÎÉâÏû•/ÏÉÅÏò® Î≥¥Í¥Ä ÏïàÎÇ¥' },
                    { id: 'taste', label: 'Îßõ ÌëúÌòÑ', detail: 'ÏÉÅÏæåÌï®, Îã¨ÏΩ§Ìï® Îì±' },
                    { id: 'caffeine', label: 'Ïπ¥ÌéòÏù∏/ÏïåÏΩîÏò¨ Ìï®Îüâ', detail: 'Ìï¥Îãπ Ïãú ÌëúÍ∏∞' }
                ]
            },
            instant: {
                name: 'Ï¶âÏÑùÏãùÌíà/Í∞ÑÌé∏Ïãù',
                icon: 'üç±',
                items: [
                    { id: 'ingredients', label: 'ÏõêÏû¨Î£å/ÏõêÏÇ∞ÏßÄ', detail: 'Ï£ºÏöî ÏõêÏû¨Î£å Î∞è ÏõêÏÇ∞ÏßÄ' },
                    { id: 'nutrition', label: 'ÏòÅÏñëÏ†ïÎ≥¥', detail: 'ÏòÅÏñëÏÑ±Î∂Ñ ÌëúÏãú' },
                    { id: 'expiry', label: 'Ïú†ÌÜµÍ∏∞Ìïú', detail: 'ÏÜåÎπÑÍ∏∞Ìïú/Ïú†ÌÜµÍ∏∞Ìïú ÏïàÎÇ¥' },
                    { id: 'storage', label: 'Î≥¥Í¥ÄÎ∞©Î≤ï', detail: 'ÎÉâÏû•/ÎÉâÎèô/Ïã§Ïò®' },
                    { id: 'cooking', label: 'Ï°∞Î¶¨Î∞©Î≤ï', detail: 'Ï†ÑÏûêÎ†àÏù∏ÏßÄ, ÎÅìÎäîÎ¨º Îì±' }
                ]
            },
            health: {
                name: 'Í±¥Í∞ïÏãùÌíà/Î≥¥Ï∂©Ï†ú',
                icon: 'üíä',
                items: [
                    { id: 'dosage', label: 'ÏÑ≠Ï∑®Î∞©Î≤ï', detail: '1Ïùº ÏÑ≠Ï∑®Îüâ, ÏÑ≠Ï∑® ÏãúÍ∏∞' },
                    { id: 'ingredients', label: 'Í∏∞Îä•ÏÑ± ÏõêÎ£å', detail: 'Ï£ºÏöî ÏÑ±Î∂Ñ Î∞è Ìï®Îüâ' },
                    { id: 'certification', label: 'Ïù∏Ï¶ùÎßàÌÅ¨', detail: 'Í±¥Í∞ïÍ∏∞Îä•ÏãùÌíà Ïù∏Ï¶ù' },
                    { id: 'caution', label: 'Ï£ºÏùòÏÇ¨Ìï≠', detail: 'ÏÑ≠Ï∑® Ïãú Ï£ºÏùòÌï† Ï†ê' },
                    { id: 'effects', label: 'Í∏∞Îä•ÏÑ± ÌëúÏãú', detail: 'Í∏∞ÎåÄ Ìö®Í≥º ÏÑ§Î™Ö' }
                ]
            },
            beauty: {
                name: 'Î∑∞Ìã∞/ÌôîÏû•Ìíà',
                icon: 'üíÑ',
                items: [
                    { id: 'ingredients', label: 'Ï†ÑÏÑ±Î∂Ñ ÌëúÍ∏∞', detail: 'ÌôîÏû•Ìíà Ï†ÑÏÑ±Î∂Ñ' },
                    { id: 'usage', label: 'ÏÇ¨Ïö©Î≤ï ÏïàÎÇ¥', detail: 'ÏÇ¨Ïö© ÏàúÏÑú Î∞è Î∞©Î≤ï' },
                    { id: 'skintype', label: 'ÌîºÎ∂ÄÌÉÄÏûÖ Î™ÖÏãú', detail: 'Ï†ÅÌï©Ìïú ÌîºÎ∂ÄÌÉÄÏûÖ' },
                    { id: 'volume', label: 'Ïö©Îüâ/Ï§ëÎüâ', detail: 'ml, g Îì± Ï†ïÌôïÌïú ÌëúÍ∏∞' },
                    { id: 'certification', label: 'ÏãùÏïΩÏ≤ò Ïù∏Ï¶ù', detail: 'ÌôîÏû•Ìíà ÏïàÏ†Ñ Í∏∞Ï§Ä' }
                ]
            },
            living: {
                name: 'ÏÉùÌôúÏö©Ìíà',
                icon: 'üß¥',
                items: [
                    { id: 'spec', label: 'Ï†úÌíà Í∑úÍ≤©', detail: 'ÏÇ¨Ïù¥Ï¶à, Ïö©Îüâ Îì±' },
                    { id: 'material', label: 'ÏÜåÏû¨/ÏÑ±Î∂Ñ', detail: 'Ï£ºÏöî Ïû¨Ïßà Î∞è ÏÑ±Î∂Ñ' },
                    { id: 'usage', label: 'ÏÇ¨Ïö©Î∞©Î≤ï', detail: 'Ïò¨Î∞îÎ•∏ ÏÇ¨Ïö©Î≤ï' },
                    { id: 'caution', label: 'Ï£ºÏùòÏÇ¨Ìï≠', detail: 'ÏïàÏ†Ñ Ï£ºÏùòÏÇ¨Ìï≠' },
                    { id: 'certification', label: 'KCÏù∏Ï¶ù/ÏïàÏ†ÑÏù∏Ï¶ù', detail: 'ÏïàÏ†Ñ Ïù∏Ï¶ù ÌëúÍ∏∞' }
                ]
            },
            other: {
                name: 'Í∏∞ÌÉÄ',
                icon: 'üì¶',
                items: [
                    { id: 'spec', label: 'Ï†úÌíà Í∑úÍ≤©', detail: 'ÏÇ¨Ïù¥Ï¶à, Î¨¥Í≤å Îì±' },
                    { id: 'material', label: 'ÏÜåÏû¨/Ïû¨Ïßà', detail: 'Ï†úÌíà ÏÜåÏû¨ Ï†ïÎ≥¥' },
                    { id: 'usage', label: 'ÏÇ¨Ïö©Î∞©Î≤ï', detail: 'ÏÇ¨Ïö©Î≤ï ÏïàÎÇ¥' },
                    { id: 'caution', label: 'Ï£ºÏùòÏÇ¨Ìï≠', detail: 'ÏÇ¨Ïö© Ïãú Ï£ºÏùòÏ†ê' },
                    { id: 'warranty', label: 'A/S ÏïàÎÇ¥', detail: 'Î≥¥Ï¶ù Î∞è ÏÑúÎπÑÏä§' }
                ]
            }
        };
        
        const COMMON_CHECKLIST = {
            copy: {
                name: 'Ïπ¥ÌîºÎùºÏù¥ÌåÖ',
                icon: 'üìù',
                items: [
                    { id: 'headline_length', label: 'Ìó§ÎìúÎùºÏù∏ Ï†ÅÏ†ï Í∏∏Ïù¥', detail: '15Ïûê Ïù¥ÎÇ¥ Í∂åÏû•', check: (data) => data.headlineAvgLength <= 15 },
                    { id: 'headline_impact', label: 'Ìó§ÎìúÎùºÏù∏ ÏûÑÌå©Ìä∏', detail: 'Í¥ÄÏã¨ÏùÑ ÎÅÑÎäî Î¨∏Íµ¨', check: (data) => data.hasImpactWords },
                    { id: 'cta_exists', label: 'CTA Î¨∏Íµ¨ Ï°¥Ïû¨', detail: 'Íµ¨Îß§ Ïú†ÎèÑ Î¨∏Íµ¨', check: (data) => data.hasCTA },
                    { id: 'product_name', label: 'Ï†úÌíàÎ™Ö Î™ÖÌôï', detail: 'Ï†úÌíàÎ™ÖÏù¥ Ïûò ÎìúÎü¨ÎÇ®', check: (data) => data.productNameClear }
                ]
            },
            visual: {
                name: 'ÎπÑÏ£ºÏñº',
                icon: 'üñºÔ∏è',
                items: [
                    { id: 'product_image', label: 'Ï†úÌíà Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï®', detail: 'Ïã§Ï†ú Ï†úÌíà ÏÇ¨ÏßÑ', check: (data) => data.hasProductImage },
                    { id: 'section_count', label: 'Ï∂©Î∂ÑÌïú ÏÑπÏÖò Ïàò', detail: '6Í∞ú Ïù¥ÏÉÅ Í∂åÏû•', check: (data) => data.sectionCount >= 6 },
                    { id: 'package_image', label: 'Ìå®ÌÇ§ÏßÄ Ïù¥ÎØ∏ÏßÄ', detail: 'Ìè¨Ïû• ÎîîÏûêÏù∏ ÎÖ∏Ï∂ú', check: (data) => data.hasPackageImage }
                ]
            },
            trust: {
                name: 'Ïã†Î¢∞ ÏöîÏÜå',
                icon: 'üõ°Ô∏è',
                items: [
                    { id: 'review_section', label: 'Î¶¨Î∑∞/ÌõÑÍ∏∞ ÏÑπÏÖò', detail: 'Í≥†Í∞ù ÌõÑÍ∏∞ ÏòÅÏó≠', check: (data) => data.hasReviewSection },
                    { id: 'price_info', label: 'Í∞ÄÍ≤© Ï†ïÎ≥¥', detail: 'Í∞ÄÍ≤© Î™ÖÏãú Ïó¨Î∂Ä', check: (data) => data.hasPriceInfo }
                ]
            }
        };
        
        async function runChecklist() {
            const btn = document.getElementById('runChecklistBtn');
            const resultDiv = document.getElementById('checklistResult');
            
            btn.disabled = true;
            btn.innerHTML = '<span>üîç Î∂ÑÏÑù Ï§ë...</span>';
            
            try {
                // Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
                const analysisData = collectAnalysisData();
                
                // ÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù (Gemini Vision)
                btn.innerHTML = '<span>üîç Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Ï§ë...</span>';
                const imageAnalysis = await analyzeGeneratedImages();
                analysisData.imageAnalysis = imageAnalysis;
                
                // Í≤∞Í≥º ÏÉùÏÑ±
                const result = generateChecklistResult(analysisData, null);
                
                // Í≤∞Í≥º Î†åÎçîÎßÅ
                renderChecklistResult(result);
                resultDiv.style.display = 'block';
                resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                showToast('ÌíàÏßà Ï≤¥ÌÅ¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!', 'success');
                
            } catch (error) {
                console.error('Checklist error:', error);
                showToast('Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>üîç ÌíàÏßà Ï≤¥ÌÅ¨ ÏãúÏûë</span>';
            }
        }
        
        function collectAnalysisData() {
            const productName = document.getElementById('productName')?.value || '';
            const productFeatures = document.getElementById('productFeatures')?.value || '';
            const category = document.getElementById('category')?.value || 'other';
            const priceRange = document.getElementById('priceRange')?.value || '';
            
            // ÏÑπÏÖò Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
            const headlines = generatedSections.map(s => s.headline || '');
            const subcopies = generatedSections.map(s => s.subCopy || '');
            const allText = [...headlines, ...subcopies, productFeatures].join(' ');
            
            // Î∂ÑÏÑù
            const headlineAvgLength = headlines.filter(h => h).reduce((sum, h) => sum + h.length, 0) / (headlines.filter(h => h).length || 1);
            const impactWords = ['ÏµúÍ≥†', 'ÏôÑÎ≤Ω', 'ÎÜÄÎùºÏö¥', 'ÌäπÎ≥Ñ', 'ÌîÑÎ¶¨ÎØ∏ÏóÑ', 'BEST', 'Ïù∏Í∏∞', '1ÏúÑ', 'ÌòÅÏã†', 'ÏÉàÎ°úÏö¥'];
            const hasImpactWords = impactWords.some(w => allText.includes(w));
            const ctaWords = ['ÏßÄÍ∏à', 'Íµ¨Îß§', 'Ï£ºÎ¨∏', 'ÌÅ¥Î¶≠', 'Î∞îÎ°ú', 'Ìï†Ïù∏', 'Î¨¥Î£åÎ∞∞ÏÜ°', 'Ïò§ÎäòÎßå'];
            const hasCTA = ctaWords.some(w => allText.includes(w));
            const productNameClear = headlines.some(h => h.includes(productName.split(' ')[0]));
            
            // Î¶¨Î∑∞/ÌõÑÍ∏∞ ÏÑπÏÖò Ï≤¥ÌÅ¨
            const hasReviewSection = generatedSections.some(s => 
                (s.name || '').includes('ÌõÑÍ∏∞') || (s.name || '').includes('Î¶¨Î∑∞') || 
                (s.headline || '').includes('ÌõÑÍ∏∞') || (s.headline || '').includes('Î¶¨Î∑∞')
            );
            
            // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Ï≤¥ÌÅ¨
            const categoryKeywords = {
                snack: { nutrition: ['ÏπºÎ°úÎ¶¨', 'kcal', 'Îã®Î∞±Ïßà', 'ÌÉÑÏàòÌôîÎ¨º'], taste: ['Îßõ', 'Îã¨ÏΩ§', 'Ïß≠Ïß§', 'Í≥†ÏÜå'], texture: ['Î∞îÏÇ≠', 'Ï´ÄÎìù', 'Î∂ÄÎìúÎü¨Ïö¥', 'ÌÅ¨Îü∞Ïπò'], certification: ['HACCP', 'Ïù∏Ï¶ù', 'ISO'] },
                beverage: { nutrition: ['ÏπºÎ°úÎ¶¨', 'ÎãπÎ•ò'], storage: ['ÎÉâÏû•', 'Î≥¥Í¥Ä'], caffeine: ['Ïπ¥ÌéòÏù∏', 'mg'] },
                health: { dosage: ['1Ïùº', 'ÏÑ≠Ï∑®', 'Î≥µÏö©'], certification: ['Í±¥Í∞ïÍ∏∞Îä•ÏãùÌíà', 'ÏãùÏïΩÏ≤ò'], caution: ['Ï£ºÏùò', 'ÏûÑÏÇ∞Î∂Ä'] },
                beauty: { usage: ['ÏÇ¨Ïö©Î≤ï', 'Î∞îÎ•¥', 'ÎèÑÌè¨'], skintype: ['ÏßÄÏÑ±', 'Í±¥ÏÑ±', 'Î≥µÌï©ÏÑ±', 'ÎØºÍ∞êÏÑ±'], certification: ['ÏãùÏïΩÏ≤ò'] },
                food: { expiry: ['Ïú†ÌÜµÍ∏∞Ìïú', 'ÏÜåÎπÑÍ∏∞Ìïú'], storage: ['ÎÉâÏû•', 'ÎÉâÎèô', 'Ïã§Ïò®'], cooking: ['Ï°∞Î¶¨', 'Îç∞Ïõå', 'ÎÅìÏó¨'] }
            };
            
            const categoryChecks = {};
            if (categoryKeywords[category]) {
                for (const [key, keywords] of Object.entries(categoryKeywords[category])) {
                    categoryChecks[key] = keywords.some(k => allText.includes(k));
                }
            }
            
            return {
                category,
                productName,
                sectionCount: generatedSections.length,
                headlineAvgLength: Math.round(headlineAvgLength),
                hasImpactWords,
                hasCTA,
                productNameClear,
                hasProductImage: uploadedImages.product.length > 0,
                hasPackageImage: uploadedImages.package.length > 0,
                hasReviewSection,
                hasPriceInfo: !!priceRange,
                categoryChecks,
                allText
            };
        }
        
        function generateChecklistResult(data, competitorAnalysis) {
            const results = { categories: [], totalScore: 0, maxScore: 0, suggestions: [], imageAnalyzed: false };
            const imgAnalysis = data.imageAnalysis || {};
            
            // Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä ÏûàÏúºÎ©¥ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
            if (imgAnalysis.analyzed) {
                results.imageAnalyzed = true;
                // Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Í≤∞Í≥ºÎ°ú Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î≥¥ÏôÑ/ÎçÆÏñ¥Ïì∞Í∏∞
                if (imgAnalysis.hasProductImage !== undefined) data.hasProductImage = data.hasProductImage || imgAnalysis.hasProductImage;
                if (imgAnalysis.hasPackageImage !== undefined) data.hasPackageImage = data.hasPackageImage || imgAnalysis.hasPackageImage;
                if (imgAnalysis.hasCTAButton !== undefined) data.hasCTA = data.hasCTA || imgAnalysis.hasCTAButton;
                if (imgAnalysis.hasReviewContent !== undefined) data.hasReviewSection = data.hasReviewSection || imgAnalysis.hasReviewContent;
                if (imgAnalysis.hasPriceInfo !== undefined) data.hasPriceInfo = data.hasPriceInfo || imgAnalysis.hasPriceInfo;
                
                // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï≤¥ÌÅ¨Ïóê Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Í≤∞Í≥º Î∞òÏòÅ
                if (imgAnalysis.hasNutritionInfo) data.categoryChecks.nutrition = true;
                if (imgAnalysis.hasIngredients) data.categoryChecks.ingredients = true;
                if (imgAnalysis.hasCertification) data.categoryChecks.certification = true;
            }
            
            // Í≥µÌÜµ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
            for (const [key, category] of Object.entries(COMMON_CHECKLIST)) {
                const categoryResult = { ...category, results: [] };
                for (const item of category.items) {
                    const passed = item.check(data);
                    categoryResult.results.push({ ...item, passed });
                    results.maxScore++;
                    if (passed) results.totalScore++;
                    if (!passed) {
                        results.suggestions.push(getSuggestion(item.id, data));
                    }
                }
                results.categories.push(categoryResult);
            }
            
            // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
            const categoryConfig = CATEGORY_CHECKLISTS[data.category] || CATEGORY_CHECKLISTS.other;
            const categoryResult = { name: `${categoryConfig.icon} ${categoryConfig.name} ÌïÑÏàòÏ†ïÎ≥¥`, results: [] };
            for (const item of categoryConfig.items) {
                const passed = data.categoryChecks[item.id] || false;
                categoryResult.results.push({ ...item, passed });
                results.maxScore++;
                if (passed) results.totalScore++;
                if (!passed) {
                    results.suggestions.push(getCategorySuggestion(item.id, item.label, data.category));
                }
            }
            results.categories.push(categoryResult);
            
            // Ïù¥ÎØ∏ÏßÄ ÌíàÏßà Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞Ä (Î∂ÑÏÑùÎêú Í≤ΩÏö∞)
            if (imgAnalysis.analyzed) {
                const imageQualityResult = { name: 'üé® Ïù¥ÎØ∏ÏßÄ ÌíàÏßà (AI Î∂ÑÏÑù)', icon: 'üé®', results: [] };
                
                imageQualityResult.results.push({
                    label: 'ÌÖçÏä§Ìä∏ Í∞ÄÎèÖÏÑ±',
                    detail: imgAnalysis.textQuality === 'good' ? 'Ï¢ãÏùå' : imgAnalysis.textQuality === 'medium' ? 'Î≥¥ÌÜµ' : 'Í∞úÏÑ† ÌïÑÏöî',
                    passed: imgAnalysis.textQuality === 'good' || imgAnalysis.textQuality === 'medium'
                });
                
                imageQualityResult.results.push({
                    label: 'ÎîîÏûêÏù∏ ÌíàÏßà',
                    detail: imgAnalysis.designQuality === 'good' ? 'Ï¢ãÏùå' : imgAnalysis.designQuality === 'medium' ? 'Î≥¥ÌÜµ' : 'Í∞úÏÑ† ÌïÑÏöî',
                    passed: imgAnalysis.designQuality === 'good' || imgAnalysis.designQuality === 'medium'
                });
                
                for (const item of imageQualityResult.results) {
                    results.maxScore++;
                    if (item.passed) results.totalScore++;
                }
                
                results.categories.push(imageQualityResult);
            }
            
            return results;
        }
        
        function getSuggestion(itemId, data) {
            const suggestions = {
                headline_length: `Ìó§ÎìúÎùºÏù∏Ïù¥ ÌèâÍ∑† ${data.headlineAvgLength}ÏûêÏûÖÎãàÎã§. 15Ïûê Ïù¥ÎÇ¥Î°ú Ï§ÑÏó¨ ÏûÑÌå©Ìä∏Î•º ÎÜíÏó¨Î≥¥ÏÑ∏Ïöî.`,
                headline_impact: 'Ìó§ÎìúÎùºÏù∏Ïóê "ÏµúÍ≥†", "ÌäπÎ≥Ñ", "ÌîÑÎ¶¨ÎØ∏ÏóÑ" Îì± ÏûÑÌå©Ìä∏ ÏûàÎäî Îã®Ïñ¥Î•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî.',
                cta_exists: '"ÏßÄÍ∏à Íµ¨Îß§ÌïòÍ∏∞", "Ïò§ÎäòÎßå Ìï†Ïù∏" Îì± Íµ¨Îß§Î•º Ïú†ÎèÑÌïòÎäî CTA Î¨∏Íµ¨Î•º Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.',
                product_name: 'Ìó§ÎìúÎùºÏù∏Ïóê Ï†úÌíàÎ™ÖÏùÑ Ìè¨Ìï®ÏãúÏºú Î∏åÎûúÎìú Ïù∏ÏßÄÎèÑÎ•º ÎÜíÏù¥ÏÑ∏Ïöî.',
                product_image: 'Ï†úÌíà Ïã§Î¨º Ïù¥ÎØ∏ÏßÄÎ•º Ï∂îÍ∞ÄÌïòÎ©¥ Ïã†Î¢∞ÎèÑÍ∞Ä ÎÜíÏïÑÏßëÎãàÎã§.',
                section_count: 'ÏÑπÏÖòÏùÑ 6Í∞ú Ïù¥ÏÉÅÏúºÎ°ú ÎäòÎ†§ Îçî ÌíçÎ∂ÄÌïú Ï†ïÎ≥¥Î•º Ï†úÍ≥µÌïòÏÑ∏Ïöî.',
                package_image: 'Ìå®ÌÇ§ÏßÄ Ïù¥ÎØ∏ÏßÄÎ•º Ï∂îÍ∞ÄÌïòÎ©¥ Ïã§Ï†ú Î∞∞ÏÜ° Ïãú Î™®ÏäµÏùÑ Î≥¥Ïó¨Ï§Ñ Ïàò ÏûàÏäµÎãàÎã§.',
                review_section: 'Í≥†Í∞ù ÌõÑÍ∏∞ ÏÑπÏÖòÏùÑ Ï∂îÍ∞ÄÌïòÏó¨ Íµ¨Îß§ Ï†ÑÌôòÏú®ÏùÑ ÎÜíÏù¥ÏÑ∏Ïöî.',
                price_info: 'Í∞ÄÍ≤© Ï†ïÎ≥¥Î•º Î™ÖÏãúÌïòÎ©¥ Í≥†Í∞ùÏùò ÏùòÏÇ¨Í≤∞Ï†ïÏóê ÎèÑÏõÄÏù¥ Îê©ÎãàÎã§.'
            };
            return suggestions[itemId] || `${itemId} Ìï≠Î™©ÏùÑ Í∞úÏÑ†Ìï¥Î≥¥ÏÑ∏Ïöî.`;
        }
        
        function getCategorySuggestion(itemId, label, category) {
            return `[${CATEGORY_CHECKLISTS[category]?.name || 'Ïπ¥ÌÖåÍ≥†Î¶¨'}] ${label} Ï†ïÎ≥¥Î•º ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÏóê Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.`;
        }
        
        function renderChecklistResult(result) {
            const scorePercent = Math.round((result.totalScore / result.maxScore) * 100);
            const scoreClass = scorePercent >= 70 ? 'good' : scorePercent >= 50 ? 'medium' : 'bad';
            
            const analysisType = result.imageAnalyzed 
                ? '<span style="color: var(--accent-success); font-size: 0.75rem; margin-left: 8px;">‚ú® AI Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Ìè¨Ìï®</span>'
                : '<span style="color: var(--text-tertiary); font-size: 0.75rem; margin-left: 8px;">üìù ÌÖçÏä§Ìä∏ Í∏∞Î∞ò Î∂ÑÏÑù</span>';
            
            let html = `
                <div class="result-header">
                    <span class="result-title">üìä Î∂ÑÏÑù Í≤∞Í≥º ${analysisType}</span>
                    <div class="result-score">
                        <div class="result-score-bar">
                            <div class="result-score-fill ${scoreClass}" style="width: ${scorePercent}%"></div>
                        </div>
                        <span class="result-score-text">${result.totalScore}/${result.maxScore}</span>
                    </div>
                </div>
            `;
            
            for (const category of result.categories) {
                const catPassed = category.results.filter(r => r.passed).length;
                html += `
                    <div class="result-category">
                        <div class="result-category-header">
                            <span class="result-category-icon">${category.icon || 'üìã'}</span>
                            <span class="result-category-title">${category.name}</span>
                            <span class="result-category-score">${catPassed}/${category.results.length}</span>
                        </div>
                `;
                
                for (const item of category.results) {
                    const status = item.passed ? '‚úÖ' : '‚ùå';
                    html += `
                        <div class="result-item">
                            <span class="result-item-status">${status}</span>
                            <div class="result-item-content">
                                <div class="result-item-label">${item.label}</div>
                                <div class="result-item-detail">${item.detail}</div>
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
            }
            
            if (result.suggestions.length > 0) {
                html += `
                    <div class="result-suggestions">
                        <div class="result-suggestions-title">üí° Í∞úÏÑ† Ï†úÏïà</div>
                        ${result.suggestions.slice(0, 5).map(s => `
                            <div class="result-suggestion-item">${s}</div>
                        `).join('')}
                    </div>
                `;
            }
            
            document.getElementById('checklistResult').innerHTML = html;
        }

        // ===== UTILITIES =====
        function addLog(container, message, type) {
            const item = document.createElement('div');
            item.className = `log-item log-${type}`;
            item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(item);
            container.scrollTop = container.scrollHeight;
        }

        async function animateProgress(step, target) {
            const fill = document.getElementById(`${step}ProgressFill`);
            const percent = document.getElementById(`${step}ProgressPercent`);
            fill.style.width = target + '%';
            percent.textContent = target + '%';
            await sleep(300);
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Í∏∞ÌöçÏÑú ÏàòÏ†ï ÏóêÎîîÌÑ∞
        function openPlanEditor() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'planEditorModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
                    <div class="modal-header">
                        <h3 class="modal-title">‚úèÔ∏è Í∏∞ÌöçÏÑú ÏàòÏ†ï</h3>
                        <button class="modal-close" onclick="closePlanEditor()">√ó</button>
                    </div>
                    <div class="modal-body" style="flex: 1; overflow: hidden; padding: 0;">
                        <textarea id="planEditorText" style="width: 100%; height: 100%; min-height: 400px; padding: 20px; background: var(--bg-tertiary); border: none; color: var(--text-primary); font-family: var(--font-mono); font-size: 0.85rem; resize: none; outline: none;">${escapeHtml(generatedPlan)}</textarea>
                    </div>
                    <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--border-subtle); display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closePlanEditor()">Ï∑®ÏÜå</button>
                        <button class="btn btn-primary" onclick="savePlanEdit()">üíæ Ï†ÄÏû•</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closePlanEditor() {
            const modal = document.getElementById('planEditorModal');
            if (modal) modal.remove();
        }
        
        function savePlanEdit() {
            const newPlan = document.getElementById('planEditorText').value;
            generatedPlan = newPlan;
            
            // Îã§Ïãú ÌååÏã±ÌïòÏó¨ ÏÑπÏÖò ÏóÖÎç∞Ïù¥Ìä∏
            generatedSections = parseSections(newPlan);
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            displayPlan(newPlan);
            renderSectionsEditor();
            
            closePlanEditor();
            showToast('Í∏∞ÌöçÏÑúÍ∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!', 'success');
        }

        function showToast(message, type) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${type === 'success' ? '‚úì' : '‚úï'}</span>
                <span class="toast-message">${message}</span>
            `;
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ===== START =====
        init();
    </script>
</body>
</html>
